"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AmplifyAuth = void 0;
const constructs_1 = require("constructs");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_cognito_1 = require("aws-cdk-lib/aws-cognito");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const backend_output_schemas_1 = require("@aws-amplify/backend-output-schemas");
const defaults_js_1 = require("./defaults.js");
const backend_output_storage_1 = require("@aws-amplify/backend-output-storage");
const path = __importStar(require("path"));
const string_maps_js_1 = require("./string_maps.js");
const authProvidersList = {
    facebook: 'graph.facebook.com',
    google: 'accounts.google.com',
    amazon: 'www.amazon.com',
    apple: 'appleid.apple.com',
};
const INVITATION_PLACEHOLDERS = {
    CODE: '{####}',
    USERNAME: '{username}',
};
const VERIFICATION_EMAIL_PLACEHOLDERS = {
    CODE: '{####}',
    LINK: '{##Verify Email##}',
};
const VERIFICATION_SMS_PLACEHOLDERS = {
    CODE: '{####}',
};
const MFA_SMS_PLACEHOLDERS = {
    CODE: '{####}',
};
const DEFAULT_OAUTH_SCOPES = [
    aws_cognito_1.OAuthScope.PHONE,
    aws_cognito_1.OAuthScope.EMAIL,
    aws_cognito_1.OAuthScope.OPENID,
    aws_cognito_1.OAuthScope.PROFILE,
    aws_cognito_1.OAuthScope.COGNITO_ADMIN,
];
// Be very careful editing this value. It is the string that is used to attribute stacks to Amplify Auth in BI metrics
const authStackType = 'auth-Cognito';
/**
 * Amplify Auth CDK Construct
 */
class AmplifyAuth extends constructs_1.Construct {
    /**
     * Create a new Auth construct with AuthProps.
     * If no props are provided, email login and defaults will be used.
     */
    constructor(scope, id, props = defaults_js_1.DEFAULTS.IF_NO_PROPS_PROVIDED) {
        var _a, _b;
        super(scope, id);
        this.groups = {};
        /**
         * Create Auth/UnAuth Roles
         * @returns DefaultRoles
         */
        this.setupAuthAndUnAuthRoles = (identityPoolId) => {
            const result = {
                auth: new aws_iam_1.Role(this, `${this.name}authenticatedUserRole`, {
                    assumedBy: new aws_iam_1.FederatedPrincipal('cognito-identity.amazonaws.com', {
                        StringEquals: {
                            'cognito-identity.amazonaws.com:aud': identityPoolId,
                        },
                        'ForAnyValue:StringLike': {
                            'cognito-identity.amazonaws.com:amr': 'authenticated',
                        },
                    }, 'sts:AssumeRoleWithWebIdentity'),
                }),
                unAuth: new aws_iam_1.Role(this, `${this.name}unauthenticatedUserRole`, {
                    assumedBy: new aws_iam_1.FederatedPrincipal('cognito-identity.amazonaws.com', {
                        StringEquals: {
                            'cognito-identity.amazonaws.com:aud': identityPoolId,
                        },
                        'ForAnyValue:StringLike': {
                            'cognito-identity.amazonaws.com:amr': 'unauthenticated',
                        },
                    }, 'sts:AssumeRoleWithWebIdentity'),
                }),
            };
            return result;
        };
        /**
         * Auto generate the user pool groups and group roles
         */
        this.setupUserPoolGroups = (groups, identityPool) => {
            (groups || []).forEach((groupName, index) => {
                const groupRole = new aws_iam_1.Role(this, `${this.name}${groupName}GroupRole`, {
                    assumedBy: new aws_iam_1.FederatedPrincipal('cognito-identity.amazonaws.com', {
                        StringEquals: {
                            'cognito-identity.amazonaws.com:aud': identityPool.ref,
                        },
                        'ForAnyValue:StringLike': {
                            'cognito-identity.amazonaws.com:amr': 'authenticated',
                        },
                    }, 'sts:AssumeRoleWithWebIdentity'),
                });
                const currentGroup = new aws_cognito_1.CfnUserPoolGroup(this, `${this.name}${groupName}Group`, {
                    userPoolId: this.userPool.userPoolId,
                    groupName: groupName,
                    roleArn: groupRole.roleArn,
                    precedence: index,
                });
                this.groups[groupName] = {
                    cfnUserGroup: currentGroup,
                    role: groupRole,
                };
            });
        };
        /**
         * Setup Identity Pool with default roles/role mappings, and register providers
         */
        this.setupIdentityPool = (userPool, userPoolClient, providerSetupResult) => {
            // setup identity pool
            const region = aws_cdk_lib_1.Stack.of(this).region;
            const identityPool = new aws_cdk_lib_1.aws_cognito.CfnIdentityPool(this, `${this.name}IdentityPool`, {
                allowUnauthenticatedIdentities: defaults_js_1.DEFAULTS.ALLOW_UNAUTHENTICATED_IDENTITIES,
            });
            const roles = this.setupAuthAndUnAuthRoles(identityPool.ref);
            const identityPoolRoleAttachment = new aws_cdk_lib_1.aws_cognito.CfnIdentityPoolRoleAttachment(this, `${this.name}IdentityPoolRoleAttachment`, {
                identityPoolId: identityPool.ref,
                roles: {
                    unauthenticated: roles.unAuth.roleArn,
                    authenticated: roles.auth.roleArn,
                },
                roleMappings: {
                    UserPoolWebClientRoleMapping: {
                        type: 'Token',
                        ambiguousRoleResolution: 'AuthenticatedRole',
                        identityProvider: `cognito-idp.${region}.amazonaws.com/${userPool.userPoolId}:${userPoolClient.userPoolClientId}`,
                    },
                },
            });
            identityPoolRoleAttachment.addDependency(identityPool);
            identityPoolRoleAttachment.node.addDependency(userPoolClient);
            // add cognito provider
            identityPool.cognitoIdentityProviders = [
                {
                    clientId: userPoolClient.userPoolClientId,
                    providerName: `cognito-idp.${region}.amazonaws.com/${userPool.userPoolId}`,
                },
            ];
            // add other providers
            identityPool.supportedLoginProviders = providerSetupResult.oAuthMappings;
            return {
                identityPool,
                identityPoolRoleAttachment,
                roles,
            };
        };
        /**
         * Process props into UserPoolProps (set defaults if needed)
         */
        this.getUserPoolProps = (props) => {
            var _a;
            const emailEnabled = props.loginWith.email ? true : false;
            const phoneEnabled = props.loginWith.phone ? true : false;
            const oneOfEmailOrPhone = emailEnabled || phoneEnabled;
            if (!oneOfEmailOrPhone) {
                throw Error('At least one of email or phone must be enabled.');
            }
            let userVerificationSettings = {};
            // extract email settings if settings object is defined
            if (typeof props.loginWith.email === 'object') {
                const emailSettings = props.loginWith.email;
                // verify email body and inject the actual template values which cognito uses
                const emailBody = this.verifyEmailBody(emailSettings);
                userVerificationSettings = {
                    emailBody: emailBody,
                    emailStyle: this.getEmailVerificationStyle(emailSettings.verificationEmailStyle),
                    emailSubject: emailSettings.verificationEmailSubject,
                };
            }
            // extract phone settings if settings object is defined
            if (typeof props.loginWith.phone === 'object') {
                const phoneSettings = props.loginWith.phone;
                let smsMessage;
                if (phoneSettings.verificationMessage &&
                    typeof phoneSettings.verificationMessage === 'function') {
                    // validate sms message structure
                    smsMessage = phoneSettings.verificationMessage(() => VERIFICATION_SMS_PLACEHOLDERS.CODE);
                    if (!smsMessage.includes(VERIFICATION_SMS_PLACEHOLDERS.CODE)) {
                        throw Error("Invalid phone settings. Property 'verificationMessage' must utilize the 'code' parameter at least once as a placeholder for the verification code.");
                    }
                }
                userVerificationSettings = {
                    ...userVerificationSettings,
                    smsMessage: smsMessage,
                };
            }
            const userPoolProps = {
                signInCaseSensitive: defaults_js_1.DEFAULTS.SIGN_IN_CASE_SENSITIVE,
                signInAliases: {
                    phone: phoneEnabled,
                    email: emailEnabled,
                },
                keepOriginal: {
                    email: emailEnabled,
                    phone: phoneEnabled,
                },
                autoVerify: {
                    email: emailEnabled,
                    phone: phoneEnabled,
                },
                userVerification: userVerificationSettings,
                passwordPolicy: defaults_js_1.DEFAULTS.PASSWORD_POLICY,
                standardAttributes: {
                    email: defaults_js_1.DEFAULTS.IS_REQUIRED_ATTRIBUTE.email(emailEnabled),
                    phoneNumber: defaults_js_1.DEFAULTS.IS_REQUIRED_ATTRIBUTE.phoneNumber(phoneEnabled),
                    ...(props.userAttributes ? props.userAttributes : {}),
                },
                selfSignUpEnabled: defaults_js_1.DEFAULTS.ALLOW_SELF_SIGN_UP,
                mfa: this.getMFAMode(props.multifactor),
                mfaMessage: this.getMFAMessage(props.multifactor),
                mfaSecondFactor: typeof props.multifactor === 'object' &&
                    props.multifactor.mode !== 'OFF'
                    ? {
                        sms: props.multifactor.sms ? true : false,
                        otp: props.multifactor.totp ? true : false,
                    }
                    : undefined,
                accountRecovery: this.getAccountRecoverySetting(emailEnabled, phoneEnabled, props.accountRecovery),
                removalPolicy: aws_cdk_lib_1.RemovalPolicy.DESTROY,
                userInvitation: typeof props.loginWith.email !== 'boolean'
                    ? this.getUserInvitationSettings((_a = props.loginWith.email) === null || _a === void 0 ? void 0 : _a.userInvitation)
                    : undefined,
            };
            return userPoolProps;
        };
        /**
         * Get email verification style from user props
         * @param verificationEmailStyle - string value
         * @returns verificationEmailStyle - enum value
         */
        this.getEmailVerificationStyle = (verificationEmailStyle) => {
            if (verificationEmailStyle === 'CODE') {
                return aws_cdk_lib_1.aws_cognito.VerificationEmailStyle.CODE;
            }
            else if (verificationEmailStyle === 'LINK') {
                return aws_cdk_lib_1.aws_cognito.VerificationEmailStyle.LINK;
            }
            return undefined;
        };
        /**
         * Determine the account recovery option based on enabled login methods.
         * @param emailEnabled - is email enabled
         * @param phoneEnabled - is phone enabled
         * @param accountRecoveryMethodAsString - the user provided account recovery setting
         * @returns account recovery setting enum value
         */
        this.getAccountRecoverySetting = (emailEnabled, phoneEnabled, accountRecoveryMethodAsString) => {
            const accountRecovery = this.convertAccountRecoveryStringToEnum(accountRecoveryMethodAsString);
            if (accountRecovery !== undefined) {
                return accountRecovery;
            }
            // set default based on enabled login methods
            if (phoneEnabled && emailEnabled) {
                return aws_cdk_lib_1.aws_cognito.AccountRecovery.EMAIL_ONLY;
            }
            if (phoneEnabled) {
                return aws_cdk_lib_1.aws_cognito.AccountRecovery.PHONE_ONLY_WITHOUT_MFA;
            }
            if (emailEnabled) {
                return aws_cdk_lib_1.aws_cognito.AccountRecovery.EMAIL_ONLY;
            }
            return undefined;
        };
        /**
         * Convert user friendly Mfa mode to cognito Mfa type.
         * This eliminates the need for users to import cognito.Mfa.
         * @param mfa - MFA settings
         * @returns cognito MFA enforcement type
         */
        this.getMFAMode = (mfa) => {
            if (mfa) {
                switch (mfa.mode) {
                    case 'OFF':
                        return aws_cognito_1.Mfa.OFF;
                    case 'OPTIONAL':
                        return aws_cognito_1.Mfa.OPTIONAL;
                    case 'REQUIRED':
                        return aws_cognito_1.Mfa.REQUIRED;
                }
            }
            return undefined;
        };
        /**
         * Convert user friendly account recovery method to cognito AccountRecover enum.
         * This eliminates the need for users to import cognito.AccountRecovery.
         * @param method - account recovery method as a string value
         * @returns cognito.AccountRecovery enum value
         */
        this.convertAccountRecoveryStringToEnum = (method) => {
            if (method !== undefined) {
                return aws_cdk_lib_1.aws_cognito.AccountRecovery[method];
            }
            return undefined;
        };
        /**
         * Extract the MFA message settings and perform validation.
         * @param mfa - MFA settings
         * @returns mfa message
         */
        this.getMFAMessage = (mfa) => {
            if (mfa && mfa.mode !== 'OFF' && typeof mfa.sms === 'object') {
                const message = mfa.sms.smsMessage(() => MFA_SMS_PLACEHOLDERS.CODE);
                if (!message.includes(MFA_SMS_PLACEHOLDERS.CODE)) {
                    throw Error("Invalid MFA settings. Property 'smsMessage' must utilize the 'code' parameter at least once as a placeholder for the verification code.");
                }
                return message;
            }
            return undefined;
        };
        /**
         * Setup External Providers (OAuth/OIDC/SAML) and related settings
         * such as OAuth settings and User Pool Domains
         */
        this.setupExternalProviders = (userPool, loginOptions) => {
            /**
             * If email is enabled, and is the only required attribute, we are able to
             * automatically map the email attribute from external providers, excluding SAML.
             */
            const shouldMapEmailAttributes = loginOptions.email && !loginOptions.phone;
            const result = {
                oAuthMappings: {},
                providersList: [],
                oAuthSettings: {
                    flows: defaults_js_1.DEFAULTS.OAUTH_FLOWS,
                },
            };
            // external providers
            const external = loginOptions.externalProviders;
            if (!external) {
                return result;
            }
            // make sure logout/callback urls are not empty
            if (external.logoutUrls && external.logoutUrls.length === 0) {
                throw Error('You must define logoutUrls when configuring external login providers.');
            }
            if (external.callbackUrls && external.callbackUrls.length === 0) {
                throw Error('You must define callbackUrls when configuring external login providers.');
            }
            if (external.google) {
                const googleProps = external.google;
                result.google = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderGoogle(this, `${this.name}GoogleIdP`, {
                    userPool,
                    clientId: googleProps.clientId,
                    clientSecretValue: googleProps.clientSecret,
                    attributeMapping: {
                        ...(shouldMapEmailAttributes
                            ? {
                                email: aws_cognito_1.ProviderAttribute.GOOGLE_EMAIL,
                            }
                            : undefined),
                        ...this.convertToCognitoAttributeMapping(googleProps.attributeMapping),
                    },
                    scopes: googleProps.scopes,
                });
                result.oAuthMappings[authProvidersList.google] = external.google.clientId;
                result.providersList.push('GOOGLE');
            }
            if (external.facebook) {
                result.facebook = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderFacebook(this, `${this.name}FacebookIDP`, {
                    userPool,
                    ...external.facebook,
                    attributeMapping: {
                        ...(shouldMapEmailAttributes
                            ? {
                                email: aws_cognito_1.ProviderAttribute.FACEBOOK_EMAIL,
                            }
                            : undefined),
                        ...this.convertToCognitoAttributeMapping(external.facebook.attributeMapping),
                    },
                });
                result.oAuthMappings[authProvidersList.facebook] =
                    external.facebook.clientId;
                result.providersList.push('FACEBOOK');
            }
            if (external.loginWithAmazon) {
                result.amazon = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderAmazon(this, `${this.name}AmazonIDP`, {
                    userPool,
                    ...external.loginWithAmazon,
                    attributeMapping: {
                        ...(shouldMapEmailAttributes
                            ? {
                                email: aws_cognito_1.ProviderAttribute.AMAZON_EMAIL,
                            }
                            : undefined),
                        ...this.convertToCognitoAttributeMapping(external.loginWithAmazon.attributeMapping),
                    },
                });
                result.oAuthMappings[authProvidersList.amazon] =
                    external.loginWithAmazon.clientId;
                result.providersList.push('AMAZON');
            }
            if (external.signInWithApple) {
                result.apple = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderApple(this, `${this.name}AppleIDP`, {
                    userPool,
                    ...external.signInWithApple,
                    attributeMapping: {
                        ...(shouldMapEmailAttributes
                            ? {
                                email: aws_cognito_1.ProviderAttribute.APPLE_EMAIL,
                            }
                            : undefined),
                        ...this.convertToCognitoAttributeMapping(external.signInWithApple.attributeMapping),
                    },
                });
                result.oAuthMappings[authProvidersList.apple] =
                    external.signInWithApple.clientId;
                result.providersList.push('APPLE');
            }
            if (external.oidc && external.oidc.length > 0) {
                result.oidc = [];
                external.oidc.forEach((provider, index) => {
                    var _a, _b;
                    const requestMethod = provider.attributeRequestMethod === undefined
                        ? 'GET' // default if not defined
                        : provider.attributeRequestMethod;
                    const generatedProvider = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderOidc(this, `${this.name}${(_a = provider.name) !== null && _a !== void 0 ? _a : index}OidcIDP`, {
                        userPool,
                        attributeRequestMethod: requestMethod === 'GET'
                            ? aws_cognito_1.OidcAttributeRequestMethod.GET
                            : aws_cognito_1.OidcAttributeRequestMethod.POST,
                        clientId: provider.clientId,
                        clientSecret: provider.clientSecret,
                        endpoints: provider.endpoints,
                        identifiers: provider.identifiers,
                        issuerUrl: provider.issuerUrl,
                        name: provider.name,
                        scopes: provider.scopes,
                        attributeMapping: {
                            ...(shouldMapEmailAttributes
                                ? {
                                    email: {
                                        attributeName: 'email',
                                    },
                                }
                                : undefined),
                            ...this.convertToCognitoAttributeMapping(provider.attributeMapping),
                        },
                    });
                    (_b = result.oidc) === null || _b === void 0 ? void 0 : _b.push(generatedProvider);
                    result.providersList.push(generatedProvider.providerName);
                });
            }
            if (external.saml) {
                const saml = external.saml;
                result.saml = new aws_cdk_lib_1.aws_cognito.UserPoolIdentityProviderSaml(this, `${this.name}SamlIDP`, {
                    userPool,
                    attributeMapping: this.convertToCognitoAttributeMapping(saml.attributeMapping),
                    identifiers: saml.identifiers,
                    idpSignout: saml.idpSignout,
                    metadata: {
                        metadataContent: saml.metadata.metadataContent,
                        metadataType: saml.metadata.metadataType === 'FILE'
                            ? aws_cognito_1.UserPoolIdentityProviderSamlMetadataType.FILE
                            : aws_cognito_1.UserPoolIdentityProviderSamlMetadataType.URL,
                    },
                    name: saml.name,
                });
                result.providersList.push('SAML');
            }
            // Always generate a domain prefix if external provider is configured
            if (this.domainPrefix) {
                this.userPool.addDomain(`${this.name}UserPoolDomain`, {
                    cognitoDomain: { domainPrefix: this.domainPrefix },
                });
            }
            else {
                throw new Error('Cognito Domain Prefix is missing when external providers are configured.');
            }
            // oauth settings for the UserPool client
            result.oAuthSettings = {
                callbackUrls: external.callbackUrls,
                logoutUrls: external.logoutUrls,
                scopes: external.scopes
                    ? this.getOAuthScopes(external.scopes)
                    : DEFAULT_OAUTH_SCOPES,
                flows: defaults_js_1.DEFAULTS.OAUTH_FLOWS,
            };
            return result;
        };
        /**
         * Converts the simplified mapping type to cognito.AttributeMapping.
         * @param mapping the AttributeMapping to convert to a cognito.AttributeMapping
         * @returns cognito.AttributeMapping
         */
        this.convertToCognitoAttributeMapping = (mapping) => {
            if (!mapping) {
                return undefined;
            }
            const result = {};
            for (const [attrName, value] of Object.entries(mapping)) {
                if (typeof value === 'string') {
                    result[attrName] = {
                        attributeName: value,
                    };
                }
                if (typeof value === 'object' && attrName === 'custom') {
                    // dealing with custom attributes
                    const customAttributes = {};
                    for (const [customKey, attrName] of Object.entries(value)) {
                        customAttributes[customKey] = {
                            attributeName: attrName,
                        };
                    }
                    result[attrName] = customAttributes;
                }
            }
            return result;
        };
        /**
         * Convert scopes from string list to OAuthScopes.
         * @param scopes - scope list
         * @returns cognito OAuthScopes
         */
        this.getOAuthScopes = (scopes) => {
            if (scopes === undefined) {
                return [];
            }
            const result = [];
            for (const scope of scopes) {
                result.push(aws_cdk_lib_1.aws_cognito.OAuthScope[scope]);
            }
            return result;
        };
        /**
         * Stores auth output using the provided strategy
         */
        this.storeOutput = (outputStorageStrategy = new backend_output_storage_1.StackMetadataBackendOutputStorageStrategy(aws_cdk_lib_1.Stack.of(this))) => {
            var _a, _b, _c, _d, _e;
            const output = {
                userPoolId: this.resources.userPool.userPoolId,
                webClientId: this.resources.userPoolClient.userPoolClientId,
                identityPoolId: this.resources.cfnResources.cfnIdentityPool.ref,
                authRegion: aws_cdk_lib_1.Stack.of(this).region,
                allowUnauthenticatedIdentities: this.resources.cfnResources.cfnIdentityPool
                    .allowUnauthenticatedIdentities === true
                    ? 'true'
                    : 'false',
            };
            if (this.computedUserPoolProps.standardAttributes) {
                const signupAttributes = Object.entries(this.computedUserPoolProps.standardAttributes).reduce((acc, [attributeName, attribute]) => {
                    if (attribute === null || attribute === void 0 ? void 0 : attribute.required) {
                        const treatedAttributeName = string_maps_js_1.coreAttributeNameMap.find(({ standardAttributeName }) => standardAttributeName === attributeName);
                        if (treatedAttributeName) {
                            return [
                                ...acc,
                                treatedAttributeName.userpoolAttributeName.toLowerCase(),
                            ];
                        }
                    }
                    return acc;
                }, []);
                output.signupAttributes = JSON.stringify(signupAttributes);
            }
            if (this.computedUserPoolProps.signInAliases) {
                const usernameAttributes = [];
                if (this.computedUserPoolProps.signInAliases.email) {
                    usernameAttributes.push('email');
                }
                if (this.computedUserPoolProps.signInAliases.phone) {
                    usernameAttributes.push('phone_number');
                }
                if (this.computedUserPoolProps.signInAliases.preferredUsername ||
                    this.computedUserPoolProps.signInAliases.username) {
                    usernameAttributes.push('preferred_username');
                }
                if (usernameAttributes.length > 0) {
                    output.usernameAttributes = JSON.stringify(usernameAttributes);
                }
            }
            if (this.computedUserPoolProps.autoVerify) {
                const verificationMechanisms = [];
                if (this.computedUserPoolProps.autoVerify.email) {
                    verificationMechanisms.push('email');
                }
                if (this.computedUserPoolProps.autoVerify.phone) {
                    verificationMechanisms.push('phone_number');
                }
                if (verificationMechanisms.length > 0) {
                    output.verificationMechanisms = JSON.stringify(verificationMechanisms);
                }
            }
            if (this.computedUserPoolProps.passwordPolicy) {
                output.passwordPolicyMinLength =
                    (_a = this.computedUserPoolProps.passwordPolicy.minLength) === null || _a === void 0 ? void 0 : _a.toString();
                const requirements = [];
                if (this.computedUserPoolProps.passwordPolicy.requireDigits) {
                    requirements.push('REQUIRES_NUMBERS');
                }
                if (this.computedUserPoolProps.passwordPolicy.requireLowercase) {
                    requirements.push('REQUIRES_LOWERCASE');
                }
                if (this.computedUserPoolProps.passwordPolicy.requireUppercase) {
                    requirements.push('REQUIRES_UPPERCASE');
                }
                if (this.computedUserPoolProps.passwordPolicy.requireSymbols) {
                    requirements.push('REQUIRES_SYMBOLS');
                }
                if (requirements.length > 0) {
                    output.passwordPolicyRequirements = JSON.stringify(requirements);
                }
            }
            if (this.computedUserPoolProps.mfa) {
                output.mfaConfiguration = this.computedUserPoolProps.mfa;
                const mfaTypes = [];
                if ((_b = this.computedUserPoolProps.mfaSecondFactor) === null || _b === void 0 ? void 0 : _b.otp) {
                    mfaTypes.push('TOTP');
                }
                if ((_c = this.computedUserPoolProps.mfaSecondFactor) === null || _c === void 0 ? void 0 : _c.sms) {
                    mfaTypes.push('SMS');
                }
                if (mfaTypes.length > 0) {
                    output.mfaTypes = JSON.stringify(mfaTypes);
                }
            }
            const oAuthMappings = this.providerSetupResult.oAuthMappings;
            if (oAuthMappings[authProvidersList.amazon]) {
                output.amazonClientId = oAuthMappings[authProvidersList.amazon];
            }
            if (oAuthMappings[authProvidersList.facebook]) {
                output.facebookClientId = oAuthMappings[authProvidersList.facebook];
            }
            if (oAuthMappings[authProvidersList.google]) {
                output.googleClientId = oAuthMappings[authProvidersList.google];
            }
            if (oAuthMappings[authProvidersList.apple]) {
                output.appleClientId = oAuthMappings[authProvidersList.apple];
            }
            if (this.providerSetupResult.providersList.length > 0) {
                output.socialProviders = JSON.stringify(this.providerSetupResult.providersList);
            }
            // if callback URLs are configured, we must expose the oauth settings to the output
            if (this.providerSetupResult.oAuthSettings &&
                this.providerSetupResult.oAuthSettings.callbackUrls) {
                const oAuthSettings = this.providerSetupResult.oAuthSettings;
                if (this.domainPrefix) {
                    output.oauthCognitoDomain = `${this.domainPrefix}.auth.${aws_cdk_lib_1.Stack.of(this).region}.amazoncognito.com`;
                }
                output.oauthScope = JSON.stringify((_e = (_d = oAuthSettings.scopes) === null || _d === void 0 ? void 0 : _d.map((s) => s.scopeName)) !== null && _e !== void 0 ? _e : []);
                output.oauthRedirectSignIn = oAuthSettings.callbackUrls
                    ? oAuthSettings.callbackUrls.join(',')
                    : '';
                output.oauthRedirectSignOut = oAuthSettings.logoutUrls
                    ? oAuthSettings.logoutUrls.join(',')
                    : '';
                output.oauthClientId = this.resources.userPoolClient.userPoolClientId;
                output.oauthResponseType = 'code';
            }
            outputStorageStrategy.addBackendOutputEntry(backend_output_schemas_1.authOutputKey, {
                version: '1',
                payload: output,
            });
        };
        this.name = (_a = props.name) !== null && _a !== void 0 ? _a : '';
        this.domainPrefix = (_b = props.loginWith.externalProviders) === null || _b === void 0 ? void 0 : _b.domainPrefix;
        // UserPool
        this.computedUserPoolProps = this.getUserPoolProps(props);
        this.userPool = new aws_cdk_lib_1.aws_cognito.UserPool(this, `${this.name}UserPool`, this.computedUserPoolProps);
        // UserPool - External Providers (Oauth, SAML, OIDC) and User Pool Domain
        this.providerSetupResult = this.setupExternalProviders(this.userPool, props.loginWith);
        // UserPool Client
        const userPoolClient = new aws_cdk_lib_1.aws_cognito.UserPoolClient(this, `${this.name}UserPoolAppClient`, {
            userPool: this.userPool,
            authFlows: defaults_js_1.DEFAULTS.AUTH_FLOWS,
            preventUserExistenceErrors: defaults_js_1.DEFAULTS.PREVENT_USER_EXISTENCE_ERRORS,
            oAuth: this.providerSetupResult.oAuthSettings,
        });
        // Identity Pool
        const { identityPool, identityPoolRoleAttachment, roles: { auth, unAuth }, } = this.setupIdentityPool(this.userPool, userPoolClient, this.providerSetupResult);
        // Setup UserPool groups
        this.setupUserPoolGroups(props.groups, identityPool);
        // expose resources
        this.resources = {
            userPool: this.userPool,
            userPoolClient,
            authenticatedUserIamRole: auth,
            unauthenticatedUserIamRole: unAuth,
            cfnResources: {
                cfnUserPool: this.userPool.node.findChild('Resource'),
                cfnUserPoolClient: userPoolClient.node.findChild('Resource'),
                cfnIdentityPool: identityPool,
                cfnIdentityPoolRoleAttachment: identityPoolRoleAttachment,
            },
            groups: this.groups,
        };
        this.storeOutput(props.outputStorageStrategy);
        new backend_output_storage_1.AttributionMetadataStorage().storeAttributionMetadata(aws_cdk_lib_1.Stack.of(this), authStackType, path.resolve(__dirname, '..', 'package.json'));
    }
    /**
     * Parses the user invitation settings and inserts codes/usernames where necessary.
     * @param settings the invitation settings
     * @returns cognito.UserInvitationConfig | undefined
     */
    getUserInvitationSettings(settings) {
        if (!settings) {
            return undefined;
        }
        return {
            emailSubject: settings.emailSubject,
            emailBody: settings.emailBody
                ? settings.emailBody(() => INVITATION_PLACEHOLDERS.USERNAME, () => INVITATION_PLACEHOLDERS.CODE)
                : undefined,
            smsMessage: settings.smsMessage
                ? settings.smsMessage(() => INVITATION_PLACEHOLDERS.USERNAME, () => INVITATION_PLACEHOLDERS.CODE)
                : undefined,
        };
    }
    /**
     * Verify the email body depending on if 'CODE' or 'LINK' style is used.
     * This ensures that the template contains the necessary placeholders for Cognito to insert verification codes or links.
     * @param emailSettings the provided email settings
     * @returns emailBody
     */
    verifyEmailBody(emailSettings) {
        let emailBody;
        if (emailSettings.verificationEmailBody &&
            emailSettings.verificationEmailStyle !== 'LINK') {
            emailBody = emailSettings.verificationEmailBody(() => VERIFICATION_EMAIL_PLACEHOLDERS.CODE);
            if (!emailBody.includes(VERIFICATION_EMAIL_PLACEHOLDERS.CODE)) {
                throw Error("Invalid email settings. Property 'verificationEmailBody' must utilize the 'code' parameter at least once as a placeholder for the verification code.");
            }
        }
        if (emailSettings.verificationEmailBody &&
            emailSettings.verificationEmailStyle === 'LINK') {
            let linkText = '';
            emailBody = emailSettings.verificationEmailBody((text) => {
                linkText = text
                    ? `{##${text}##}`
                    : VERIFICATION_EMAIL_PLACEHOLDERS.LINK;
                return linkText;
            });
            if (linkText === '' || !emailBody.includes(linkText)) {
                throw Error("Invalid email settings. Property 'verificationEmailBody' must utilize the 'link' parameter at least once as a placeholder for the verification link.");
            }
        }
        return emailBody;
    }
}
exports.AmplifyAuth = AmplifyAuth;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uc3RydWN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NvbnN0cnVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLDJDQUF1QztBQUN2Qyw2Q0FBMkU7QUFNM0UseURBbUJpQztBQUNqQyxpREFBK0Q7QUFDL0QsZ0ZBQWdGO0FBT2hGLCtDQUF5QztBQUN6QyxnRkFHNkM7QUFDN0MsMkNBQTZCO0FBQzdCLHFEQUF3RDtBQWN4RCxNQUFNLGlCQUFpQixHQUFHO0lBQ3hCLFFBQVEsRUFBRSxvQkFBb0I7SUFDOUIsTUFBTSxFQUFFLHFCQUFxQjtJQUM3QixNQUFNLEVBQUUsZ0JBQWdCO0lBQ3hCLEtBQUssRUFBRSxtQkFBbUI7Q0FDM0IsQ0FBQztBQUNGLE1BQU0sdUJBQXVCLEdBQUc7SUFDOUIsSUFBSSxFQUFFLFFBQVE7SUFDZCxRQUFRLEVBQUUsWUFBWTtDQUN2QixDQUFDO0FBQ0YsTUFBTSwrQkFBK0IsR0FBRztJQUN0QyxJQUFJLEVBQUUsUUFBUTtJQUNkLElBQUksRUFBRSxvQkFBb0I7Q0FDM0IsQ0FBQztBQUNGLE1BQU0sNkJBQTZCLEdBQUc7SUFDcEMsSUFBSSxFQUFFLFFBQVE7Q0FDZixDQUFDO0FBQ0YsTUFBTSxvQkFBb0IsR0FBRztJQUMzQixJQUFJLEVBQUUsUUFBUTtDQUNmLENBQUM7QUFDRixNQUFNLG9CQUFvQixHQUFHO0lBQzNCLHdCQUFVLENBQUMsS0FBSztJQUNoQix3QkFBVSxDQUFDLEtBQUs7SUFDaEIsd0JBQVUsQ0FBQyxNQUFNO0lBQ2pCLHdCQUFVLENBQUMsT0FBTztJQUNsQix3QkFBVSxDQUFDLGFBQWE7Q0FDekIsQ0FBQztBQUVGLHNIQUFzSDtBQUN0SCxNQUFNLGFBQWEsR0FBRyxjQUFjLENBQUM7QUFFckM7O0dBRUc7QUFDSCxNQUFhLFdBQ1gsU0FBUSxzQkFBUztJQTJCakI7OztPQUdHO0lBQ0gsWUFDRSxLQUFnQixFQUNoQixFQUFVLEVB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LEtBQUssTUFBTSxFQUMvQztZQUNBLFNBQVMsR0FBRyxhQUFhLENBQUMscUJBQXFCLENBQzdDLEdBQUcsRUFBRSxDQUFDLCtCQUErQixDQUFDLElBQUksQ0FDM0MsQ0FBQztZQUNGLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLCtCQUErQixDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUM3RCxNQUFNLEtBQUssQ0FDVCxzSkFBc0osQ0FDdkosQ0FBQzthQUNIO1NBQ0Y7UUFDRCxJQUNFLGFBQWEsQ0FBQyxxQkFBcUI7WUFDbkMsYUFBYSxDQUFDLHNCQUFzQixLQUFLLE1BQU0sRUFDL0M7WUFDQSxJQUFJLFFBQVEsR0FBVyxFQUFFLENBQUM7WUFDMUIsU0FBUyxHQUFHLGFBQWEsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLElBQWEsRUFBRSxFQUFFO2dCQUNoRSxRQUFRLEdBQUcsSUFBSTtvQkFDYixDQUFDLENBQUMsTUFBTSxJQUFJLEtBQUs7b0JBQ2pCLENBQUMsQ0FBQywrQkFBK0IsQ0FBQyxJQUFJLENBQUM7Z0JBQ3pDLE9BQU8sUUFBUSxDQUFDO1lBQ2xCLENBQUMsQ0FBQyxDQUFDO1lBQ0gsSUFBSSxRQUFRLEtBQUssRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsRUFBRTtnQkFDcEQsTUFBTSxLQUFLLENBQ1Qsc0pBQXNKLENBQ3ZKLENBQUM7YUFDSDtTQUNGO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztDQTBoQkY7QUE5NkJELGtDQTg2QkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IFJlbW92YWxQb2xpY3ksIFN0YWNrLCBhd3NfY29nbml0byBhcyBjb2duaXRvIH0gZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHtcbiAgQXV0aFJlc291cmNlcyxcbiAgQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbiAgUmVzb3VyY2VQcm92aWRlcixcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQge1xuICBDZm5JZGVudGl0eVBvb2wsXG4gIENmblVzZXJQb29sLFxuICBDZm5Vc2VyUG9vbENsaWVudCxcbiAgQ2ZuVXNlclBvb2xHcm91cCxcbiAgTWZhLFxuICBPQXV0aFNjb3BlLFxuICBPaWRjQXR0cmlidXRlUmVxdWVzdE1ldGhvZCxcbiAgUHJvdmlkZXJBdHRyaWJ1dGUsXG4gIFVzZXJQb29sLFxuICBVc2VyUG9vbENsaWVudCxcbiAgVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyQW1hem9uLFxuICBVc2VyUG9vbElkZW50aXR5UHJvdmlkZXJBcHBsZSxcbiAgVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyRmFjZWJvb2ssXG4gIFVzZXJQb29sSWRlbnRpdHlQcm92aWRlckdvb2dsZSxcbiAgVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyT2lkYyxcbiAgVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyU2FtbCxcbiAgVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyU2FtbE1ldGFkYXRhVHlwZSxcbiAgVXNlclBvb2xQcm9wcyxcbn0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWNvZ25pdG8nO1xuaW1wb3J0IHsgRmVkZXJhdGVkUHJpbmNpcGFsLCBSb2xlIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XG5pbXBvcnQgeyBBdXRoT3V0cHV0LCBhdXRoT3V0cHV0S2V5IH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXNjaGVtYXMnO1xuaW1wb3J0IHtcbiAgQXR0cmlidXRlTWFwcGluZyxcbiAgQXV0aFByb3BzLFxuICBFbWFpbExvZ2luU2V0dGluZ3MsXG4gIEV4dGVybmFsUHJvdmlkZXJPcHRpb25zLFxufSBmcm9tICcuL3R5cGVzLmpzJztcbmltcG9ydCB7IERFRkFVTFRTIH0gZnJvbSAnLi9kZWZhdWx0cy5qcyc7XG5pbXBvcnQge1xuICBBdHRyaWJ1dGlvbk1ldGFkYXRhU3RvcmFnZSxcbiAgU3RhY2tNZXRhZGF0YUJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zdG9yYWdlJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBjb3JlQXR0cmlidXRlTmFtZU1hcCB9IGZyb20gJy4vc3RyaW5nX21hcHMuanMnO1xuXG50eXBlIERlZmF1bHRSb2xlcyA9IHsgYXV0aDogUm9sZTsgdW5BdXRoOiBSb2xlIH07XG50eXBlIElkZW50aXR5UHJvdmlkZXJTZXR1cFJlc3VsdCA9IHtcbiAgb0F1dGhNYXBwaW5nczogUmVjb3JkPHN0cmluZywgc3RyaW5nPjtcbiAgcHJvdmlkZXJzTGlzdDogc3RyaW5nW107XG4gIG9BdXRoU2V0dGluZ3M6IGNvZ25pdG8uT0F1dGhTZXR0aW5ncyB8IHVuZGVmaW5lZDtcbiAgZ29vZ2xlPzogVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyR29vZ2xlO1xuICBmYWNlYm9vaz86IFVzZXJQb29sSWRlbnRpdHlQcm92aWRlckZhY2Vib29rO1xuICBhbWF6b24/OiBVc2VyUG9vbElkZW50aXR5UHJvdmlkZXJBbWF6b247XG4gIGFwcGxlPzogVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyQXBwbGU7XG4gIG9pZGM/OiBVc2VyUG9vbElkZW50aXR5UHJvdmlkZXJPaWRjW107XG4gIHNhbWw/OiBVc2VyUG9vbElkZW50aXR5UHJvdmlkZXJTYW1sO1xufTtcbmNvbnN0IGF1dGhQcm92aWRlcnNMaXN0ID0ge1xuICBmYWNlYm9vazogJ2dyYXBoLmZhY2Vib29rLmNvbScsXG4gIGdvb2dsZTogJ2FjY291bnRzLmdvb2dsZS5jb20nLFxuICBhbWF6b246ICd3d3cuYW1hem9uLmNvbScsXG4gIGFwcGxlOiAnYXBwbGVpZC5hcHBsZS5jb20nLFxufTtcbmNvbnN0IElOVklUQVRJT05fUExBQ0VIT0xERVJTID0ge1xuICBDT0RFOiAneyMjIyN9JyxcbiAgVVNFUk5BTUU6ICd7dXNlcm5hbWV9Jyxcbn07XG5jb25zdCBWRVJJRklDQVRJT05fRU1BSUxfUExBQ0VIT0xERVJTID0ge1xuICBDT0RFOiAneyMjIyN9JyxcbiAgTElOSzogJ3sjI1ZlcmlmeSBFbWFpbCMjfScsXG59O1xuY29uc3QgVkVSSUZJQ0FUSU9OX1NNU19QTEFDRUhPTERFUlMgPSB7XG4gIENPREU6ICd7IyMjI30nLFxufTtcbmNvbnN0IE1GQV9TTVNfUExBQ0VIT0xERVJTID0ge1xuICBDT0RFOiAneyMjIyN9Jyxcbn07XG5jb25zdCBERUZBVUxUX09BVVRIX1NDT1BFUyA9IFtcbiAgT0F1dGhTY29wZS5QSE9ORSxcbiAgT0F1dGhTY29wZS5FTUFJTCxcbiAgT0F1dGhTY29wZS5PUEVOSUQsXG4gIE9BdXRoU2NvcGUuUFJPRklMRSxcbiAgT0F1dGhTY29wZS5DT0dOSVRPX0FETUlOLFxuXTtcblxuLy8gQmUgdmVyeSBjYXJlZnVsIGVkaXRpbmcgdGhpcyB2YWx1ZS4gSXQgaXMgdGhlIHN0cmluZyB0aGF0IGlzIHVzZWQgdG8gYXR0cmlidXRlIHN0YWNrcyB0byBBbXBsaWZ5IEF1dGggaW4gQkkgbWV0cmljc1xuY29uc3QgYXV0aFN0YWNrVHlwZSA9ICdhdXRoLUNvZ25pdG8nO1xuXG4vKipcbiAqIEFtcGxpZnkgQXV0aCBDREsgQ29uc3RydWN0XG4gKi9cbmV4cG9ydCBjbGFzcyBBbXBsaWZ5QXV0aFxuICBleHRlbmRzIENvbnN0cnVjdFxuICBpbXBsZW1lbnRzIFJlc291cmNlUHJvdmlkZXI8QXV0aFJlc291cmNlcz5cbntcbiAgLyoqXG4gICAqIFRoZSByZXNvdXJjZXMgZ2VuZXJhdGVkIGJ5IHRoZSBjb25zdHJ1Y3QuXG4gICAqL1xuICByZWFkb25seSByZXNvdXJjZXM6IEF1dGhSZXNvdXJjZXM7XG4gIC8qKlxuICAgKiBFeHRlcm5hbCBwcm92aWRlciBzZXR0aW5nc1xuICAgKi9cbiAgcHJpdmF0ZSByZWFkb25seSBwcm92aWRlclNldHVwUmVzdWx0OiBJZGVudGl0eVByb3ZpZGVyU2V0dXBSZXN1bHQ7XG5cbiAgcHJpdmF0ZSByZWFkb25seSB1c2VyUG9vbDogVXNlclBvb2w7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBjb21wdXRlZFVzZXJQb29sUHJvcHM6IFVzZXJQb29sUHJvcHM7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBuYW1lOiBzdHJpbmc7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBkb21haW5QcmVmaXg6IHN0cmluZyB8IHVuZGVmaW5lZDtcblxuICBwcml2YXRlIHJlYWRvbmx5IGdyb3Vwczoge1xuICAgIFtrZXk6IHN0cmluZ106IHtcbiAgICAgIGNmblVzZXJHcm91cDogQ2ZuVXNlclBvb2xHcm91cDtcbiAgICAgIHJvbGU6IFJvbGU7XG4gICAgfTtcbiAgfSA9IHt9O1xuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBuZXcgQXV0aCBjb25zdHJ1Y3Qgd2l0aCBBdXRoUHJvcHMuXG4gICAqIElmIG5vIHByb3BzIGFyZSBwcm92aWRlZCwgZW1haWwgbG9naW4gYW5kIGRlZmF1bHRzIHdpbGwgYmUgdXNlZC5cbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgaWQ6IHN0cmluZyxcbiAgICBwcm9wczogQXV0aFByb3BzID0gREVGQVVMVFMuSUZfTk9fUFJPUFNfUFJPVklERURcbiAgKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkKTtcblxuICAgIHRoaXMubmFtZSA9IHByb3BzLm5hbWUgPz8gJyc7XG4gICAgdGhpcy5kb21haW5QcmVmaXggPSBwcm9wcy5sb2dpbldpdGguZXh0ZXJuYWxQcm92aWRlcnM/LmRvbWFpblByZWZpeDtcblxuICAgIC8vIFVzZXJQb29sXG4gICAgdGhpcy5jb21wdXRlZFVzZXJQb29sUHJvcHMgPSB0aGlzLmdldFVzZXJQb29sUHJvcHMocHJvcHMpO1xuICAgIHRoaXMudXNlclBvb2wgPSBuZXcgY29nbml0by5Vc2VyUG9vbChcbiAgICAgIHRoaXMsXG4gICAgICBgJHt0aGlzLm5hbWV9VXNlclBvb2xgLFxuICAgICAgdGhpcy5jb21wdXRlZFVzZXJQb29sUHJvcHNcbiAgICApO1xuXG4gICAgLy8gVXNlclBvb2wgLSBFeHRlcm5hbCBQcm92aWRlcnMgKE9hdXRoLCBTQU1MLCBPSURDKSBhbmQgVXNlciBQb29sIERvbWFpblxuICAgIHRoaXMucHJvdmlkZXJTZXR1cFJlc3VsdCA9IHRoaXMuc2V0dXBFeHRlcm5hbFByb3ZpZGVycyhcbiAgICAgIHRoaXMudXNlclBvb2wsXG4gICAgICBwcm9wcy5sb2dpbldpdGhcbiAgICApO1xuXG4gICAgLy8gVXNlclBvb2wgQ2xpZW50XG4gICAgY29uc3QgdXNlclBvb2xDbGllbnQgPSBuZXcgY29nbml0by5Vc2VyUG9vbENsaWVudChcbiAgICAgIHRoaXMsXG4gICAgICBgJHt0aGlzLm5hbWV9VXNlclBvb2xBcHBDbGllbnRgLFxuICAgICAge1xuICAgICAgICB1c2VyUG9vbDogdGhpcy51c2VyUG9vbCxcbiAgICAgICAgYXV0aEZsb3dzOiBERUZBVUxUUy5BVVRIX0ZMT1dTLFxuICAgICAgICBwcmV2ZW50VXNlckV4aXN0ZW5jZUVycm9yczogREVGQVVMVFMuUFJFVkVOVF9VU0VSX0VYSVNURU5DRV9FUlJPUlMsXG4gICAgICAgIG9BdXRoOiB0aGlzLnByb3ZpZGVyU2V0dXBSZXN1bHQub0F1dGhTZXR0aW5ncyxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgLy8gSWRlbnRpdHkgUG9vbFxuICAgIGNvbnN0IHtcbiAgICAgIGlkZW50aXR5UG9vbCxcbiAgICAgIGlkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50LFxuICAgICAgcm9sZXM6IHsgYXV0aCwgdW5BdXRoIH0sXG4gICAgfSA9IHRoaXMuc2V0dXBJZGVudGl0eVBvb2woXG4gICAgICB0aGlzLnVzZXJQb29sLFxuICAgICAgdXNlclBvb2xDbGllbnQsXG4gICAgICB0aGlzLnByb3ZpZGVyU2V0dXBSZXN1bHRcbiAgICApO1xuXG4gICAgLy8gU2V0dXAgVXNlclBvb2wgZ3JvdXBzXG4gICAgdGhpcy5zZXR1cFVzZXJQb29sR3JvdXBzKHByb3BzLmdyb3VwcywgaWRlbnRpdHlQb29sKTtcblxuICAgIC8vIGV4cG9zZSByZXNvdXJjZXNcbiAgICB0aGlzLnJlc291cmNlcyA9IHtcbiAgICAgIHVzZXJQb29sOiB0aGlzLnVzZXJQb29sLFxuICAgICAgdXNlclBvb2xDbGllbnQsXG4gICAgICBhdXRoZW50aWNhdGVkVXNlcklhbVJvbGU6IGF1dGgsXG4gICAgICB1bmF1dGhlbnRpY2F0ZWRVc2VySWFtUm9sZTogdW5BdXRoLFxuICAgICAgY2ZuUmVzb3VyY2VzOiB7XG4gICAgICAgIGNmblVzZXJQb29sOiB0aGlzLnVzZXJQb29sLm5vZGUuZmluZENoaWxkKCdSZXNvdXJjZScpIGFzIENmblVzZXJQb29sLFxuICAgICAgICBjZm5Vc2VyUG9vbENsaWVudDogdXNlclBvb2xDbGllbnQubm9kZS5maW5kQ2hpbGQoXG4gICAgICAgICAgJ1Jlc291cmNlJ1xuICAgICAgICApIGFzIENmblVzZXJQb29sQ2xpZW50LFxuICAgICAgICBjZm5JZGVudGl0eVBvb2w6IGlkZW50aXR5UG9vbCxcbiAgICAgICAgY2ZuSWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQ6IGlkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50LFxuICAgICAgfSxcbiAgICAgIGdyb3VwczogdGhpcy5ncm91cHMsXG4gICAgfTtcbiAgICB0aGlzLnN0b3JlT3V0cHV0KHByb3BzLm91dHB1dFN0b3JhZ2VTdHJhdGVneSk7XG5cbiAgICBuZXcgQXR0cmlidXRpb25NZXRhZGF0YVN0b3JhZ2UoKS5zdG9yZUF0dHJpYnV0aW9uTWV0YWRhdGEoXG4gICAgICBTdGFjay5vZih0aGlzKSxcbiAgICAgIGF1dGhTdGFja1R5cGUsXG4gICAgICBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAncGFja2FnZS5qc29uJylcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBBdXRoL1VuQXV0aCBSb2xlc1xuICAgKiBAcmV0dXJucyBEZWZhdWx0Um9sZXNcbiAgICovXG4gIHByaXZhdGUgc2V0dXBBdXRoQW5kVW5BdXRoUm9sZXMgPSAoaWRlbnRpdHlQb29sSWQ6IHN0cmluZyk6IERlZmF1bHRSb2xlcyA9PiB7XG4gICAgY29uc3QgcmVzdWx0OiBEZWZhdWx0Um9sZXMgPSB7XG4gICAgICBhdXRoOiBuZXcgUm9sZSh0aGlzLCBgJHt0aGlzLm5hbWV9YXV0aGVudGljYXRlZFVzZXJSb2xlYCwge1xuICAgICAgICBhc3N1bWVkQnk6IG5ldyBGZWRlcmF0ZWRQcmluY2lwYWwoXG4gICAgICAgICAgJ2NvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbScsXG4gICAgICAgICAge1xuICAgICAgICAgICAgU3RyaW5nRXF1YWxzOiB7XG4gICAgICAgICAgICAgICdjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206YXVkJzogaWRlbnRpdHlQb29sSWQsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgJ0ZvckFueVZhbHVlOlN0cmluZ0xpa2UnOiB7XG4gICAgICAgICAgICAgICdjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206YW1yJzogJ2F1dGhlbnRpY2F0ZWQnLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICAgICdzdHM6QXNzdW1lUm9sZVdpdGhXZWJJZGVudGl0eSdcbiAgICAgICAgKSxcbiAgICAgIH0pLFxuICAgICAgdW5BdXRoOiBuZXcgUm9sZSh0aGlzLCBgJHt0aGlzLm5hbWV9dW5hdXRoZW50aWNhdGVkVXNlclJvbGVgLCB7XG4gICAgICAgIGFzc3VtZWRCeTogbmV3IEZlZGVyYXRlZFByaW5jaXBhbChcbiAgICAgICAgICAnY29nbml0by1pZGVudGl0eS5hbWF6b25hd3MuY29tJyxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBTdHJpbmdFcXVhbHM6IHtcbiAgICAgICAgICAgICAgJ2NvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbTphdWQnOiBpZGVudGl0eVBvb2xJZCxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAnRm9yQW55VmFsdWU6U3RyaW5nTGlrZSc6IHtcbiAgICAgICAgICAgICAgJ2NvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbTphbXInOiAndW5hdXRoZW50aWNhdGVkJyxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSxcbiAgICAgICAgICAnc3RzOkFzc3VtZVJvbGVXaXRoV2ViSWRlbnRpdHknXG4gICAgICAgICksXG4gICAgICB9KSxcbiAgICB9O1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIEF1dG8gZ2VuZXJhdGUgdGhlIHVzZXIgcG9vbCBncm91cHMgYW5kIGdyb3VwIHJvbGVzXG4gICAqL1xuICBwcml2YXRlIHNldHVwVXNlclBvb2xHcm91cHMgPSAoXG4gICAgZ3JvdXBzOiBzdHJpbmdbXSB8IHVuZGVmaW5lZCxcbiAgICBpZGVudGl0eVBvb2w6IENmbklkZW50aXR5UG9vbFxuICApID0+IHtcbiAgICAoZ3JvdXBzIHx8IFtdKS5mb3JFYWNoKChncm91cE5hbWUsIGluZGV4KSA9PiB7XG4gICAgICBjb25zdCBncm91cFJvbGUgPSBuZXcgUm9sZSh0aGlzLCBgJHt0aGlzLm5hbWV9JHtncm91cE5hbWV9R3JvdXBSb2xlYCwge1xuICAgICAgICBhc3N1bWVkQnk6IG5ldyBGZWRlcmF0ZWRQcmluY2lwYWwoXG4gICAgICAgICAgJ2NvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbScsXG4gICAgICAgICAge1xuICAgICAgICAgICAgU3RyaW5nRXF1YWxzOiB7XG4gICAgICAgICAgICAgICdjb2duaXRvLWlkZW50aXR5LmFtYXpvbmF3cy5jb206YXVkJzogaWRlbnRpdHlQb29sLnJlZixcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAnRm9yQW55VmFsdWU6U3RyaW5nTGlrZSc6IHtcbiAgICAgICAgICAgICAgJ2NvZ25pdG8taWRlbnRpdHkuYW1hem9uYXdzLmNvbTphbXInOiAnYXV0aGVudGljYXRlZCcsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgICAgJ3N0czpBc3N1bWVSb2xlV2l0aFdlYklkZW50aXR5J1xuICAgICAgICApLFxuICAgICAgfSk7XG4gICAgICBjb25zdCBjdXJyZW50R3JvdXAgPSBuZXcgQ2ZuVXNlclBvb2xHcm91cChcbiAgICAgICAgdGhpcyxcbiAgICAgICAgYCR7dGhpcy5uYW1lfSR7Z3JvdXBOYW1lfUdyb3VwYCxcbiAgICAgICAge1xuICAgICAgICAgIHVzZXJQb29sSWQ6IHRoaXMudXNlclBvb2wudXNlclBvb2xJZCxcbiAgICAgICAgICBncm91cE5hbWU6IGdyb3VwTmFtZSxcbiAgICAgICAgICByb2xlQXJuOiBncm91cFJvbGUucm9sZUFybixcbiAgICAgICAgICBwcmVjZWRlbmNlOiBpbmRleCxcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIHRoaXMuZ3JvdXBzW2dyb3VwTmFtZV0gPSB7XG4gICAgICAgIGNmblVzZXJHcm91cDogY3VycmVudEdyb3VwLFxuICAgICAgICByb2xlOiBncm91cFJvbGUsXG4gICAgICB9O1xuICAgIH0pO1xuICB9O1xuXG4gIC8qKlxuICAgKiBTZXR1cCBJZGVudGl0eSBQb29sIHdpdGggZGVmYXVsdCByb2xlcy9yb2xlIG1hcHBpbmdzLCBhbmQgcmVnaXN0ZXIgcHJvdmlkZXJzXG4gICAqL1xuICBwcml2YXRlIHNldHVwSWRlbnRpdHlQb29sID0gKFxuICAgIHVzZXJQb29sOiBVc2VyUG9vbCxcbiAgICB1c2VyUG9vbENsaWVudDogVXNlclBvb2xDbGllbnQsXG4gICAgcHJvdmlkZXJTZXR1cFJlc3VsdDogSWRlbnRpdHlQcm92aWRlclNldHVwUmVzdWx0XG4gICkgPT4ge1xuICAgIC8vIHNldHVwIGlkZW50aXR5IHBvb2xcbiAgICBjb25zdCByZWdpb24gPSBTdGFjay5vZih0aGlzKS5yZWdpb247XG4gICAgY29uc3QgaWRlbnRpdHlQb29sID0gbmV3IGNvZ25pdG8uQ2ZuSWRlbnRpdHlQb29sKFxuICAgICAgdGhpcyxcbiAgICAgIGAke3RoaXMubmFtZX1JZGVudGl0eVBvb2xgLFxuICAgICAge1xuICAgICAgICBhbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXM6XG4gICAgICAgICAgREVGQVVMVFMuQUxMT1dfVU5BVVRIRU5USUNBVEVEX0lERU5USVRJRVMsXG4gICAgICB9XG4gICAgKTtcbiAgICBjb25zdCByb2xlcyA9IHRoaXMuc2V0dXBBdXRoQW5kVW5BdXRoUm9sZXMoaWRlbnRpdHlQb29sLnJlZik7XG4gICAgY29uc3QgaWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQgPVxuICAgICAgbmV3IGNvZ25pdG8uQ2ZuSWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQoXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGAke3RoaXMubmFtZX1JZGVudGl0eVBvb2xSb2xlQXR0YWNobWVudGAsXG4gICAgICAgIHtcbiAgICAgICAgICBpZGVudGl0eVBvb2xJZDogaWRlbnRpdHlQb29sLnJlZixcbiAgICAgICAgICByb2xlczoge1xuICAgICAgICAgICAgdW5hdXRoZW50aWNhdGVkOiByb2xlcy51bkF1dGgucm9sZUFybixcbiAgICAgICAgICAgIGF1dGhlbnRpY2F0ZWQ6IHJvbGVzLmF1dGgucm9sZUFybixcbiAgICAgICAgICB9LFxuICAgICAgICAgIHJvbGVNYXBwaW5nczoge1xuICAgICAgICAgICAgVXNlclBvb2xXZWJDbGllbnRSb2xlTWFwcGluZzoge1xuICAgICAgICAgICAgICB0eXBlOiAnVG9rZW4nLFxuICAgICAgICAgICAgICBhbWJpZ3VvdXNSb2xlUmVzb2x1dGlvbjogJ0F1dGhlbnRpY2F0ZWRSb2xlJyxcbiAgICAgICAgICAgICAgaWRlbnRpdHlQcm92aWRlcjogYGNvZ25pdG8taWRwLiR7cmVnaW9ufS5hbWF6b25hd3MuY29tLyR7dXNlclBvb2wudXNlclBvb2xJZH06JHt1c2VyUG9vbENsaWVudC51c2VyUG9vbENsaWVudElkfWAsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH0sXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgaWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQuYWRkRGVwZW5kZW5jeShpZGVudGl0eVBvb2wpO1xuICAgIGlkZW50aXR5UG9vbFJvbGVBdHRhY2htZW50Lm5vZGUuYWRkRGVwZW5kZW5jeSh1c2VyUG9vbENsaWVudCk7XG4gICAgLy8gYWRkIGNvZ25pdG8gcHJvdmlkZXJcbiAgICBpZGVudGl0eVBvb2wuY29nbml0b0lkZW50aXR5UHJvdmlkZXJzID0gW1xuICAgICAge1xuICAgICAgICBjbGllbnRJZDogdXNlclBvb2xDbGllbnQudXNlclBvb2xDbGllbnRJZCxcbiAgICAgICAgcHJvdmlkZXJOYW1lOiBgY29nbml0by1pZHAuJHtyZWdpb259LmFtYXpvbmF3cy5jb20vJHt1c2VyUG9vbC51c2VyUG9vbElkfWAsXG4gICAgICB9LFxuICAgIF07XG4gICAgLy8gYWRkIG90aGVyIHByb3ZpZGVyc1xuICAgIGlkZW50aXR5UG9vbC5zdXBwb3J0ZWRMb2dpblByb3ZpZGVycyA9IHByb3ZpZGVyU2V0dXBSZXN1bHQub0F1dGhNYXBwaW5ncztcbiAgICByZXR1cm4ge1xuICAgICAgaWRlbnRpdHlQb29sLFxuICAgICAgaWRlbnRpdHlQb29sUm9sZUF0dGFjaG1lbnQsXG4gICAgICByb2xlcyxcbiAgICB9O1xuICB9O1xuXG4gIC8qKlxuICAgKiBQcm9jZXNzIHByb3BzIGludG8gVXNlclBvb2xQcm9wcyAoc2V0IGRlZmF1bHRzIGlmIG5lZWRlZClcbiAgICovXG4gIHByaXZhdGUgZ2V0VXNlclBvb2xQcm9wcyA9IChwcm9wczogQXV0aFByb3BzKTogVXNlclBvb2xQcm9wcyA9PiB7XG4gICAgY29uc3QgZW1haWxFbmFibGVkID0gcHJvcHMubG9naW5XaXRoLmVtYWlsID8gdHJ1ZSA6IGZhbHNlO1xuICAgIGNvbnN0IHBob25lRW5hYmxlZCA9IHByb3BzLmxvZ2luV2l0aC5waG9uZSA/IHRydWUgOiBmYWxzZTtcbiAgICBjb25zdCBvbmVPZkVtYWlsT3JQaG9uZSA9IGVtYWlsRW5hYmxlZCB8fCBwaG9uZUVuYWJsZWQ7XG4gICAgaWYgKCFvbmVPZkVtYWlsT3JQaG9uZSkge1xuICAgICAgdGhyb3cgRXJyb3IoJ0F0IGxlYXN0IG9uZSBvZiBlbWFpbCBvciBwaG9uZSBtdXN0IGJlIGVuYWJsZWQuJyk7XG4gICAgfVxuICAgIGxldCB1c2VyVmVyaWZpY2F0aW9uU2V0dGluZ3M6IGNvZ25pdG8uVXNlclZlcmlmaWNhdGlvbkNvbmZpZyA9IHt9O1xuICAgIC8vIGV4dHJhY3QgZW1haWwgc2V0dGluZ3MgaWYgc2V0dGluZ3Mgb2JqZWN0IGlzIGRlZmluZWRcbiAgICBpZiAodHlwZW9mIHByb3BzLmxvZ2luV2l0aC5lbWFpbCA9PT0gJ29iamVjdCcpIHtcbiAgICAgIGNvbnN0IGVtYWlsU2V0dGluZ3MgPSBwcm9wcy5sb2dpbldpdGguZW1haWw7XG4gICAgICAvLyB2ZXJpZnkgZW1haWwgYm9keSBhbmQgaW5qZWN0IHRoZSBhY3R1YWwgdGVtcGxhdGUgdmFsdWVzIHdoaWNoIGNvZ25pdG8gdXNlc1xuICAgICAgY29uc3QgZW1haWxCb2R5OiBzdHJpbmcgfCB1bmRlZmluZWQgPSB0aGlzLnZlcmlmeUVtYWlsQm9keShlbWFpbFNldHRpbmdzKTtcbiAgICAgIHVzZXJWZXJpZmljYXRpb25TZXR0aW5ncyA9IHtcbiAgICAgICAgZW1haWxCb2R5OiBlbWFpbEJvZHksXG4gICAgICAgIGVtYWlsU3R5bGU6IHRoaXMuZ2V0RW1haWxWZXJpZmljYXRpb25TdHlsZShcbiAgICAgICAgICBlbWFpbFNldHRpbmdzLnZlcmlmaWNhdGlvbkVtYWlsU3R5bGVcbiAgICAgICAgKSxcbiAgICAgICAgZW1haWxTdWJqZWN0OiBlbWFpbFNldHRpbmdzLnZlcmlmaWNhdGlvbkVtYWlsU3ViamVjdCxcbiAgICAgIH07XG4gICAgfVxuICAgIC8vIGV4dHJhY3QgcGhvbmUgc2V0dGluZ3MgaWYgc2V0dGluZ3Mgb2JqZWN0IGlzIGRlZmluZWRcbiAgICBpZiAodHlwZW9mIHByb3BzLmxvZ2luV2l0aC5waG9uZSA9PT0gJ29iamVjdCcpIHtcbiAgICAgIGNvbnN0IHBob25lU2V0dGluZ3MgPSBwcm9wcy5sb2dpbldpdGgucGhvbmU7XG4gICAgICBsZXQgc21zTWVzc2FnZTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgICAgaWYgKFxuICAgICAgICBwaG9uZVNldHRpbmdzLnZlcmlmaWNhdGlvbk1lc3NhZ2UgJiZcbiAgICAgICAgdHlwZW9mIHBob25lU2V0dGluZ3MudmVyaWZpY2F0aW9uTWVzc2FnZSA9PT0gJ2Z1bmN0aW9uJ1xuICAgICAgKSB7XG4gICAgICAgIC8vIHZhbGlkYXRlIHNtcyBtZXNzYWdlIHN0cnVjdHVyZVxuICAgICAgICBzbXNNZXNzYWdlID0gcGhvbmVTZXR0aW5ncy52ZXJpZmljYXRpb25NZXNzYWdlKFxuICAgICAgICAgICgpID0+IFZFUklGSUNBVElPTl9TTVNfUExBQ0VIT0xERVJTLkNPREVcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKCFzbXNNZXNzYWdlLmluY2x1ZGVzKFZFUklGSUNBVElPTl9TTVNfUExBQ0VIT0xERVJTLkNPREUpKSB7XG4gICAgICAgICAgdGhyb3cgRXJyb3IoXG4gICAgICAgICAgICBcIkludmFsaWQgcGhvbmUgc2V0dGluZ3MuIFByb3BlcnR5ICd2ZXJpZmljYXRpb25NZXNzYWdlJyBtdXN0IHV0aWxpemUgdGhlICdjb2RlJyBwYXJhbWV0ZXIgYXQgbGVhc3Qgb25jZSBhcyBhIHBsYWNlaG9sZGVyIGZvciB0aGUgdmVyaWZpY2F0aW9uIGNvZGUuXCJcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB1c2VyVmVyaWZpY2F0aW9uU2V0dGluZ3MgPSB7XG4gICAgICAgIC4uLnVzZXJWZXJpZmljYXRpb25TZXR0aW5ncyxcbiAgICAgICAgc21zTWVzc2FnZTogc21zTWVzc2FnZSxcbiAgICAgIH07XG4gICAgfVxuICAgIGNvbnN0IHVzZXJQb29sUHJvcHM6IFVzZXJQb29sUHJvcHMgPSB7XG4gICAgICBzaWduSW5DYXNlU2Vuc2l0aXZlOiBERUZBVUxUUy5TSUdOX0lOX0NBU0VfU0VOU0lUSVZFLFxuICAgICAgc2lnbkluQWxpYXNlczoge1xuICAgICAgICBwaG9uZTogcGhvbmVFbmFibGVkLFxuICAgICAgICBlbWFpbDogZW1haWxFbmFibGVkLFxuICAgICAgfSxcbiAgICAgIGtlZXBPcmlnaW5hbDoge1xuICAgICAgICBlbWFpbDogZW1haWxFbmFibGVkLFxuICAgICAgICBwaG9uZTogcGhvbmVFbmFibGVkLFxuICAgICAgfSxcbiAgICAgIGF1dG9WZXJpZnk6IHtcbiAgICAgICAgZW1haWw6IGVtYWlsRW5hYmxlZCxcbiAgICAgICAgcGhvbmU6IHBob25lRW5hYmxlZCxcbiAgICAgIH0sXG4gICAgICB1c2VyVmVyaWZpY2F0aW9uOiB1c2VyVmVyaWZpY2F0aW9uU2V0dGluZ3MsXG4gICAgICBwYXNzd29yZFBvbGljeTogREVGQVVMVFMuUEFTU1dPUkRfUE9MSUNZLFxuICAgICAgc3RhbmRhcmRBdHRyaWJ1dGVzOiB7XG4gICAgICAgIGVtYWlsOiBERUZBVUxUUy5JU19SRVFVSVJFRF9BVFRSSUJVVEUuZW1haWwoZW1haWxFbmFibGVkKSxcbiAgICAgICAgcGhvbmVOdW1iZXI6IERFRkFVTFRTLklTX1JFUVVJUkVEX0FUVFJJQlVURS5waG9uZU51bWJlcihwaG9uZUVuYWJsZWQpLFxuICAgICAgICAuLi4ocHJvcHMudXNlckF0dHJpYnV0ZXMgPyBwcm9wcy51c2VyQXR0cmlidXRlcyA6IHt9KSxcbiAgICAgIH0sXG4gICAgICBzZWxmU2lnblVwRW5hYmxlZDogREVGQVVMVFMuQUxMT1dfU0VMRl9TSUdOX1VQLFxuICAgICAgbWZhOiB0aGlzLmdldE1GQU1vZGUocHJvcHMubXVsdGlmYWN0b3IpLFxuICAgICAgbWZhTWVzc2FnZTogdGhpcy5nZXRNRkFNZXNzYWdlKHByb3BzLm11bHRpZmFjdG9yKSxcbiAgICAgIG1mYVNlY29uZEZhY3RvcjpcbiAgICAgICAgdHlwZW9mIHByb3BzLm11bHRpZmFjdG9yID09PSAnb2JqZWN0JyAmJlxuICAgICAgICBwcm9wcy5tdWx0aWZhY3Rvci5tb2RlICE9PSAnT0ZGJ1xuICAgICAgICAgID8ge1xuICAgICAgICAgICAgICBzbXM6IHByb3BzLm11bHRpZmFjdG9yLnNtcyA/IHRydWUgOiBmYWxzZSxcbiAgICAgICAgICAgICAgb3RwOiBwcm9wcy5tdWx0aWZhY3Rvci50b3RwID8gdHJ1ZSA6IGZhbHNlLFxuICAgICAgICAgICAgfVxuICAgICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgYWNjb3VudFJlY292ZXJ5OiB0aGlzLmdldEFjY291bnRSZWNvdmVyeVNldHRpbmcoXG4gICAgICAgIGVtYWlsRW5hYmxlZCxcbiAgICAgICAgcGhvbmVFbmFibGVkLFxuICAgICAgICBwcm9wcy5hY2NvdW50UmVjb3ZlcnlcbiAgICAgICksXG4gICAgICByZW1vdmFsUG9saWN5OiBSZW1vdmFsUG9saWN5LkRFU1RST1ksXG4gICAgICB1c2VySW52aXRhdGlvbjpcbiAgICAgICAgdHlwZW9mIHByb3BzLmxvZ2luV2l0aC5lbWFpbCAhPT0gJ2Jvb2xlYW4nXG4gICAgICAgICAgPyB0aGlzLmdldFVzZXJJbnZpdGF0aW9uU2V0dGluZ3MoXG4gICAgICAgICAgICAgIHByb3BzLmxvZ2luV2l0aC5lbWFpbD8udXNlckludml0YXRpb25cbiAgICAgICAgICAgIClcbiAgICAgICAgICA6IHVuZGVmaW5lZCxcbiAgICB9O1xuICAgIHJldHVybiB1c2VyUG9vbFByb3BzO1xuICB9O1xuXG4gIC8qKlxuICAgKiBQYXJzZXMgdGhlIHVzZXIgaW52aXRhdGlvbiBzZXR0aW5ncyBhbmQgaW5zZXJ0cyBjb2Rlcy91c2VybmFtZXMgd2hlcmUgbmVjZXNzYXJ5LlxuICAgKiBAcGFyYW0gc2V0dGluZ3MgdGhlIGludml0YXRpb24gc2V0dGluZ3NcbiAgICogQHJldHVybnMgY29nbml0by5Vc2VySW52aXRhdGlvbkNvbmZpZyB8IHVuZGVmaW5lZFxuICAgKi9cbiAgcHJpdmF0ZSBnZXRVc2VySW52aXRhdGlvblNldHRpbmdzKFxuICAgIHNldHRpbmdzOiBFbWFpbExvZ2luU2V0dGluZ3NbJ3VzZXJJbnZpdGF0aW9uJ11cbiAgKTogY29nbml0by5Vc2VySW52aXRhdGlvbkNvbmZpZyB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKCFzZXR0aW5ncykge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgIGVtYWlsU3ViamVjdDogc2V0dGluZ3MuZW1haWxTdWJqZWN0LFxuICAgICAgZW1haWxCb2R5OiBzZXR0aW5ncy5lbWFpbEJvZHlcbiAgICAgICAgPyBzZXR0aW5ncy5lbWFpbEJvZHkoXG4gICAgICAgICAgICAoKSA9PiBJTlZJVEFUSU9OX1BMQUNFSE9MREVSUy5VU0VSTkFNRSxcbiAgICAgICAgICAgICgpID0+IElOVklUQVRJT05fUExBQ0VIT0xERVJTLkNPREVcbiAgICAgICAgICApXG4gICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgc21zTWVzc2FnZTogc2V0dGluZ3Muc21zTWVzc2FnZVxuICAgICAgICA/IHNldHRpbmdzLnNtc01lc3NhZ2UoXG4gICAgICAgICAgICAoKSA9PiBJTlZJVEFUSU9OX1BMQUNFSE9MREVSUy5VU0VSTkFNRSxcbiAgICAgICAgICAgICgpID0+IElOVklUQVRJT05fUExBQ0VIT0xERVJTLkNPREVcbiAgICAgICAgICApXG4gICAgICAgIDogdW5kZWZpbmVkLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZ5IHRoZSBlbWFpbCBib2R5IGRlcGVuZGluZyBvbiBpZiAnQ09ERScgb3IgJ0xJTksnIHN0eWxlIGlzIHVzZWQuXG4gICAqIFRoaXMgZW5zdXJlcyB0aGF0IHRoZSB0ZW1wbGF0ZSBjb250YWlucyB0aGUgbmVjZXNzYXJ5IHBsYWNlaG9sZGVycyBmb3IgQ29nbml0byB0byBpbnNlcnQgdmVyaWZpY2F0aW9uIGNvZGVzIG9yIGxpbmtzLlxuICAgKiBAcGFyYW0gZW1haWxTZXR0aW5ncyB0aGUgcHJvdmlkZWQgZW1haWwgc2V0dGluZ3NcbiAgICogQHJldHVybnMgZW1haWxCb2R5XG4gICAqL1xuICBwcml2YXRlIHZlcmlmeUVtYWlsQm9keShcbiAgICBlbWFpbFNldHRpbmdzOiBFbWFpbExvZ2luU2V0dGluZ3NcbiAgKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICBsZXQgZW1haWxCb2R5OiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgaWYgKFxuICAgICAgZW1haWxTZXR0aW5ncy52ZXJpZmljYXRpb25FbWFpbEJvZHkgJiZcbiAgICAgIGVtYWlsU2V0dGluZ3MudmVyaWZpY2F0aW9uRW1haWxTdHlsZSAhPT0gJ0xJTksnXG4gICAgKSB7XG4gICAgICBlbWFpbEJvZHkgPSBlbWFpbFNldHRpbmdzLnZlcmlmaWNhdGlvbkVtYWlsQm9keShcbiAgICAgICAgKCkgPT4gVkVSSUZJQ0FUSU9OX0VNQUlMX1BMQUNFSE9MREVSUy5DT0RFXG4gICAgICApO1xuICAgICAgaWYgKCFlbWFpbEJvZHkuaW5jbHVkZXMoVkVSSUZJQ0FUSU9OX0VNQUlMX1BMQUNFSE9MREVSUy5DT0RFKSkge1xuICAgICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgICBcIkludmFsaWQgZW1haWwgc2V0dGluZ3MuIFByb3BlcnR5ICd2ZXJpZmljYXRpb25FbWFpbEJvZHknIG11c3QgdXRpbGl6ZSB0aGUgJ2NvZGUnIHBhcmFtZXRlciBhdCBsZWFzdCBvbmNlIGFzIGEgcGxhY2Vob2xkZXIgZm9yIHRoZSB2ZXJpZmljYXRpb24gY29kZS5cIlxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoXG4gICAgICBlbWFpbFNldHRpbmdzLnZlcmlmaWNhdGlvbkVtYWlsQm9keSAmJlxuICAgICAgZW1haWxTZXR0aW5ncy52ZXJpZmljYXRpb25FbWFpbFN0eWxlID09PSAnTElOSydcbiAgICApIHtcbiAgICAgIGxldCBsaW5rVGV4dDogc3RyaW5nID0gJyc7XG4gICAgICBlbWFpbEJvZHkgPSBlbWFpbFNldHRpbmdzLnZlcmlmaWNhdGlvbkVtYWlsQm9keSgodGV4dD86IHN0cmluZykgPT4ge1xuICAgICAgICBsaW5rVGV4dCA9IHRleHRcbiAgICAgICAgICA/IGB7IyMke3RleHR9IyN9YFxuICAgICAgICAgIDogVkVSSUZJQ0FUSU9OX0VNQUlMX1BMQUNFSE9MREVSUy5MSU5LO1xuICAgICAgICByZXR1cm4gbGlua1RleHQ7XG4gICAgICB9KTtcbiAgICAgIGlmIChsaW5rVGV4dCA9PT0gJycgfHwgIWVtYWlsQm9keS5pbmNsdWRlcyhsaW5rVGV4dCkpIHtcbiAgICAgICAgdGhyb3cgRXJyb3IoXG4gICAgICAgICAgXCJJbnZhbGlkIGVtYWlsIHNldHRpbmdzLiBQcm9wZXJ0eSAndmVyaWZpY2F0aW9uRW1haWxCb2R5JyBtdXN0IHV0aWxpemUgdGhlICdsaW5rJyBwYXJhbWV0ZXIgYXQgbGVhc3Qgb25jZSBhcyBhIHBsYWNlaG9sZGVyIGZvciB0aGUgdmVyaWZpY2F0aW9uIGxpbmsuXCJcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGVtYWlsQm9keTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgZW1haWwgdmVyaWZpY2F0aW9uIHN0eWxlIGZyb20gdXNlciBwcm9wc1xuICAgKiBAcGFyYW0gdmVyaWZpY2F0aW9uRW1haWxTdHlsZSAtIHN0cmluZyB2YWx1ZVxuICAgKiBAcmV0dXJucyB2ZXJpZmljYXRpb25FbWFpbFN0eWxlIC0gZW51bSB2YWx1ZVxuICAgKi9cbiAgcHJpdmF0ZSBnZXRFbWFpbFZlcmlmaWNhdGlvblN0eWxlID0gKFxuICAgIHZlcmlmaWNhdGlvbkVtYWlsU3R5bGU6ICdDT0RFJyB8ICdMSU5LJyB8IHVuZGVmaW5lZFxuICApOiBjb2duaXRvLlZlcmlmaWNhdGlvbkVtYWlsU3R5bGUgfCB1bmRlZmluZWQgPT4ge1xuICAgIGlmICh2ZXJpZmljYXRpb25FbWFpbFN0eWxlID09PSAnQ09ERScpIHtcbiAgICAgIHJldHVybiBjb2duaXRvLlZlcmlmaWNhdGlvbkVtYWlsU3R5bGUuQ09ERTtcbiAgICB9IGVsc2UgaWYgKHZlcmlmaWNhdGlvbkVtYWlsU3R5bGUgPT09ICdMSU5LJykge1xuICAgICAgcmV0dXJuIGNvZ25pdG8uVmVyaWZpY2F0aW9uRW1haWxTdHlsZS5MSU5LO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9O1xuXG4gIC8qKlxuICAgKiBEZXRlcm1pbmUgdGhlIGFjY291bnQgcmVjb3Zlcnkgb3B0aW9uIGJhc2VkIG9uIGVuYWJsZWQgbG9naW4gbWV0aG9kcy5cbiAgICogQHBhcmFtIGVtYWlsRW5hYmxlZCAtIGlzIGVtYWlsIGVuYWJsZWRcbiAgICogQHBhcmFtIHBob25lRW5hYmxlZCAtIGlzIHBob25lIGVuYWJsZWRcbiAgICogQHBhcmFtIGFjY291bnRSZWNvdmVyeU1ldGhvZEFzU3RyaW5nIC0gdGhlIHVzZXIgcHJvdmlkZWQgYWNjb3VudCByZWNvdmVyeSBzZXR0aW5nXG4gICAqIEByZXR1cm5zIGFjY291bnQgcmVjb3Zlcnkgc2V0dGluZyBlbnVtIHZhbHVlXG4gICAqL1xuICBwcml2YXRlIGdldEFjY291bnRSZWNvdmVyeVNldHRpbmcgPSAoXG4gICAgZW1haWxFbmFibGVkOiBib29sZWFuLFxuICAgIHBob25lRW5hYmxlZDogYm9vbGVhbixcbiAgICBhY2NvdW50UmVjb3ZlcnlNZXRob2RBc1N0cmluZzogQXV0aFByb3BzWydhY2NvdW50UmVjb3ZlcnknXVxuICApOiBjb2duaXRvLkFjY291bnRSZWNvdmVyeSB8IHVuZGVmaW5lZCA9PiB7XG4gICAgY29uc3QgYWNjb3VudFJlY292ZXJ5ID0gdGhpcy5jb252ZXJ0QWNjb3VudFJlY292ZXJ5U3RyaW5nVG9FbnVtKFxuICAgICAgYWNjb3VudFJlY292ZXJ5TWV0aG9kQXNTdHJpbmdcbiAgICApO1xuICAgIGlmIChhY2NvdW50UmVjb3ZlcnkgIT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIGFjY291bnRSZWNvdmVyeTtcbiAgICB9XG4gICAgLy8gc2V0IGRlZmF1bHQgYmFzZWQgb24gZW5hYmxlZCBsb2dpbiBtZXRob2RzXG4gICAgaWYgKHBob25lRW5hYmxlZCAmJiBlbWFpbEVuYWJsZWQpIHtcbiAgICAgIHJldHVybiBjb2duaXRvLkFjY291bnRSZWNvdmVyeS5FTUFJTF9PTkxZO1xuICAgIH1cbiAgICBpZiAocGhvbmVFbmFibGVkKSB7XG4gICAgICByZXR1cm4gY29nbml0by5BY2NvdW50UmVjb3ZlcnkuUEhPTkVfT05MWV9XSVRIT1VUX01GQTtcbiAgICB9XG4gICAgaWYgKGVtYWlsRW5hYmxlZCkge1xuICAgICAgcmV0dXJuIGNvZ25pdG8uQWNjb3VudFJlY292ZXJ5LkVNQUlMX09OTFk7XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIENvbnZlcnQgdXNlciBmcmllbmRseSBNZmEgbW9kZSB0byBjb2duaXRvIE1mYSB0eXBlLlxuICAgKiBUaGlzIGVsaW1pbmF0ZXMgdGhlIG5lZWQgZm9yIHVzZXJzIHRvIGltcG9ydCBjb2duaXRvLk1mYS5cbiAgICogQHBhcmFtIG1mYSAtIE1GQSBzZXR0aW5nc1xuICAgKiBAcmV0dXJucyBjb2duaXRvIE1GQSBlbmZvcmNlbWVudCB0eXBlXG4gICAqL1xuICBwcml2YXRlIGdldE1GQU1vZGUgPSAobWZhOiBBdXRoUHJvcHNbJ211bHRpZmFjdG9yJ10pOiBNZmEgfCB1bmRlZmluZWQgPT4ge1xuICAgIGlmIChtZmEpIHtcbiAgICAgIHN3aXRjaCAobWZhLm1vZGUpIHtcbiAgICAgICAgY2FzZSAnT0ZGJzpcbiAgICAgICAgICByZXR1cm4gTWZhLk9GRjtcbiAgICAgICAgY2FzZSAnT1BUSU9OQUwnOlxuICAgICAgICAgIHJldHVybiBNZmEuT1BUSU9OQUw7XG4gICAgICAgIGNhc2UgJ1JFUVVJUkVEJzpcbiAgICAgICAgICByZXR1cm4gTWZhLlJFUVVJUkVEO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9O1xuXG4gIC8qKlxuICAgKiBDb252ZXJ0IHVzZXIgZnJpZW5kbHkgYWNjb3VudCByZWNvdmVyeSBtZXRob2QgdG8gY29nbml0byBBY2NvdW50UmVjb3ZlciBlbnVtLlxuICAgKiBUaGlzIGVsaW1pbmF0ZXMgdGhlIG5lZWQgZm9yIHVzZXJzIHRvIGltcG9ydCBjb2duaXRvLkFjY291bnRSZWNvdmVyeS5cbiAgICogQHBhcmFtIG1ldGhvZCAtIGFjY291bnQgcmVjb3ZlcnkgbWV0aG9kIGFzIGEgc3RyaW5nIHZhbHVlXG4gICAqIEByZXR1cm5zIGNvZ25pdG8uQWNjb3VudFJlY292ZXJ5IGVudW0gdmFsdWVcbiAgICovXG4gIHByaXZhdGUgY29udmVydEFjY291bnRSZWNvdmVyeVN0cmluZ1RvRW51bSA9IChcbiAgICBtZXRob2Q6IEF1dGhQcm9wc1snYWNjb3VudFJlY292ZXJ5J11cbiAgKTogY29nbml0by5BY2NvdW50UmVjb3ZlcnkgfCB1bmRlZmluZWQgPT4ge1xuICAgIGlmIChtZXRob2QgIT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIGNvZ25pdG8uQWNjb3VudFJlY292ZXJ5W21ldGhvZF07XG4gICAgfVxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIEV4dHJhY3QgdGhlIE1GQSBtZXNzYWdlIHNldHRpbmdzIGFuZCBwZXJmb3JtIHZhbGlkYXRpb24uXG4gICAqIEBwYXJhbSBtZmEgLSBNRkEgc2V0dGluZ3NcbiAgICogQHJldHVybnMgbWZhIG1lc3NhZ2VcbiAgICovXG4gIHByaXZhdGUgZ2V0TUZBTWVzc2FnZSA9IChcbiAgICBtZmE6IEF1dGhQcm9wc1snbXVsdGlmYWN0b3InXVxuICApOiBzdHJpbmcgfCB1bmRlZmluZWQgPT4ge1xuICAgIGlmIChtZmEgJiYgbWZhLm1vZGUgIT09ICdPRkYnICYmIHR5cGVvZiBtZmEuc21zID09PSAnb2JqZWN0Jykge1xuICAgICAgY29uc3QgbWVzc2FnZSA9IG1mYS5zbXMuc21zTWVzc2FnZSgoKSA9PiBNRkFfU01TX1BMQUNFSE9MREVSUy5DT0RFKTtcbiAgICAgIGlmICghbWVzc2FnZS5pbmNsdWRlcyhNRkFfU01TX1BMQUNFSE9MREVSUy5DT0RFKSkge1xuICAgICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgICBcIkludmFsaWQgTUZBIHNldHRpbmdzLiBQcm9wZXJ0eSAnc21zTWVzc2FnZScgbXVzdCB1dGlsaXplIHRoZSAnY29kZScgcGFyYW1ldGVyIGF0IGxlYXN0IG9uY2UgYXMgYSBwbGFjZWhvbGRlciBmb3IgdGhlIHZlcmlmaWNhdGlvbiBjb2RlLlwiXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICByZXR1cm4gbWVzc2FnZTtcbiAgICB9XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfTtcblxuICAvKipcbiAgICogU2V0dXAgRXh0ZXJuYWwgUHJvdmlkZXJzIChPQXV0aC9PSURDL1NBTUwpIGFuZCByZWxhdGVkIHNldHRpbmdzXG4gICAqIHN1Y2ggYXMgT0F1dGggc2V0dGluZ3MgYW5kIFVzZXIgUG9vbCBEb21haW5zXG4gICAqL1xuICBwcml2YXRlIHNldHVwRXh0ZXJuYWxQcm92aWRlcnMgPSAoXG4gICAgdXNlclBvb2w6IFVzZXJQb29sLFxuICAgIGxvZ2luT3B0aW9uczogQXV0aFByb3BzWydsb2dpbldpdGgnXVxuICApOiBJZGVudGl0eVByb3ZpZGVyU2V0dXBSZXN1bHQgPT4ge1xuICAgIC8qKlxuICAgICAqIElmIGVtYWlsIGlzIGVuYWJsZWQsIGFuZCBpcyB0aGUgb25seSByZXF1aXJlZCBhdHRyaWJ1dGUsIHdlIGFyZSBhYmxlIHRvXG4gICAgICogYXV0b21hdGljYWxseSBtYXAgdGhlIGVtYWlsIGF0dHJpYnV0ZSBmcm9tIGV4dGVybmFsIHByb3ZpZGVycywgZXhjbHVkaW5nIFNBTUwuXG4gICAgICovXG4gICAgY29uc3Qgc2hvdWxkTWFwRW1haWxBdHRyaWJ1dGVzID0gbG9naW5PcHRpb25zLmVtYWlsICYmICFsb2dpbk9wdGlvbnMucGhvbmU7XG4gICAgY29uc3QgcmVzdWx0OiBJZGVudGl0eVByb3ZpZGVyU2V0dXBSZXN1bHQgPSB7XG4gICAgICBvQXV0aE1hcHBpbmdzOiB7fSxcbiAgICAgIHByb3ZpZGVyc0xpc3Q6IFtdLFxuICAgICAgb0F1dGhTZXR0aW5nczoge1xuICAgICAgICBmbG93czogREVGQVVMVFMuT0FVVEhfRkxPV1MsXG4gICAgICB9LFxuICAgIH07XG4gICAgLy8gZXh0ZXJuYWwgcHJvdmlkZXJzXG4gICAgY29uc3QgZXh0ZXJuYWwgPSBsb2dpbk9wdGlvbnMuZXh0ZXJuYWxQcm92aWRlcnM7XG4gICAgaWYgKCFleHRlcm5hbCkge1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG4gICAgLy8gbWFrZSBzdXJlIGxvZ291dC9jYWxsYmFjayB1cmxzIGFyZSBub3QgZW1wdHlcbiAgICBpZiAoZXh0ZXJuYWwubG9nb3V0VXJscyAmJiBleHRlcm5hbC5sb2dvdXRVcmxzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgdGhyb3cgRXJyb3IoXG4gICAgICAgICdZb3UgbXVzdCBkZWZpbmUgbG9nb3V0VXJscyB3aGVuIGNvbmZpZ3VyaW5nIGV4dGVybmFsIGxvZ2luIHByb3ZpZGVycy4nXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAoZXh0ZXJuYWwuY2FsbGJhY2tVcmxzICYmIGV4dGVybmFsLmNhbGxiYWNrVXJscy5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IEVycm9yKFxuICAgICAgICAnWW91IG11c3QgZGVmaW5lIGNhbGxiYWNrVXJscyB3aGVuIGNvbmZpZ3VyaW5nIGV4dGVybmFsIGxvZ2luIHByb3ZpZGVycy4nXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAoZXh0ZXJuYWwuZ29vZ2xlKSB7XG4gICAgICBjb25zdCBnb29nbGVQcm9wcyA9IGV4dGVybmFsLmdvb2dsZTtcbiAgICAgIHJlc3VsdC5nb29nbGUgPSBuZXcgY29nbml0by5Vc2VyUG9vbElkZW50aXR5UHJvdmlkZXJHb29nbGUoXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGAke3RoaXMubmFtZX1Hb29nbGVJZFBgLFxuICAgICAgICB7XG4gICAgICAgICAgdXNlclBvb2wsXG4gICAgICAgICAgY2xpZW50SWQ6IGdvb2dsZVByb3BzLmNsaWVudElkLFxuICAgICAgICAgIGNsaWVudFNlY3JldFZhbHVlOiBnb29nbGVQcm9wcy5jbGllbnRTZWNyZXQsXG4gICAgICAgICAgYXR0cmlidXRlTWFwcGluZzoge1xuICAgICAgICAgICAgLi4uKHNob3VsZE1hcEVtYWlsQXR0cmlidXRlc1xuICAgICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICAgIGVtYWlsOiBQcm92aWRlckF0dHJpYnV0ZS5HT09HTEVfRU1BSUwsXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICA6IHVuZGVmaW5lZCksXG4gICAgICAgICAgICAuLi50aGlzLmNvbnZlcnRUb0NvZ25pdG9BdHRyaWJ1dGVNYXBwaW5nKFxuICAgICAgICAgICAgICBnb29nbGVQcm9wcy5hdHRyaWJ1dGVNYXBwaW5nXG4gICAgICAgICAgICApLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgc2NvcGVzOiBnb29nbGVQcm9wcy5zY29wZXMsXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICByZXN1bHQub0F1dGhNYXBwaW5nc1thdXRoUHJvdmlkZXJzTGlzdC5nb29nbGVdID0gZXh0ZXJuYWwuZ29vZ2xlLmNsaWVudElkO1xuICAgICAgcmVzdWx0LnByb3ZpZGVyc0xpc3QucHVzaCgnR09PR0xFJyk7XG4gICAgfVxuICAgIGlmIChleHRlcm5hbC5mYWNlYm9vaykge1xuICAgICAgcmVzdWx0LmZhY2Vib29rID0gbmV3IGNvZ25pdG8uVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyRmFjZWJvb2soXG4gICAgICAgIHRoaXMsXG4gICAgICAgIGAke3RoaXMubmFtZX1GYWNlYm9va0lEUGAsXG4gICAgICAgIHtcbiAgICAgICAgICB1c2VyUG9vbCxcbiAgICAgICAgICAuLi5leHRlcm5hbC5mYWNlYm9vayxcbiAgICAgICAgICBhdHRyaWJ1dGVNYXBwaW5nOiB7XG4gICAgICAgICAgICAuLi4oc2hvdWxkTWFwRW1haWxBdHRyaWJ1dGVzXG4gICAgICAgICAgICAgID8ge1xuICAgICAgICAgICAgICAgICAgZW1haWw6IFByb3ZpZGVyQXR0cmlidXRlLkZBQ0VCT09LX0VNQUlMLFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgOiB1bmRlZmluZWQpLFxuICAgICAgICAgICAgLi4udGhpcy5jb252ZXJ0VG9Db2duaXRvQXR0cmlidXRlTWFwcGluZyhcbiAgICAgICAgICAgICAgZXh0ZXJuYWwuZmFjZWJvb2suYXR0cmlidXRlTWFwcGluZ1xuICAgICAgICAgICAgKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9XG4gICAgICApO1xuICAgICAgcmVzdWx0Lm9BdXRoTWFwcGluZ3NbYXV0aFByb3ZpZGVyc0xpc3QuZmFjZWJvb2tdID1cbiAgICAgICAgZXh0ZXJuYWwuZmFjZWJvb2suY2xpZW50SWQ7XG4gICAgICByZXN1bHQucHJvdmlkZXJzTGlzdC5wdXNoKCdGQUNFQk9PSycpO1xuICAgIH1cbiAgICBpZiAoZXh0ZXJuYWwubG9naW5XaXRoQW1hem9uKSB7XG4gICAgICByZXN1bHQuYW1hem9uID0gbmV3IGNvZ25pdG8uVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyQW1hem9uKFxuICAgICAgICB0aGlzLFxuICAgICAgICBgJHt0aGlzLm5hbWV9QW1hem9uSURQYCxcbiAgICAgICAge1xuICAgICAgICAgIHVzZXJQb29sLFxuICAgICAgICAgIC4uLmV4dGVybmFsLmxvZ2luV2l0aEFtYXpvbixcbiAgICAgICAgICBhdHRyaWJ1dGVNYXBwaW5nOiB7XG4gICAgICAgICAgICAuLi4oc2hvdWxkTWFwRW1haWxBdHRyaWJ1dGVzXG4gICAgICAgICAgICAgID8ge1xuICAgICAgICAgICAgICAgICAgZW1haWw6IFByb3ZpZGVyQXR0cmlidXRlLkFNQVpPTl9FTUFJTCxcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIDogdW5kZWZpbmVkKSxcbiAgICAgICAgICAgIC4uLnRoaXMuY29udmVydFRvQ29nbml0b0F0dHJpYnV0ZU1hcHBpbmcoXG4gICAgICAgICAgICAgIGV4dGVybmFsLmxvZ2luV2l0aEFtYXpvbi5hdHRyaWJ1dGVNYXBwaW5nXG4gICAgICAgICAgICApLFxuICAgICAgICAgIH0sXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICByZXN1bHQub0F1dGhNYXBwaW5nc1thdXRoUHJvdmlkZXJzTGlzdC5hbWF6b25dID1cbiAgICAgICAgZXh0ZXJuYWwubG9naW5XaXRoQW1hem9uLmNsaWVudElkO1xuICAgICAgcmVzdWx0LnByb3ZpZGVyc0xpc3QucHVzaCgnQU1BWk9OJyk7XG4gICAgfVxuICAgIGlmIChleHRlcm5hbC5zaWduSW5XaXRoQXBwbGUpIHtcbiAgICAgIHJlc3VsdC5hcHBsZSA9IG5ldyBjb2duaXRvLlVzZXJQb29sSWRlbnRpdHlQcm92aWRlckFwcGxlKFxuICAgICAgICB0aGlzLFxuICAgICAgICBgJHt0aGlzLm5hbWV9QXBwbGVJRFBgLFxuICAgICAgICB7XG4gICAgICAgICAgdXNlclBvb2wsXG4gICAgICAgICAgLi4uZXh0ZXJuYWwuc2lnbkluV2l0aEFwcGxlLFxuICAgICAgICAgIGF0dHJpYnV0ZU1hcHBpbmc6IHtcbiAgICAgICAgICAgIC4uLihzaG91bGRNYXBFbWFpbEF0dHJpYnV0ZXNcbiAgICAgICAgICAgICAgPyB7XG4gICAgICAgICAgICAgICAgICBlbWFpbDogUHJvdmlkZXJBdHRyaWJ1dGUuQVBQTEVfRU1BSUwsXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICA6IHVuZGVmaW5lZCksXG4gICAgICAgICAgICAuLi50aGlzLmNvbnZlcnRUb0NvZ25pdG9BdHRyaWJ1dGVNYXBwaW5nKFxuICAgICAgICAgICAgICBleHRlcm5hbC5zaWduSW5XaXRoQXBwbGUuYXR0cmlidXRlTWFwcGluZ1xuICAgICAgICAgICAgKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9XG4gICAgICApO1xuICAgICAgcmVzdWx0Lm9BdXRoTWFwcGluZ3NbYXV0aFByb3ZpZGVyc0xpc3QuYXBwbGVdID1cbiAgICAgICAgZXh0ZXJuYWwuc2lnbkluV2l0aEFwcGxlLmNsaWVudElkO1xuICAgICAgcmVzdWx0LnByb3ZpZGVyc0xpc3QucHVzaCgnQVBQTEUnKTtcbiAgICB9XG4gICAgaWYgKGV4dGVybmFsLm9pZGMgJiYgZXh0ZXJuYWwub2lkYy5sZW5ndGggPiAwKSB7XG4gICAgICByZXN1bHQub2lkYyA9IFtdO1xuICAgICAgZXh0ZXJuYWwub2lkYy5mb3JFYWNoKChwcm92aWRlciwgaW5kZXgpID0+IHtcbiAgICAgICAgY29uc3QgcmVxdWVzdE1ldGhvZCA9XG4gICAgICAgICAgcHJvdmlkZXIuYXR0cmlidXRlUmVxdWVzdE1ldGhvZCA9PT0gdW5kZWZpbmVkXG4gICAgICAgICAgICA/ICdHRVQnIC8vIGRlZmF1bHQgaWYgbm90IGRlZmluZWRcbiAgICAgICAgICAgIDogcHJvdmlkZXIuYXR0cmlidXRlUmVxdWVzdE1ldGhvZDtcbiAgICAgICAgY29uc3QgZ2VuZXJhdGVkUHJvdmlkZXIgPSBuZXcgY29nbml0by5Vc2VyUG9vbElkZW50aXR5UHJvdmlkZXJPaWRjKFxuICAgICAgICAgIHRoaXMsXG4gICAgICAgICAgYCR7dGhpcy5uYW1lfSR7cHJvdmlkZXIubmFtZSA/PyBpbmRleH1PaWRjSURQYCxcbiAgICAgICAgICB7XG4gICAgICAgICAgICB1c2VyUG9vbCxcbiAgICAgICAgICAgIGF0dHJpYnV0ZVJlcXVlc3RNZXRob2Q6XG4gICAgICAgICAgICAgIHJlcXVlc3RNZXRob2QgPT09ICdHRVQnXG4gICAgICAgICAgICAgICAgPyBPaWRjQXR0cmlidXRlUmVxdWVzdE1ldGhvZC5HRVRcbiAgICAgICAgICAgICAgICA6IE9pZGNBdHRyaWJ1dGVSZXF1ZXN0TWV0aG9kLlBPU1QsXG4gICAgICAgICAgICBjbGllbnRJZDogcHJvdmlkZXIuY2xpZW50SWQsXG4gICAgICAgICAgICBjbGllbnRTZWNyZXQ6IHByb3ZpZGVyLmNsaWVudFNlY3JldCxcbiAgICAgICAgICAgIGVuZHBvaW50czogcHJvdmlkZXIuZW5kcG9pbnRzLFxuICAgICAgICAgICAgaWRlbnRpZmllcnM6IHByb3ZpZGVyLmlkZW50aWZpZXJzLFxuICAgICAgICAgICAgaXNzdWVyVXJsOiBwcm92aWRlci5pc3N1ZXJVcmwsXG4gICAgICAgICAgICBuYW1lOiBwcm92aWRlci5uYW1lLFxuICAgICAgICAgICAgc2NvcGVzOiBwcm92aWRlci5zY29wZXMsXG4gICAgICAgICAgICBhdHRyaWJ1dGVNYXBwaW5nOiB7XG4gICAgICAgICAgICAgIC4uLihzaG91bGRNYXBFbWFpbEF0dHJpYnV0ZXNcbiAgICAgICAgICAgICAgICA/IHtcbiAgICAgICAgICAgICAgICAgICAgZW1haWw6IHtcbiAgICAgICAgICAgICAgICAgICAgICBhdHRyaWJ1dGVOYW1lOiAnZW1haWwnLFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIDogdW5kZWZpbmVkKSxcbiAgICAgICAgICAgICAgLi4udGhpcy5jb252ZXJ0VG9Db2duaXRvQXR0cmlidXRlTWFwcGluZyhcbiAgICAgICAgICAgICAgICBwcm92aWRlci5hdHRyaWJ1dGVNYXBwaW5nXG4gICAgICAgICAgICAgICksXG4gICAgICAgICAgICB9LFxuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgICAgcmVzdWx0Lm9pZGM/LnB1c2goZ2VuZXJhdGVkUHJvdmlkZXIpO1xuICAgICAgICByZXN1bHQucHJvdmlkZXJzTGlzdC5wdXNoKGdlbmVyYXRlZFByb3ZpZGVyLnByb3ZpZGVyTmFtZSk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgaWYgKGV4dGVybmFsLnNhbWwpIHtcbiAgICAgIGNvbnN0IHNhbWwgPSBleHRlcm5hbC5zYW1sO1xuICAgICAgcmVzdWx0LnNhbWwgPSBuZXcgY29nbml0by5Vc2VyUG9vbElkZW50aXR5UHJvdmlkZXJTYW1sKFxuICAgICAgICB0aGlzLFxuICAgICAgICBgJHt0aGlzLm5hbWV9U2FtbElEUGAsXG4gICAgICAgIHtcbiAgICAgICAgICB1c2VyUG9vbCxcbiAgICAgICAgICBhdHRyaWJ1dGVNYXBwaW5nOiB0aGlzLmNvbnZlcnRUb0NvZ25pdG9BdHRyaWJ1dGVNYXBwaW5nKFxuICAgICAgICAgICAgc2FtbC5hdHRyaWJ1dGVNYXBwaW5nXG4gICAgICAgICAgKSxcbiAgICAgICAgICBpZGVudGlmaWVyczogc2FtbC5pZGVudGlmaWVycyxcbiAgICAgICAgICBpZHBTaWdub3V0OiBzYW1sLmlkcFNpZ25vdXQsXG4gICAgICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgICAgIG1ldGFkYXRhQ29udGVudDogc2FtbC5tZXRhZGF0YS5tZXRhZGF0YUNvbnRlbnQsXG4gICAgICAgICAgICBtZXRhZGF0YVR5cGU6XG4gICAgICAgICAgICAgIHNhbWwubWV0YWRhdGEubWV0YWRhdGFUeXBlID09PSAnRklMRSdcbiAgICAgICAgICAgICAgICA/IFVzZXJQb29sSWRlbnRpdHlQcm92aWRlclNhbWxNZXRhZGF0YVR5cGUuRklMRVxuICAgICAgICAgICAgICAgIDogVXNlclBvb2xJZGVudGl0eVByb3ZpZGVyU2FtbE1ldGFkYXRhVHlwZS5VUkwsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBuYW1lOiBzYW1sLm5hbWUsXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICByZXN1bHQucHJvdmlkZXJzTGlzdC5wdXNoKCdTQU1MJyk7XG4gICAgfVxuXG4gICAgLy8gQWx3YXlzIGdlbmVyYXRlIGEgZG9tYWluIHByZWZpeCBpZiBleHRlcm5hbCBwcm92aWRlciBpcyBjb25maWd1cmVkXG4gICAgaWYgKHRoaXMuZG9tYWluUHJlZml4KSB7XG4gICAgICB0aGlzLnVzZXJQb29sLmFkZERvbWFpbihgJHt0aGlzLm5hbWV9VXNlclBvb2xEb21haW5gLCB7XG4gICAgICAgIGNvZ25pdG9Eb21haW46IHsgZG9tYWluUHJlZml4OiB0aGlzLmRvbWFpblByZWZpeCB9LFxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ0NvZ25pdG8gRG9tYWluIFByZWZpeCBpcyBtaXNzaW5nIHdoZW4gZXh0ZXJuYWwgcHJvdmlkZXJzIGFyZSBjb25maWd1cmVkLidcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gb2F1dGggc2V0dGluZ3MgZm9yIHRoZSBVc2VyUG9vbCBjbGllbnRcbiAgICByZXN1bHQub0F1dGhTZXR0aW5ncyA9IHtcbiAgICAgIGNhbGxiYWNrVXJsczogZXh0ZXJuYWwuY2FsbGJhY2tVcmxzLFxuICAgICAgbG9nb3V0VXJsczogZXh0ZXJuYWwubG9nb3V0VXJscyxcbiAgICAgIHNjb3BlczogZXh0ZXJuYWwuc2NvcGVzXG4gICAgICAgID8gdGhpcy5nZXRPQXV0aFNjb3BlcyhleHRlcm5hbC5zY29wZXMpXG4gICAgICAgIDogREVGQVVMVF9PQVVUSF9TQ09QRVMsXG4gICAgICBmbG93czogREVGQVVMVFMuT0FVVEhfRkxPV1MsXG4gICAgfTtcblxuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIENvbnZlcnRzIHRoZSBzaW1wbGlmaWVkIG1hcHBpbmcgdHlwZSB0byBjb2duaXRvLkF0dHJpYnV0ZU1hcHBpbmcuXG4gICAqIEBwYXJhbSBtYXBwaW5nIHRoZSBBdHRyaWJ1dGVNYXBwaW5nIHRvIGNvbnZlcnQgdG8gYSBjb2duaXRvLkF0dHJpYnV0ZU1hcHBpbmdcbiAgICogQHJldHVybnMgY29nbml0by5BdHRyaWJ1dGVNYXBwaW5nXG4gICAqL1xuICBwcml2YXRlIGNvbnZlcnRUb0NvZ25pdG9BdHRyaWJ1dGVNYXBwaW5nID0gKFxuICAgIG1hcHBpbmc/OiBBdHRyaWJ1dGVNYXBwaW5nXG4gICk6IGNvZ25pdG8uQXR0cmlidXRlTWFwcGluZyB8IHVuZGVmaW5lZCA9PiB7XG4gICAgaWYgKCFtYXBwaW5nKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICBjb25zdCByZXN1bHQ6IFJlY29yZDxcbiAgICAgIHN0cmluZyxcbiAgICAgIHwgUHJvdmlkZXJBdHRyaWJ1dGVcbiAgICAgIHwge1xuICAgICAgICAgIFtrZXk6IHN0cmluZ106IFByb3ZpZGVyQXR0cmlidXRlO1xuICAgICAgICB9XG4gICAgPiA9IHt9O1xuICAgIGZvciAoY29uc3QgW2F0dHJOYW1lLCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMobWFwcGluZykpIHtcbiAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHJlc3VsdFthdHRyTmFtZV0gPSB7XG4gICAgICAgICAgYXR0cmlidXRlTmFtZTogdmFsdWUsXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJiBhdHRyTmFtZSA9PT0gJ2N1c3RvbScpIHtcbiAgICAgICAgLy8gZGVhbGluZyB3aXRoIGN1c3RvbSBhdHRyaWJ1dGVzXG4gICAgICAgIGNvbnN0IGN1c3RvbUF0dHJpYnV0ZXM6IFJlY29yZDxzdHJpbmcsIFByb3ZpZGVyQXR0cmlidXRlPiA9IHt9O1xuICAgICAgICBmb3IgKGNvbnN0IFtjdXN0b21LZXksIGF0dHJOYW1lXSBvZiBPYmplY3QuZW50cmllcyh2YWx1ZSkpIHtcbiAgICAgICAgICBjdXN0b21BdHRyaWJ1dGVzW2N1c3RvbUtleV0gPSB7XG4gICAgICAgICAgICBhdHRyaWJ1dGVOYW1lOiBhdHRyTmFtZSxcbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIHJlc3VsdFthdHRyTmFtZV0gPSBjdXN0b21BdHRyaWJ1dGVzO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9O1xuICAvKipcbiAgICogQ29udmVydCBzY29wZXMgZnJvbSBzdHJpbmcgbGlzdCB0byBPQXV0aFNjb3Blcy5cbiAgICogQHBhcmFtIHNjb3BlcyAtIHNjb3BlIGxpc3RcbiAgICogQHJldHVybnMgY29nbml0byBPQXV0aFNjb3Blc1xuICAgKi9cbiAgcHJpdmF0ZSBnZXRPQXV0aFNjb3BlcyA9IChcbiAgICBzY29wZXM6IEV4dGVybmFsUHJvdmlkZXJPcHRpb25zWydzY29wZXMnXVxuICApOiBjb2duaXRvLk9BdXRoU2NvcGVbXSA9PiB7XG4gICAgaWYgKHNjb3BlcyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIGNvbnN0IHJlc3VsdDogY29nbml0by5PQXV0aFNjb3BlW10gPSBbXTtcbiAgICBmb3IgKGNvbnN0IHNjb3BlIG9mIHNjb3Blcykge1xuICAgICAgcmVzdWx0LnB1c2goY29nbml0by5PQXV0aFNjb3BlW3Njb3BlXSk7XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIFN0b3JlcyBhdXRoIG91dHB1dCB1c2luZyB0aGUgcHJvdmlkZWQgc3RyYXRlZ3lcbiAgICovXG4gIHByaXZhdGUgc3RvcmVPdXRwdXQgPSAoXG4gICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5OiBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5PEF1dGhPdXRwdXQ+ID0gbmV3IFN0YWNrTWV0YWRhdGFCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5KFxuICAgICAgU3RhY2sub2YodGhpcylcbiAgICApXG4gICk6IHZvaWQgPT4ge1xuICAgIGNvbnN0IG91dHB1dDogQXV0aE91dHB1dFsncGF5bG9hZCddID0ge1xuICAgICAgdXNlclBvb2xJZDogdGhpcy5yZXNvdXJjZXMudXNlclBvb2wudXNlclBvb2xJZCxcbiAgICAgIHdlYkNsaWVudElkOiB0aGlzLnJlc291cmNlcy51c2VyUG9vbENsaWVudC51c2VyUG9vbENsaWVudElkLFxuICAgICAgaWRlbnRpdHlQb29sSWQ6IHRoaXMucmVzb3VyY2VzLmNmblJlc291cmNlcy5jZm5JZGVudGl0eVBvb2wucmVmLFxuICAgICAgYXV0aFJlZ2lvbjogU3RhY2sub2YodGhpcykucmVnaW9uLFxuICAgICAgYWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzOlxuICAgICAgICB0aGlzLnJlc291cmNlcy5jZm5SZXNvdXJjZXMuY2ZuSWRlbnRpdHlQb29sXG4gICAgICAgICAgLmFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcyA9PT0gdHJ1ZVxuICAgICAgICAgID8gJ3RydWUnXG4gICAgICAgICAgOiAnZmFsc2UnLFxuICAgIH07XG4gICAgaWYgKHRoaXMuY29tcHV0ZWRVc2VyUG9vbFByb3BzLnN0YW5kYXJkQXR0cmlidXRlcykge1xuICAgICAgY29uc3Qgc2lnbnVwQXR0cmlidXRlcyA9IE9iamVjdC5lbnRyaWVzKFxuICAgICAgICB0aGlzLmNvbXB1dGVkVXNlclBvb2xQcm9wcy5zdGFuZGFyZEF0dHJpYnV0ZXNcbiAgICAgICkucmVkdWNlKChhY2M6IHN0cmluZ1tdLCBbYXR0cmlidXRlTmFtZSwgYXR0cmlidXRlXSkgPT4ge1xuICAgICAgICBpZiAoYXR0cmlidXRlPy5yZXF1aXJlZCkge1xuICAgICAgICAgIGNvbnN0IHRyZWF0ZWRBdHRyaWJ1dGVOYW1lID0gY29yZUF0dHJpYnV0ZU5hbWVNYXAuZmluZChcbiAgICAgICAgICAgICh7IHN0YW5kYXJkQXR0cmlidXRlTmFtZSB9KSA9PlxuICAgICAgICAgICAgICBzdGFuZGFyZEF0dHJpYnV0ZU5hbWUgPT09IGF0dHJpYnV0ZU5hbWVcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgaWYgKHRyZWF0ZWRBdHRyaWJ1dGVOYW1lKSB7XG4gICAgICAgICAgICByZXR1cm4gW1xuICAgICAgICAgICAgICAuLi5hY2MsXG4gICAgICAgICAgICAgIHRyZWF0ZWRBdHRyaWJ1dGVOYW1lLnVzZXJwb29sQXR0cmlidXRlTmFtZS50b0xvd2VyQ2FzZSgpLFxuICAgICAgICAgICAgXTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgIH0sIFtdKTtcbiAgICAgIG91dHB1dC5zaWdudXBBdHRyaWJ1dGVzID0gSlNPTi5zdHJpbmdpZnkoc2lnbnVwQXR0cmlidXRlcyk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuY29tcHV0ZWRVc2VyUG9vbFByb3BzLnNpZ25JbkFsaWFzZXMpIHtcbiAgICAgIGNvbnN0IHVzZXJuYW1lQXR0cmlidXRlcyA9IFtdO1xuICAgICAgaWYgKHRoaXMuY29tcHV0ZWRVc2VyUG9vbFByb3BzLnNpZ25JbkFsaWFzZXMuZW1haWwpIHtcbiAgICAgICAgdXNlcm5hbWVBdHRyaWJ1dGVzLnB1c2goJ2VtYWlsJyk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5jb21wdXRlZFVzZXJQb29sUHJvcHMuc2lnbkluQWxpYXNlcy5waG9uZSkge1xuICAgICAgICB1c2VybmFtZUF0dHJpYnV0ZXMucHVzaCgncGhvbmVfbnVtYmVyJyk7XG4gICAgICB9XG4gICAgICBpZiAoXG4gICAgICAgIHRoaXMuY29tcHV0ZWRVc2VyUG9vbFByb3BzLnNpZ25JbkFsaWFzZXMucHJlZmVycmVkVXNlcm5hbWUgfHxcbiAgICAgICAgdGhpcy5jb21wdXRlZFVzZXJQb29sUHJvcHMuc2lnbkluQWxpYXNlcy51c2VybmFtZVxuICAgICAgKSB7XG4gICAgICAgIHVzZXJuYW1lQXR0cmlidXRlcy5wdXNoKCdwcmVmZXJyZWRfdXNlcm5hbWUnKTtcbiAgICAgIH1cbiAgICAgIGlmICh1c2VybmFtZUF0dHJpYnV0ZXMubGVuZ3RoID4gMCkge1xuICAgICAgICBvdXRwdXQudXNlcm5hbWVBdHRyaWJ1dGVzID0gSlNPTi5zdHJpbmdpZnkodXNlcm5hbWVBdHRyaWJ1dGVzKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodGhpcy5jb21wdXRlZFVzZXJQb29sUHJvcHMuYXV0b1ZlcmlmeSkge1xuICAgICAgY29uc3QgdmVyaWZpY2F0aW9uTWVjaGFuaXNtcyA9IFtdO1xuICAgICAgaWYgKHRoaXMuY29tcHV0ZWRVc2VyUG9vbFByb3BzLmF1dG9WZXJpZnkuZW1haWwpIHtcbiAgICAgICAgdmVyaWZpY2F0aW9uTWVjaGFuaXNtcy5wdXNoKCdlbWFpbCcpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuY29tcHV0ZWRVc2VyUG9vbFByb3BzLmF1dG9WZXJpZnkucGhvbmUpIHtcbiAgICAgICAgdmVyaWZpY2F0aW9uTWVjaGFuaXNtcy5wdXNoKCdwaG9uZV9udW1iZXInKTtcbiAgICAgIH1cbiAgICAgIGlmICh2ZXJpZmljYXRpb25NZWNoYW5pc21zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgb3V0cHV0LnZlcmlmaWNhdGlvbk1lY2hhbmlzbXMgPSBKU09OLnN0cmluZ2lmeSh2ZXJpZmljYXRpb25NZWNoYW5pc21zKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodGhpcy5jb21wdXRlZFVzZXJQb29sUHJvcHMucGFzc3dvcmRQb2xpY3kpIHtcbiAgICAgIG91dHB1dC5wYXNzd29yZFBvbGljeU1pbkxlbmd0aCA9XG4gICAgICAgIHRoaXMuY29tcHV0ZWRVc2VyUG9vbFByb3BzLnBhc3N3b3JkUG9saWN5Lm1pbkxlbmd0aD8udG9TdHJpbmcoKTtcblxuICAgICAgY29uc3QgcmVxdWlyZW1lbnRzID0gW107XG4gICAgICBpZiAodGhpcy5jb21wdXRlZFVzZXJQb29sUHJvcHMucGFzc3dvcmRQb2xpY3kucmVxdWlyZURpZ2l0cykge1xuICAgICAgICByZXF1aXJlbWVudHMucHVzaCgnUkVRVUlSRVNfTlVNQkVSUycpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuY29tcHV0ZWRVc2VyUG9vbFByb3BzLnBhc3N3b3JkUG9saWN5LnJlcXVpcmVMb3dlcmNhc2UpIHtcbiAgICAgICAgcmVxdWlyZW1lbnRzLnB1c2goJ1JFUVVJUkVTX0xPV0VSQ0FTRScpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuY29tcHV0ZWRVc2VyUG9vbFByb3BzLnBhc3N3b3JkUG9saWN5LnJlcXVpcmVVcHBlcmNhc2UpIHtcbiAgICAgICAgcmVxdWlyZW1lbnRzLnB1c2goJ1JFUVVJUkVTX1VQUEVSQ0FTRScpO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMuY29tcHV0ZWRVc2VyUG9vbFByb3BzLnBhc3N3b3JkUG9saWN5LnJlcXVpcmVTeW1ib2xzKSB7XG4gICAgICAgIHJlcXVpcmVtZW50cy5wdXNoKCdSRVFVSVJFU19TWU1CT0xTJyk7XG4gICAgICB9XG5cbiAgICAgIGlmIChyZXF1aXJlbWVudHMubGVuZ3RoID4gMCkge1xuICAgICAgICBvdXRwdXQucGFzc3dvcmRQb2xpY3lSZXF1aXJlbWVudHMgPSBKU09OLnN0cmluZ2lmeShyZXF1aXJlbWVudHMpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0aGlzLmNvbXB1dGVkVXNlclBvb2xQcm9wcy5tZmEpIHtcbiAgICAgIG91dHB1dC5tZmFDb25maWd1cmF0aW9uID0gdGhpcy5jb21wdXRlZFVzZXJQb29sUHJvcHMubWZhO1xuXG4gICAgICBjb25zdCBtZmFUeXBlcyA9IFtdO1xuICAgICAgaWYgKHRoaXMuY29tcHV0ZWRVc2VyUG9vbFByb3BzLm1mYVNlY29uZEZhY3Rvcj8ub3RwKSB7XG4gICAgICAgIG1mYVR5cGVzLnB1c2goJ1RPVFAnKTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLmNvbXB1dGVkVXNlclBvb2xQcm9wcy5tZmFTZWNvbmRGYWN0b3I/LnNtcykge1xuICAgICAgICBtZmFUeXBlcy5wdXNoKCdTTVMnKTtcbiAgICAgIH1cbiAgICAgIGlmIChtZmFUeXBlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIG91dHB1dC5tZmFUeXBlcyA9IEpTT04uc3RyaW5naWZ5KG1mYVR5cGVzKTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3Qgb0F1dGhNYXBwaW5ncyA9IHRoaXMucHJvdmlkZXJTZXR1cFJlc3VsdC5vQXV0aE1hcHBpbmdzO1xuICAgIGlmIChvQXV0aE1hcHBpbmdzW2F1dGhQcm92aWRlcnNMaXN0LmFtYXpvbl0pIHtcbiAgICAgIG91dHB1dC5hbWF6b25DbGllbnRJZCA9IG9BdXRoTWFwcGluZ3NbYXV0aFByb3ZpZGVyc0xpc3QuYW1hem9uXTtcbiAgICB9XG4gICAgaWYgKG9BdXRoTWFwcGluZ3NbYXV0aFByb3ZpZGVyc0xpc3QuZmFjZWJvb2tdKSB7XG4gICAgICBvdXRwdXQuZmFjZWJvb2tDbGllbnRJZCA9IG9BdXRoTWFwcGluZ3NbYXV0aFByb3ZpZGVyc0xpc3QuZmFjZWJvb2tdO1xuICAgIH1cbiAgICBpZiAob0F1dGhNYXBwaW5nc1thdXRoUHJvdmlkZXJzTGlzdC5nb29nbGVdKSB7XG4gICAgICBvdXRwdXQuZ29vZ2xlQ2xpZW50SWQgPSBvQXV0aE1hcHBpbmdzW2F1dGhQcm92aWRlcnNMaXN0Lmdvb2dsZV07XG4gICAgfVxuICAgIGlmIChvQXV0aE1hcHBpbmdzW2F1dGhQcm92aWRlcnNMaXN0LmFwcGxlXSkge1xuICAgICAgb3V0cHV0LmFwcGxlQ2xpZW50SWQgPSBvQXV0aE1hcHBpbmdzW2F1dGhQcm92aWRlcnNMaXN0LmFwcGxlXTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5wcm92aWRlclNldHVwUmVzdWx0LnByb3ZpZGVyc0xpc3QubGVuZ3RoID4gMCkge1xuICAgICAgb3V0cHV0LnNvY2lhbFByb3ZpZGVycyA9IEpTT04uc3RyaW5naWZ5KFxuICAgICAgICB0aGlzLnByb3ZpZGVyU2V0dXBSZXN1bHQucHJvdmlkZXJzTGlzdFxuICAgICAgKTtcbiAgICB9XG4gICAgLy8gaWYgY2FsbGJhY2sgVVJMcyBhcmUgY29uZmlndXJlZCwgd2UgbXVzdCBleHBvc2UgdGhlIG9hdXRoIHNldHRpbmdzIHRvIHRoZSBvdXRwdXRcbiAgICBpZiAoXG4gICAgICB0aGlzLnByb3ZpZGVyU2V0dXBSZXN1bHQub0F1dGhTZXR0aW5ncyAmJlxuICAgICAgdGhpcy5wcm92aWRlclNldHVwUmVzdWx0Lm9BdXRoU2V0dGluZ3MuY2FsbGJhY2tVcmxzXG4gICAgKSB7XG4gICAgICBjb25zdCBvQXV0aFNldHRpbmdzID0gdGhpcy5wcm92aWRlclNldHVwUmVzdWx0Lm9BdXRoU2V0dGluZ3M7XG4gICAgICBpZiAodGhpcy5kb21haW5QcmVmaXgpIHtcbiAgICAgICAgb3V0cHV0Lm9hdXRoQ29nbml0b0RvbWFpbiA9IGAke3RoaXMuZG9tYWluUHJlZml4fS5hdXRoLiR7XG4gICAgICAgICAgU3RhY2sub2YodGhpcykucmVnaW9uXG4gICAgICAgIH0uYW1hem9uY29nbml0by5jb21gO1xuICAgICAgfVxuXG4gICAgICBvdXRwdXQub2F1dGhTY29wZSA9IEpTT04uc3RyaW5naWZ5KFxuICAgICAgICBvQXV0aFNldHRpbmdzLnNjb3Blcz8ubWFwKChzKSA9PiBzLnNjb3BlTmFtZSkgPz8gW11cbiAgICAgICk7XG4gICAgICBvdXRwdXQub2F1dGhSZWRpcmVjdFNpZ25JbiA9IG9BdXRoU2V0dGluZ3MuY2FsbGJhY2tVcmxzXG4gICAgICAgID8gb0F1dGhTZXR0aW5ncy5jYWxsYmFja1VybHMuam9pbignLCcpXG4gICAgICAgIDogJyc7XG4gICAgICBvdXRwdXQub2F1dGhSZWRpcmVjdFNpZ25PdXQgPSBvQXV0aFNldHRpbmdzLmxvZ291dFVybHNcbiAgICAgICAgPyBvQXV0aFNldHRpbmdzLmxvZ291dFVybHMuam9pbignLCcpXG4gICAgICAgIDogJyc7XG4gICAgICBvdXRwdXQub2F1dGhDbGllbnRJZCA9IHRoaXMucmVzb3VyY2VzLnVzZXJQb29sQ2xpZW50LnVzZXJQb29sQ2xpZW50SWQ7XG4gICAgICBvdXRwdXQub2F1dGhSZXNwb25zZVR5cGUgPSAnY29kZSc7XG4gICAgfVxuXG4gICAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5LmFkZEJhY2tlbmRPdXRwdXRFbnRyeShhdXRoT3V0cHV0S2V5LCB7XG4gICAgICB2ZXJzaW9uOiAnMScsXG4gICAgICBwYXlsb2FkOiBvdXRwdXQsXG4gICAgfSk7XG4gIH07XG59XG4iXX0=