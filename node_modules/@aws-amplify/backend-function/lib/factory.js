import { Construct } from 'constructs';
import { NodejsFunction, OutputFormat } from 'aws-cdk-lib/aws-lambda-nodejs';
import * as path from 'path';
import { getCallerDirectory } from './get_caller_directory.js';
import { Duration, Stack, Tags } from 'aws-cdk-lib';
import { Runtime } from 'aws-cdk-lib/aws-lambda';
import { createRequire } from 'module';
import { FunctionEnvironmentTranslator } from './function_env_translator.js';
import { readFileSync } from 'fs';
import { EOL } from 'os';
import { functionOutputKey, } from '@aws-amplify/backend-output-schemas';
import { FunctionEnvironmentTypeGenerator } from './function_env_type_generator.js';
import { AttributionMetadataStorage } from '@aws-amplify/backend-output-storage';
import { fileURLToPath } from 'url';
import { AmplifyUserError, TagName } from '@aws-amplify/platform-core';
const functionStackType = 'function-Lambda';
/**
 * Entry point for defining a function in the Amplify ecosystem
 */
export const defineFunction = (props = {}) => new FunctionFactory(props, new Error().stack);
/**
 * Create Lambda functions in the context of an Amplify backend definition
 */
class FunctionFactory {
    props;
    callerStack;
    generator;
    /**
     * Create a new AmplifyFunctionFactory
     */
    constructor(props, callerStack) {
        this.props = props;
        this.callerStack = callerStack;
    }
    /**
     * Creates an instance of AmplifyFunction within the provided Amplify context
     */
    getInstance = ({ constructContainer, outputStorageStrategy, resourceNameValidator, }) => {
        if (!this.generator) {
            this.generator = new FunctionGenerator(this.hydrateDefaults(resourceNameValidator), outputStorageStrategy);
        }
        return constructContainer.getOrCompute(this.generator);
    };
    hydrateDefaults = (resourceNameValidator) => {
        const name = this.resolveName();
        resourceNameValidator?.validate(name);
        return {
            name,
            entry: this.resolveEntry(),
            timeoutSeconds: this.resolveTimeout(),
            memoryMB: this.resolveMemory(),
            environment: this.props.environment ?? {},
            runtime: this.resolveRuntime(),
        };
    };
    resolveName = () => {
        // If name is set explicitly, use that
        if (this.props.name) {
            return this.props.name;
        }
        // If entry is set, use the basename of the entry path
        if (this.props.entry) {
            return path.parse(this.props.entry).name;
        }
        // Otherwise, use the directory name where the function is defined
        return path.basename(getCallerDirectory(this.callerStack));
    };
    resolveEntry = () => {
        // if entry is not set, default to handler.ts
        if (!this.props.entry) {
            return path.join(getCallerDirectory(this.callerStack), 'handler.ts');
        }
        // if entry is absolute use that
        if (path.isAbsolute(this.props.entry)) {
            return this.props.entry;
        }
        // if entry is relative, compute with respect to the caller directory
        return path.join(getCallerDirectory(this.callerStack), this.props.entry);
    };
    resolveTimeout = () => {
        const timeoutMin = 1;
        const timeoutMax = 60 * 15; // 15 minutes in seconds
        const timeoutDefault = 3;
        if (this.props.timeoutSeconds === undefined) {
            return timeoutDefault;
        }
        if (!isWholeNumberBetweenInclusive(this.props.timeoutSeconds, timeoutMin, timeoutMax)) {
            throw new Error(`timeoutSeconds must be a whole number between ${timeoutMin} and ${timeoutMax} inclusive`);
        }
        return this.props.timeoutSeconds;
    };
    resolveMemory = () => {
        const memoryMin = 128;
        const memoryMax = 10240;
        const memoryDefault = 512;
        if (this.props.memoryMB === undefined) {
            return memoryDefault;
        }
        if (!isWholeNumberBetweenInclusive(this.props.memoryMB, memoryMin, memoryMax)) {
            throw new Error(`memoryMB must be a whole number between ${memoryMin} and ${memoryMax} inclusive`);
        }
        return this.props.memoryMB;
    };
    resolveRuntime = () => {
        const runtimeDefault = 18;
        // if runtime is not set, default to the oldest LTS
        if (!this.props.runtime) {
            return runtimeDefault;
        }
        if (!(this.props.runtime in nodeVersionMap)) {
            throw new Error(`runtime must be one of the following: ${Object.keys(nodeVersionMap).join(', ')}`);
        }
        return this.props.runtime;
    };
}
class FunctionGenerator {
    props;
    outputStorageStrategy;
    resourceGroupName = 'function';
    constructor(props, outputStorageStrategy) {
        this.props = props;
        this.outputStorageStrategy = outputStorageStrategy;
    }
    generateContainerEntry = ({ scope, backendSecretResolver, }) => {
        return new AmplifyFunction(scope, this.props.name, this.props, backendSecretResolver, this.outputStorageStrategy);
    };
}
class AmplifyFunction extends Construct {
    resources;
    functionEnvironmentTranslator;
    constructor(scope, id, props, backendSecretResolver, outputStorageStrategy) {
        super(scope, id);
        const runtime = nodeVersionMap[props.runtime];
        const require = createRequire(import.meta.url);
        const shims = runtime === Runtime.NODEJS_16_X
            ? []
            : [require.resolve('./lambda-shims/cjs_shim')];
        const ssmResolverFile = runtime === Runtime.NODEJS_16_X
            ? require.resolve('./lambda-shims/resolve_ssm_params_sdk_v2') // use aws cdk v2 in node 16
            : require.resolve('./lambda-shims/resolve_ssm_params');
        const invokeSsmResolverFile = require.resolve('./lambda-shims/invoke_ssm_shim');
        /**
         * This code concatenates the contents of the ssm resolver and invoker into a single line that can be used as the esbuild banner content
         * This banner is responsible for resolving the customer's SSM parameters at runtime
         */
        const bannerCode = readFileSync(ssmResolverFile, 'utf-8')
            .concat(readFileSync(invokeSsmResolverFile, 'utf-8'))
            .split(new RegExp(`${EOL}|\n|\r`, 'g'))
            .map((line) => line.replace(/\/\/.*$/, '')) // strip out inline comments because the banner is going to be flattened into a single line
            .join('');
        const functionEnvironmentTypeGenerator = new FunctionEnvironmentTypeGenerator(id);
        // esbuild runs as part of the NodejsFunction constructor, so we eagerly generate the process env shim without types so it can be included in the function bundle.
        // This will be overwritten with the typed file at the end of synthesis
        functionEnvironmentTypeGenerator.generateProcessEnvShim();
        let functionLambda;
        try {
            functionLambda = new NodejsFunction(scope, `${id}-lambda`, {
                entry: props.entry,
                timeout: Duration.seconds(props.timeoutSeconds),
                memorySize: props.memoryMB,
                runtime: nodeVersionMap[props.runtime],
                bundling: {
                    format: OutputFormat.ESM,
                    banner: bannerCode,
                    inject: shims,
                    loader: {
                        '.node': 'file',
                    },
                },
            });
        }
        catch (error) {
            throw new AmplifyUserError('NodeJSFunctionConstructInitializationError', {
                message: 'Failed to instantiate nodejs function construct',
                resolution: 'See the underlying error message for more details.',
            }, error);
        }
        Tags.of(functionLambda).add(TagName.FRIENDLY_NAME, id);
        this.functionEnvironmentTranslator = new FunctionEnvironmentTranslator(functionLambda, props.environment, backendSecretResolver, functionEnvironmentTypeGenerator);
        this.resources = {
            lambda: functionLambda,
            cfnResources: {
                cfnFunction: functionLambda.node.findChild('Resource'),
            },
        };
        this.storeOutput(outputStorageStrategy);
        new AttributionMetadataStorage().storeAttributionMetadata(Stack.of(this), functionStackType, fileURLToPath(new URL('../package.json', import.meta.url)));
    }
    getResourceAccessAcceptor = () => ({
        identifier: `${this.node.id}LambdaResourceAccessAcceptor`,
        acceptResourceAccess: (policy, ssmEnvironmentEntries) => {
            const role = this.resources.lambda.role;
            if (!role) {
                // This should never happen since we are using the Function L2 construct
                throw new Error('No execution role found to attach lambda permissions to');
            }
            policy.attachToRole(role);
            ssmEnvironmentEntries.forEach(({ name, path }) => {
                this.functionEnvironmentTranslator.addSsmEnvironmentEntry(name, path);
            });
        },
    });
    /**
     * Store storage outputs using provided strategy
     */
    storeOutput = (outputStorageStrategy) => {
        outputStorageStrategy.appendToBackendOutputList(functionOutputKey, {
            version: '1',
            payload: {
                definedFunctions: this.resources.lambda.functionName,
            },
        });
    };
}
const isWholeNumberBetweenInclusive = (test, min, max) => min <= test && test <= max && test % 1 === 0;
const nodeVersionMap = {
    16: Runtime.NODEJS_16_X,
    18: Runtime.NODEJS_18_X,
    20: Runtime.NODEJS_20_X,
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9mYWN0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQWNBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDdkMsT0FBTyxFQUFFLGNBQWMsRUFBRSxZQUFZLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUM3RSxPQUFPLEtBQUssSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUM3QixPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDcEQsT0FBTyxFQUFlLE9BQU8sRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzlELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDdkMsT0FBTyxFQUFFLDZCQUE2QixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFFN0UsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLElBQUksQ0FBQztBQUNsQyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ3pCLE9BQU8sRUFFTCxpQkFBaUIsR0FDbEIsTUFBTSxxQ0FBcUMsQ0FBQztBQUM3QyxPQUFPLEVBQUUsZ0NBQWdDLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUNwRixPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUNqRixPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sS0FBSyxDQUFDO0FBQ3BDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxPQUFPLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUV2RSxNQUFNLGlCQUFpQixHQUFHLGlCQUFpQixDQUFDO0FBRTVDOztHQUVHO0FBQ0gsTUFBTSxDQUFDLE1BQU0sY0FBYyxHQUFHLENBQzVCLFFBQXVCLEVBQUUsRUFHekIsRUFBRSxDQUFDLElBQUksZUFB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QWMsR0FBaUM7SUFDbkQsRUFBRSxFQUFFLE9BQU8sQ0FBQyxXQUFXO0lBQ3ZCLEVBQUUsRUFBRSxPQUFPLENBQUMsV0FBVztJQUN2QixFQUFFLEVBQUUsT0FBTyxDQUFDLFdBQVc7Q0FDeEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG4gIEJhY2tlbmRTZWNyZXQsXG4gIEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3IsXG4gIENvbnN0cnVjdEZhY3RvcnksXG4gIENvbnN0cnVjdEZhY3RvcnlHZXRJbnN0YW5jZVByb3BzLFxuICBGdW5jdGlvblJlc291cmNlcyxcbiAgR2VuZXJhdGVDb250YWluZXJFbnRyeVByb3BzLFxuICBSZXNvdXJjZUFjY2Vzc0FjY2VwdG9yRmFjdG9yeSxcbiAgUmVzb3VyY2VOYW1lVmFsaWRhdG9yLFxuICBSZXNvdXJjZVByb3ZpZGVyLFxuICBTc21FbnZpcm9ubWVudEVudHJ5LFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHsgTm9kZWpzRnVuY3Rpb24sIE91dHB1dEZvcm1hdCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEtbm9kZWpzJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBnZXRDYWxsZXJEaXJlY3RvcnkgfSBmcm9tICcuL2dldF9jYWxsZXJfZGlyZWN0b3J5LmpzJztcbmltcG9ydCB7IER1cmF0aW9uLCBTdGFjaywgVGFncyB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IENmbkZ1bmN0aW9uLCBSdW50aW1lIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBjcmVhdGVSZXF1aXJlIH0gZnJvbSAnbW9kdWxlJztcbmltcG9ydCB7IEZ1bmN0aW9uRW52aXJvbm1lbnRUcmFuc2xhdG9yIH0gZnJvbSAnLi9mdW5jdGlvbl9lbnZfdHJhbnNsYXRvci5qcyc7XG5pbXBvcnQgeyBQb2xpY3kgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCB7IHJlYWRGaWxlU3luYyB9IGZyb20gJ2ZzJztcbmltcG9ydCB7IEVPTCB9IGZyb20gJ29zJztcbmltcG9ydCB7XG4gIEZ1bmN0aW9uT3V0cHV0LFxuICBmdW5jdGlvbk91dHB1dEtleSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXNjaGVtYXMnO1xuaW1wb3J0IHsgRnVuY3Rpb25FbnZpcm9ubWVudFR5cGVHZW5lcmF0b3IgfSBmcm9tICcuL2Z1bmN0aW9uX2Vudl90eXBlX2dlbmVyYXRvci5qcyc7XG5pbXBvcnQgeyBBdHRyaWJ1dGlvbk1ldGFkYXRhU3RvcmFnZSB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zdG9yYWdlJztcbmltcG9ydCB7IGZpbGVVUkxUb1BhdGggfSBmcm9tICd1cmwnO1xuaW1wb3J0IHsgQW1wbGlmeVVzZXJFcnJvciwgVGFnTmFtZSB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcblxuY29uc3QgZnVuY3Rpb25TdGFja1R5cGUgPSAnZnVuY3Rpb24tTGFtYmRhJztcblxuLyoqXG4gKiBFbnRyeSBwb2ludCBmb3IgZGVmaW5pbmcgYSBmdW5jdGlvbiBpbiB0aGUgQW1wbGlmeSBlY29zeXN0ZW1cbiAqL1xuZXhwb3J0IGNvbnN0IGRlZmluZUZ1bmN0aW9uID0gKFxuICBwcm9wczogRnVuY3Rpb25Qcm9wcyA9IHt9XG4pOiBDb25zdHJ1Y3RGYWN0b3J5PFxuICBSZXNvdXJjZVByb3ZpZGVyPEZ1bmN0aW9uUmVzb3VyY2VzPiAmIFJlc291cmNlQWNjZXNzQWNjZXB0b3JGYWN0b3J5XG4+ID0+IG5ldyBGdW5jdGlvbkZhY3RvcnkocHJvcHMsIG5ldyBFcnJvcigpLnN0YWNrKTtcblxuZXhwb3J0IHR5cGUgRnVuY3Rpb25Qcm9wcyA9IHtcbiAgLyoqXG4gICAqIEEgbmFtZSBmb3IgdGhlIGZ1bmN0aW9uLlxuICAgKiBEZWZhdWx0cyB0byB0aGUgYmFzZW5hbWUgb2YgdGhlIGVudHJ5IHBhdGggaWYgc3BlY2lmaWVkLlxuICAgKiBJZiBubyBlbnRyeSBpcyBzcGVjaWZpZWQsIGRlZmF1bHRzIHRvIHRoZSBkaXJlY3RvcnkgbmFtZSBpbiB3aGljaCB0aGlzIGZ1bmN0aW9uIGlzIGRlZmluZWQuXG4gICAqXG4gICAqIEV4YW1wbGU6XG4gICAqIElmIGVudHJ5IGlzIGAuL3NjaGVkdWxlZC1kYi1iYWNrdXAudHNgIHRoZSBuYW1lIHdpbGwgZGVmYXVsdCB0byBcInNjaGVkdWxlZC1kYi1iYWNrdXBcIlxuICAgKiBJZiBlbnRyeSBpcyBub3Qgc2V0IGFuZCB0aGUgZnVuY3Rpb24gaXMgZGVmaW5lZCBpbiBgYW1wbGlmeS9mdW5jdGlvbnMvZGItYmFja3VwL3Jlc291cmNlLnRzYCB0aGUgbmFtZSB3aWxsIGRlZmF1bHQgdG8gXCJkYi1iYWNrdXBcIlxuICAgKi9cbiAgbmFtZT86IHN0cmluZztcbiAgLyoqXG4gICAqIFRoZSBwYXRoIHRvIHRoZSBmaWxlIHRoYXQgY29udGFpbnMgdGhlIGZ1bmN0aW9uIGVudHJ5IHBvaW50LlxuICAgKiBJZiB0aGlzIGlzIGEgcmVsYXRpdmUgcGF0aCwgaXQgaXMgY29tcHV0ZWQgcmVsYXRpdmUgdG8gdGhlIGZpbGUgd2hlcmUgdGhpcyBmdW5jdGlvbiBpcyBkZWZpbmVkXG4gICAqXG4gICAqIERlZmF1bHRzIHRvICcuL2hhbmRsZXIudHMnXG4gICAqL1xuICBlbnRyeT86IHN0cmluZztcblxuICAvKipcbiAgICogQW4gYW1vdW50IG9mIHRpbWUgaW4gc2Vjb25kcyBiZXR3ZWVuIDEgc2Vjb25kIGFuZCAxNSBtaW51dGVzLlxuICAgKiBNdXN0IGJlIGEgd2hvbGUgbnVtYmVyLlxuICAgKiBEZWZhdWx0IGlzIDMgc2Vjb25kcy5cbiAgICovXG4gIHRpbWVvdXRTZWNvbmRzPzogbnVtYmVyO1xuXG4gIC8qKlxuICAgKiBBbiBhbW91bnQgb2YgbWVtb3J5IChSQU0pIHRvIGFsbG9jYXRlIHRvIHRoZSBmdW5jdGlvbiBiZXR3ZWVuIDEyOCBhbmQgMTAyNDAgTUIuXG4gICAqIE11c3QgYmUgYSB3aG9sZSBudW1iZXIuXG4gICAqIERlZmF1bHQgaXMgMTI4TUIuXG4gICAqL1xuICBtZW1vcnlNQj86IG51bWJlcjtcblxuICAvKipcbiAgICogRW52aXJvbm1lbnQgdmFyaWFibGVzIHRoYXQgd2lsbCBiZSBhdmFpbGFibGUgZHVyaW5nIGZ1bmN0aW9uIGV4ZWN1dGlvblxuICAgKi9cbiAgZW52aXJvbm1lbnQ/OiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmcgfCBCYWNrZW5kU2VjcmV0PjtcblxuICAvKipcbiAgICogTm9kZSBydW50aW1lIHZlcnNpb24gZm9yIHRoZSBsYW1iZGEgZW52aXJvbm1lbnQuXG4gICAqXG4gICAqIERlZmF1bHRzIHRvIHRoZSBvbGRlc3QgTm9kZUpTIExUUyB2ZXJzaW9uLiBTZWUgaHR0cHM6Ly9ub2RlanMub3JnL2VuL2Fib3V0L3ByZXZpb3VzLXJlbGVhc2VzXG4gICAqL1xuICBydW50aW1lPzogTm9kZVZlcnNpb247XG59O1xuXG4vKipcbiAqIENyZWF0ZSBMYW1iZGEgZnVuY3Rpb25zIGluIHRoZSBjb250ZXh0IG9mIGFuIEFtcGxpZnkgYmFja2VuZCBkZWZpbml0aW9uXG4gKi9cbmNsYXNzIEZ1bmN0aW9uRmFjdG9yeSBpbXBsZW1lbnRzIENvbnN0cnVjdEZhY3Rvcnk8QW1wbGlmeUZ1bmN0aW9uPiB7XG4gIHByaXZhdGUgZ2VuZXJhdG9yOiBDb25zdHJ1Y3RDb250YWluZXJFbnRyeUdlbmVyYXRvcjtcbiAgLyoqXG4gICAqIENyZWF0ZSBhIG5ldyBBbXBsaWZ5RnVuY3Rpb25GYWN0b3J5XG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByb3BzOiBGdW5jdGlvblByb3BzLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgY2FsbGVyU3RhY2s/OiBzdHJpbmdcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBDcmVhdGVzIGFuIGluc3RhbmNlIG9mIEFtcGxpZnlGdW5jdGlvbiB3aXRoaW4gdGhlIHByb3ZpZGVkIEFtcGxpZnkgY29udGV4dFxuICAgKi9cbiAgZ2V0SW5zdGFuY2UgPSAoe1xuICAgIGNvbnN0cnVjdENvbnRhaW5lcixcbiAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG4gICAgcmVzb3VyY2VOYW1lVmFsaWRhdG9yLFxuICB9OiBDb25zdHJ1Y3RGYWN0b3J5R2V0SW5zdGFuY2VQcm9wcyk6IEFtcGxpZnlGdW5jdGlvbiA9PiB7XG4gICAgaWYgKCF0aGlzLmdlbmVyYXRvcikge1xuICAgICAgdGhpcy5nZW5lcmF0b3IgPSBuZXcgRnVuY3Rpb25HZW5lcmF0b3IoXG4gICAgICAgIHRoaXMuaHlkcmF0ZURlZmF1bHRzKHJlc291cmNlTmFtZVZhbGlkYXRvciksXG4gICAgICAgIG91dHB1dFN0b3JhZ2VTdHJhdGVneVxuICAgICAgKTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbnN0cnVjdENvbnRhaW5lci5nZXRPckNvbXB1dGUodGhpcy5nZW5lcmF0b3IpIGFzIEFtcGxpZnlGdW5jdGlvbjtcbiAgfTtcblxuICBwcml2YXRlIGh5ZHJhdGVEZWZhdWx0cyA9IChcbiAgICByZXNvdXJjZU5hbWVWYWxpZGF0b3I/OiBSZXNvdXJjZU5hbWVWYWxpZGF0b3JcbiAgKTogSHlkcmF0ZWRGdW5jdGlvblByb3BzID0+IHtcbiAgICBjb25zdCBuYW1lID0gdGhpcy5yZXNvbHZlTmFtZSgpO1xuICAgIHJlc291cmNlTmFtZVZhbGlkYXRvcj8udmFsaWRhdGUobmFtZSk7XG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWUsXG4gICAgICBlbnRyeTogdGhpcy5yZXNvbHZlRW50cnkoKSxcbiAgICAgIHRpbWVvdXRTZWNvbmRzOiB0aGlzLnJlc29sdmVUaW1lb3V0KCksXG4gICAgICBtZW1vcnlNQjogdGhpcy5yZXNvbHZlTWVtb3J5KCksXG4gICAgICBlbnZpcm9ubWVudDogdGhpcy5wcm9wcy5lbnZpcm9ubWVudCA/PyB7fSxcbiAgICAgIHJ1bnRpbWU6IHRoaXMucmVzb2x2ZVJ1bnRpbWUoKSxcbiAgICB9O1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZU5hbWUgPSAoKSA9PiB7XG4gICAgLy8gSWYgbmFtZSBpcyBzZXQgZXhwbGljaXRseSwgdXNlIHRoYXRcbiAgICBpZiAodGhpcy5wcm9wcy5uYW1lKSB7XG4gICAgICByZXR1cm4gdGhpcy5wcm9wcy5uYW1lO1xuICAgIH1cbiAgICAvLyBJZiBlbnRyeSBpcyBzZXQsIHVzZSB0aGUgYmFzZW5hbWUgb2YgdGhlIGVudHJ5IHBhdGhcbiAgICBpZiAodGhpcy5wcm9wcy5lbnRyeSkge1xuICAgICAgcmV0dXJuIHBhdGgucGFyc2UodGhpcy5wcm9wcy5lbnRyeSkubmFtZTtcbiAgICB9XG5cbiAgICAvLyBPdGhlcndpc2UsIHVzZSB0aGUgZGlyZWN0b3J5IG5hbWUgd2hlcmUgdGhlIGZ1bmN0aW9uIGlzIGRlZmluZWRcbiAgICByZXR1cm4gcGF0aC5iYXNlbmFtZShnZXRDYWxsZXJEaXJlY3RvcnkodGhpcy5jYWxsZXJTdGFjaykpO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZUVudHJ5ID0gKCkgPT4ge1xuICAgIC8vIGlmIGVudHJ5IGlzIG5vdCBzZXQsIGRlZmF1bHQgdG8gaGFuZGxlci50c1xuICAgIGlmICghdGhpcy5wcm9wcy5lbnRyeSkge1xuICAgICAgcmV0dXJuIHBhdGguam9pbihnZXRDYWxsZXJEaXJlY3RvcnkodGhpcy5jYWxsZXJTdGFjayksICdoYW5kbGVyLnRzJyk7XG4gICAgfVxuXG4gICAgLy8gaWYgZW50cnkgaXMgYWJzb2x1dGUgdXNlIHRoYXRcbiAgICBpZiAocGF0aC5pc0Fic29sdXRlKHRoaXMucHJvcHMuZW50cnkpKSB7XG4gICAgICByZXR1cm4gdGhpcy5wcm9wcy5lbnRyeTtcbiAgICB9XG5cbiAgICAvLyBpZiBlbnRyeSBpcyByZWxhdGl2ZSwgY29tcHV0ZSB3aXRoIHJlc3BlY3QgdG8gdGhlIGNhbGxlciBkaXJlY3RvcnlcbiAgICByZXR1cm4gcGF0aC5qb2luKGdldENhbGxlckRpcmVjdG9yeSh0aGlzLmNhbGxlclN0YWNrKSwgdGhpcy5wcm9wcy5lbnRyeSk7XG4gIH07XG5cbiAgcHJpdmF0ZSByZXNvbHZlVGltZW91dCA9ICgpID0+IHtcbiAgICBjb25zdCB0aW1lb3V0TWluID0gMTtcbiAgICBjb25zdCB0aW1lb3V0TWF4ID0gNjAgKiAxNTsgLy8gMTUgbWludXRlcyBpbiBzZWNvbmRzXG4gICAgY29uc3QgdGltZW91dERlZmF1bHQgPSAzO1xuICAgIGlmICh0aGlzLnByb3BzLnRpbWVvdXRTZWNvbmRzID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiB0aW1lb3V0RGVmYXVsdDtcbiAgICB9XG5cbiAgICBpZiAoXG4gICAgICAhaXNXaG9sZU51bWJlckJldHdlZW5JbmNsdXNpdmUoXG4gICAgICAgIHRoaXMucHJvcHMudGltZW91dFNlY29uZHMsXG4gICAgICAgIHRpbWVvdXRNaW4sXG4gICAgICAgIHRpbWVvdXRNYXhcbiAgICAgIClcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYHRpbWVvdXRTZWNvbmRzIG11c3QgYmUgYSB3aG9sZSBudW1iZXIgYmV0d2VlbiAke3RpbWVvdXRNaW59IGFuZCAke3RpbWVvdXRNYXh9IGluY2x1c2l2ZWBcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnByb3BzLnRpbWVvdXRTZWNvbmRzO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZU1lbW9yeSA9ICgpID0+IHtcbiAgICBjb25zdCBtZW1vcnlNaW4gPSAxMjg7XG4gICAgY29uc3QgbWVtb3J5TWF4ID0gMTAyNDA7XG4gICAgY29uc3QgbWVtb3J5RGVmYXVsdCA9IDUxMjtcbiAgICBpZiAodGhpcy5wcm9wcy5tZW1vcnlNQiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gbWVtb3J5RGVmYXVsdDtcbiAgICB9XG4gICAgaWYgKFxuICAgICAgIWlzV2hvbGVOdW1iZXJCZXR3ZWVuSW5jbHVzaXZlKHRoaXMucHJvcHMubWVtb3J5TUIsIG1lbW9yeU1pbiwgbWVtb3J5TWF4KVxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgbWVtb3J5TUIgbXVzdCBiZSBhIHdob2xlIG51bWJlciBiZXR3ZWVuICR7bWVtb3J5TWlufSBhbmQgJHttZW1vcnlNYXh9IGluY2x1c2l2ZWBcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnByb3BzLm1lbW9yeU1CO1xuICB9O1xuXG4gIHByaXZhdGUgcmVzb2x2ZVJ1bnRpbWUgPSAoKSA9PiB7XG4gICAgY29uc3QgcnVudGltZURlZmF1bHQgPSAxODtcblxuICAgIC8vIGlmIHJ1bnRpbWUgaXMgbm90IHNldCwgZGVmYXVsdCB0byB0aGUgb2xkZXN0IExUU1xuICAgIGlmICghdGhpcy5wcm9wcy5ydW50aW1lKSB7XG4gICAgICByZXR1cm4gcnVudGltZURlZmF1bHQ7XG4gICAgfVxuXG4gICAgaWYgKCEodGhpcy5wcm9wcy5ydW50aW1lIGluIG5vZGVWZXJzaW9uTWFwKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgcnVudGltZSBtdXN0IGJlIG9uZSBvZiB0aGUgZm9sbG93aW5nOiAke09iamVjdC5rZXlzKFxuICAgICAgICAgIG5vZGVWZXJzaW9uTWFwXG4gICAgICAgICkuam9pbignLCAnKX1gXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnByb3BzLnJ1bnRpbWU7XG4gIH07XG59XG5cbnR5cGUgSHlkcmF0ZWRGdW5jdGlvblByb3BzID0gUmVxdWlyZWQ8RnVuY3Rpb25Qcm9wcz47XG5cbmNsYXNzIEZ1bmN0aW9uR2VuZXJhdG9yIGltcGxlbWVudHMgQ29uc3RydWN0Q29udGFpbmVyRW50cnlHZW5lcmF0b3Ige1xuICByZWFkb25seSByZXNvdXJjZUdyb3VwTmFtZSA9ICdmdW5jdGlvbic7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBwcm9wczogSHlkcmF0ZWRGdW5jdGlvblByb3BzLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5OiBCYWNrZW5kT3V0cHV0U3RvcmFnZVN0cmF0ZWd5PEZ1bmN0aW9uT3V0cHV0PlxuICApIHt9XG5cbiAgZ2VuZXJhdGVDb250YWluZXJFbnRyeSA9ICh7XG4gICAgc2NvcGUsXG4gICAgYmFja2VuZFNlY3JldFJlc29sdmVyLFxuICB9OiBHZW5lcmF0ZUNvbnRhaW5lckVudHJ5UHJvcHMpID0+IHtcbiAgICByZXR1cm4gbmV3IEFtcGxpZnlGdW5jdGlvbihcbiAgICAgIHNjb3BlLFxuICAgICAgdGhpcy5wcm9wcy5uYW1lLFxuICAgICAgdGhpcy5wcm9wcyxcbiAgICAgIGJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgICAgIHRoaXMub3V0cHV0U3RvcmFnZVN0cmF0ZWd5XG4gICAgKTtcbiAgfTtcbn1cblxuY2xhc3MgQW1wbGlmeUZ1bmN0aW9uXG4gIGV4dGVuZHMgQ29uc3RydWN0XG4gIGltcGxlbWVudHMgUmVzb3VyY2VQcm92aWRlcjxGdW5jdGlvblJlc291cmNlcz4sIFJlc291cmNlQWNjZXNzQWNjZXB0b3JGYWN0b3J5XG57XG4gIHJlYWRvbmx5IHJlc291cmNlczogRnVuY3Rpb25SZXNvdXJjZXM7XG4gIHByaXZhdGUgcmVhZG9ubHkgZnVuY3Rpb25FbnZpcm9ubWVudFRyYW5zbGF0b3I6IEZ1bmN0aW9uRW52aXJvbm1lbnRUcmFuc2xhdG9yO1xuICBjb25zdHJ1Y3RvcihcbiAgICBzY29wZTogQ29uc3RydWN0LFxuICAgIGlkOiBzdHJpbmcsXG4gICAgcHJvcHM6IEh5ZHJhdGVkRnVuY3Rpb25Qcm9wcyxcbiAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXI6IEJhY2tlbmRTZWNyZXRSZXNvbHZlcixcbiAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3k6IEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3k8RnVuY3Rpb25PdXRwdXQ+XG4gICkge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBjb25zdCBydW50aW1lID0gbm9kZVZlcnNpb25NYXBbcHJvcHMucnVudGltZV07XG5cbiAgICBjb25zdCByZXF1aXJlID0gY3JlYXRlUmVxdWlyZShpbXBvcnQubWV0YS51cmwpO1xuXG4gICAgY29uc3Qgc2hpbXMgPVxuICAgICAgcnVudGltZSA9PT0gUnVudGltZS5OT0RFSlNfMTZfWFxuICAgICAgICA/IFtdXG4gICAgICAgIDogW3JlcXVpcmUucmVzb2x2ZSgnLi9sYW1iZGEtc2hpbXMvY2pzX3NoaW0nKV07XG5cbiAgICBjb25zdCBzc21SZXNvbHZlckZpbGUgPVxuICAgICAgcnVudGltZSA9PT0gUnVudGltZS5OT0RFSlNfMTZfWFxuICAgICAgICA/IHJlcXVpcmUucmVzb2x2ZSgnLi9sYW1iZGEtc2hpbXMvcmVzb2x2ZV9zc21fcGFyYW1zX3Nka192MicpIC8vIHVzZSBhd3MgY2RrIHYyIGluIG5vZGUgMTZcbiAgICAgICAgOiByZXF1aXJlLnJlc29sdmUoJy4vbGFtYmRhLXNoaW1zL3Jlc29sdmVfc3NtX3BhcmFtcycpO1xuXG4gICAgY29uc3QgaW52b2tlU3NtUmVzb2x2ZXJGaWxlID0gcmVxdWlyZS5yZXNvbHZlKFxuICAgICAgJy4vbGFtYmRhLXNoaW1zL2ludm9rZV9zc21fc2hpbSdcbiAgICApO1xuXG4gICAgLyoqXG4gICAgICogVGhpcyBjb2RlIGNvbmNhdGVuYXRlcyB0aGUgY29udGVudHMgb2YgdGhlIHNzbSByZXNvbHZlciBhbmQgaW52b2tlciBpbnRvIGEgc2luZ2xlIGxpbmUgdGhhdCBjYW4gYmUgdXNlZCBhcyB0aGUgZXNidWlsZCBiYW5uZXIgY29udGVudFxuICAgICAqIFRoaXMgYmFubmVyIGlzIHJlc3BvbnNpYmxlIGZvciByZXNvbHZpbmcgdGhlIGN1c3RvbWVyJ3MgU1NNIHBhcmFtZXRlcnMgYXQgcnVudGltZVxuICAgICAqL1xuICAgIGNvbnN0IGJhbm5lckNvZGUgPSByZWFkRmlsZVN5bmMoc3NtUmVzb2x2ZXJGaWxlLCAndXRmLTgnKVxuICAgICAgLmNvbmNhdChyZWFkRmlsZVN5bmMoaW52b2tlU3NtUmVzb2x2ZXJGaWxlLCAndXRmLTgnKSlcbiAgICAgIC5zcGxpdChuZXcgUmVnRXhwKGAke0VPTH18XFxufFxccmAsICdnJykpXG4gICAgICAubWFwKChsaW5lKSA9PiBsaW5lLnJlcGxhY2UoL1xcL1xcLy4qJC8sICcnKSkgLy8gc3RyaXAgb3V0IGlubGluZSBjb21tZW50cyBiZWNhdXNlIHRoZSBiYW5uZXIgaXMgZ29pbmcgdG8gYmUgZmxhdHRlbmVkIGludG8gYSBzaW5nbGUgbGluZVxuICAgICAgLmpvaW4oJycpO1xuXG4gICAgY29uc3QgZnVuY3Rpb25FbnZpcm9ubWVudFR5cGVHZW5lcmF0b3IgPVxuICAgICAgbmV3IEZ1bmN0aW9uRW52aXJvbm1lbnRUeXBlR2VuZXJhdG9yKGlkKTtcblxuICAgIC8vIGVzYnVpbGQgcnVucyBhcyBwYXJ0IG9mIHRoZSBOb2RlanNGdW5jdGlvbiBjb25zdHJ1Y3Rvciwgc28gd2UgZWFnZXJseSBnZW5lcmF0ZSB0aGUgcHJvY2VzcyBlbnYgc2hpbSB3aXRob3V0IHR5cGVzIHNvIGl0IGNhbiBiZSBpbmNsdWRlZCBpbiB0aGUgZnVuY3Rpb24gYnVuZGxlLlxuICAgIC8vIFRoaXMgd2lsbCBiZSBvdmVyd3JpdHRlbiB3aXRoIHRoZSB0eXBlZCBmaWxlIGF0IHRoZSBlbmQgb2Ygc3ludGhlc2lzXG4gICAgZnVuY3Rpb25FbnZpcm9ubWVudFR5cGVHZW5lcmF0b3IuZ2VuZXJhdGVQcm9jZXNzRW52U2hpbSgpO1xuXG4gICAgbGV0IGZ1bmN0aW9uTGFtYmRhO1xuICAgIHRyeSB7XG4gICAgICBmdW5jdGlvbkxhbWJkYSA9IG5ldyBOb2RlanNGdW5jdGlvbihzY29wZSwgYCR7aWR9LWxhbWJkYWAsIHtcbiAgICAgICAgZW50cnk6IHByb3BzLmVudHJ5LFxuICAgICAgICB0aW1lb3V0OiBEdXJhdGlvbi5zZWNvbmRzKHByb3BzLnRpbWVvdXRTZWNvbmRzKSxcbiAgICAgICAgbWVtb3J5U2l6ZTogcHJvcHMubWVtb3J5TUIsXG4gICAgICAgIHJ1bnRpbWU6IG5vZGVWZXJzaW9uTWFwW3Byb3BzLnJ1bnRpbWVdLFxuICAgICAgICBidW5kbGluZzoge1xuICAgICAgICAgIGZvcm1hdDogT3V0cHV0Rm9ybWF0LkVTTSxcbiAgICAgICAgICBiYW5uZXI6IGJhbm5lckNvZGUsXG4gICAgICAgICAgaW5qZWN0OiBzaGltcyxcbiAgICAgICAgICBsb2FkZXI6IHtcbiAgICAgICAgICAgICcubm9kZSc6ICdmaWxlJyxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKFxuICAgICAgICAnTm9kZUpTRnVuY3Rpb25Db25zdHJ1Y3RJbml0aWFsaXphdGlvbkVycm9yJyxcbiAgICAgICAge1xuICAgICAgICAgIG1lc3NhZ2U6ICdGYWlsZWQgdG8gaW5zdGFudGlhdGUgbm9kZWpzIGZ1bmN0aW9uIGNvbnN0cnVjdCcsXG4gICAgICAgICAgcmVzb2x1dGlvbjogJ1NlZSB0aGUgdW5kZXJseWluZyBlcnJvciBtZXNzYWdlIGZvciBtb3JlIGRldGFpbHMuJyxcbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3IgYXMgRXJyb3JcbiAgICAgICk7XG4gICAgfVxuXG4gICAgVGFncy5vZihmdW5jdGlvbkxhbWJkYSkuYWRkKFRhZ05hbWUuRlJJRU5ETFlfTkFNRSwgaWQpO1xuXG4gICAgdGhpcy5mdW5jdGlvbkVudmlyb25tZW50VHJhbnNsYXRvciA9IG5ldyBGdW5jdGlvbkVudmlyb25tZW50VHJhbnNsYXRvcihcbiAgICAgIGZ1bmN0aW9uTGFtYmRhLFxuICAgICAgcHJvcHMuZW52aXJvbm1lbnQsXG4gICAgICBiYWNrZW5kU2VjcmV0UmVzb2x2ZXIsXG4gICAgICBmdW5jdGlvbkVudmlyb25tZW50VHlwZUdlbmVyYXRvclxuICAgICk7XG5cbiAgICB0aGlzLnJlc291cmNlcyA9IHtcbiAgICAgIGxhbWJkYTogZnVuY3Rpb25MYW1iZGEsXG4gICAgICBjZm5SZXNvdXJjZXM6IHtcbiAgICAgICAgY2ZuRnVuY3Rpb246IGZ1bmN0aW9uTGFtYmRhLm5vZGUuZmluZENoaWxkKCdSZXNvdXJjZScpIGFzIENmbkZ1bmN0aW9uLFxuICAgICAgfSxcbiAgICB9O1xuXG4gICAgdGhpcy5zdG9yZU91dHB1dChvdXRwdXRTdG9yYWdlU3RyYXRlZ3kpO1xuXG4gICAgbmV3IEF0dHJpYnV0aW9uTWV0YWRhdGFTdG9yYWdlKCkuc3RvcmVBdHRyaWJ1dGlvbk1ldGFkYXRhKFxuICAgICAgU3RhY2sub2YodGhpcyksXG4gICAgICBmdW5jdGlvblN0YWNrVHlwZSxcbiAgICAgIGZpbGVVUkxUb1BhdGgobmV3IFVSTCgnLi4vcGFja2FnZS5qc29uJywgaW1wb3J0Lm1ldGEudXJsKSlcbiAgICApO1xuICB9XG5cbiAgZ2V0UmVzb3VyY2VBY2Nlc3NBY2NlcHRvciA9ICgpID0+ICh7XG4gICAgaWRlbnRpZmllcjogYCR7dGhpcy5ub2RlLmlkfUxhbWJkYVJlc291cmNlQWNjZXNzQWNjZXB0b3JgLFxuICAgIGFjY2VwdFJlc291cmNlQWNjZXNzOiAoXG4gICAgICBwb2xpY3k6IFBvbGljeSxcbiAgICAgIHNzbUVudmlyb25tZW50RW50cmllczogU3NtRW52aXJvbm1lbnRFbnRyeVtdXG4gICAgKSA9PiB7XG4gICAgICBjb25zdCByb2xlID0gdGhpcy5yZXNvdXJjZXMubGFtYmRhLnJvbGU7XG4gICAgICBpZiAoIXJvbGUpIHtcbiAgICAgICAgLy8gVGhpcyBzaG91bGQgbmV2ZXIgaGFwcGVuIHNpbmNlIHdlIGFyZSB1c2luZyB0aGUgRnVuY3Rpb24gTDIgY29uc3RydWN0XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAnTm8gZXhlY3V0aW9uIHJvbGUgZm91bmQgdG8gYXR0YWNoIGxhbWJkYSBwZXJtaXNzaW9ucyB0bydcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHBvbGljeS5hdHRhY2hUb1JvbGUocm9sZSk7XG4gICAgICBzc21FbnZpcm9ubWVudEVudHJpZXMuZm9yRWFjaCgoeyBuYW1lLCBwYXRoIH0pID0+IHtcbiAgICAgICAgdGhpcy5mdW5jdGlvbkVudmlyb25tZW50VHJhbnNsYXRvci5hZGRTc21FbnZpcm9ubWVudEVudHJ5KG5hbWUsIHBhdGgpO1xuICAgICAgfSk7XG4gICAgfSxcbiAgfSk7XG5cbiAgLyoqXG4gICAqIFN0b3JlIHN0b3JhZ2Ugb3V0cHV0cyB1c2luZyBwcm92aWRlZCBzdHJhdGVneVxuICAgKi9cbiAgcHJpdmF0ZSBzdG9yZU91dHB1dCA9IChcbiAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3k6IEJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3k8RnVuY3Rpb25PdXRwdXQ+XG4gICk6IHZvaWQgPT4ge1xuICAgIG91dHB1dFN0b3JhZ2VTdHJhdGVneS5hcHBlbmRUb0JhY2tlbmRPdXRwdXRMaXN0KGZ1bmN0aW9uT3V0cHV0S2V5LCB7XG4gICAgICB2ZXJzaW9uOiAnMScsXG4gICAgICBwYXlsb2FkOiB7XG4gICAgICAgIGRlZmluZWRGdW5jdGlvbnM6IHRoaXMucmVzb3VyY2VzLmxhbWJkYS5mdW5jdGlvbk5hbWUsXG4gICAgICB9LFxuICAgIH0pO1xuICB9O1xufVxuXG5jb25zdCBpc1dob2xlTnVtYmVyQmV0d2VlbkluY2x1c2l2ZSA9IChcbiAgdGVzdDogbnVtYmVyLFxuICBtaW46IG51bWJlcixcbiAgbWF4OiBudW1iZXJcbikgPT4gbWluIDw9IHRlc3QgJiYgdGVzdCA8PSBtYXggJiYgdGVzdCAlIDEgPT09IDA7XG5cbmV4cG9ydCB0eXBlIE5vZGVWZXJzaW9uID0gMTYgfCAxOCB8IDIwO1xuXG5jb25zdCBub2RlVmVyc2lvbk1hcDogUmVjb3JkPE5vZGVWZXJzaW9uLCBSdW50aW1lPiA9IHtcbiAgMTY6IFJ1bnRpbWUuTk9ERUpTXzE2X1gsXG4gIDE4OiBSdW50aW1lLk5PREVKU18xOF9YLFxuICAyMDogUnVudGltZS5OT0RFSlNfMjBfWCxcbn07XG4iXX0=