import { authOutputKey, customOutputKey, graphqlOutputKey, storageOutputKey, } from '@aws-amplify/backend-output-schemas';
import { ClientConfigVersionOption, } from '../client-config-types/client_config.js';
// All categories client config contributors are included here to mildly enforce them using
// the same schema (version and other types)
/**
 * Translator for the version number of ClientConfig
 */
export class VersionContributor {
    /**
     * Return the version of the schema types that this contributor uses
     */
    contribute = () => {
        return { version: ClientConfigVersionOption.V1 };
    };
}
/**
 * Translator for the Auth portion of ClientConfig
 */
export class AuthClientConfigContributor {
    /**
     * Given some BackendOutput, contribute the Auth portion of the ClientConfig
     */
    contribute = ({ [authOutputKey]: authOutput, }) => {
        if (authOutput === undefined) {
            return {};
        }
        const parseAndAssignObject = (obj, key, value) => {
            if (value == null) {
                return;
            }
            obj[key] = JSON.parse(value);
        };
        const authClientConfig = {};
        authClientConfig.auth = {
            user_pool_id: authOutput.payload.userPoolId,
            aws_region: authOutput.payload.authRegion,
            user_pool_client_id: authOutput.payload.webClientId,
        };
        if (authOutput.payload.identityPoolId) {
            authClientConfig.auth.identity_pool_id =
                authOutput.payload.identityPoolId;
        }
        parseAndAssignObject(authClientConfig.auth, 'mfa_methods', authOutput.payload.mfaTypes);
        parseAndAssignObject(authClientConfig.auth, 'mfa_methods', authOutput.payload.mfaTypes);
        parseAndAssignObject(authClientConfig.auth, 'standard_required_attributes', authOutput.payload.signupAttributes);
        parseAndAssignObject(authClientConfig.auth, 'username_attributes', authOutput.payload.usernameAttributes);
        parseAndAssignObject(authClientConfig.auth, 'user_verification_types', authOutput.payload.verificationMechanisms);
        if (authOutput.payload.mfaConfiguration) {
            authClientConfig.auth.mfa_configuration = authOutput.payload
                .mfaConfiguration;
        }
        if (authOutput.payload.passwordPolicyMinLength ||
            authOutput.payload.passwordPolicyRequirements) {
            authClientConfig.auth.password_policy = {};
            if (authOutput.payload.passwordPolicyMinLength) {
                authClientConfig.auth.password_policy.min_length = Number.parseInt(authOutput.payload.passwordPolicyMinLength);
            }
            if (authOutput.payload.passwordPolicyRequirements) {
                const requirements = JSON.parse(authOutput.payload.passwordPolicyRequirements);
                for (const requirement of requirements) {
                    switch (requirement) {
                        case 'REQUIRES_NUMBERS':
                            authClientConfig.auth.password_policy.require_numbers = true;
                            break;
                        case 'REQUIRES_LOWERCASE':
                            authClientConfig.auth.password_policy.require_lowercase = true;
                            break;
                        case 'REQUIRES_UPPERCASE':
                            authClientConfig.auth.password_policy.require_uppercase = true;
                            break;
                        case 'REQUIRES_SYMBOLS':
                            authClientConfig.auth.password_policy.require_symbols = true;
                            break;
                    }
                }
            }
        }
        // OAuth settings are present if both oauthRedirectSignIn and oauthRedirectSignOut are.
        if (authOutput.payload.oauthRedirectSignIn &&
            authOutput.payload.oauthRedirectSignOut) {
            authClientConfig.auth.oauth = {
                identity_providers: authOutput.payload.socialProviders
                    ? JSON.parse(authOutput.payload.socialProviders)
                    : [],
                redirect_sign_in_uri: authOutput.payload.oauthRedirectSignIn.split(','),
                redirect_sign_out_uri: authOutput.payload.oauthRedirectSignOut.split(','),
                response_type: authOutput.payload.oauthResponseType,
                scopes: authOutput.payload.oauthScope
                    ? JSON.parse(authOutput.payload.oauthScope)
                    : [],
                domain: authOutput.payload.oauthCognitoDomain ?? '',
            };
        }
        if (authOutput.payload.allowUnauthenticatedIdentities) {
            authClientConfig.auth.unauthenticated_identities_enabled =
                authOutput.payload.allowUnauthenticatedIdentities === 'true';
        }
        return authClientConfig;
    };
}
/**
 * Translator for the Data portion of ClientConfig
 */
export class DataClientConfigContributor {
    modelIntrospectionSchemaAdapter;
    /**
     * Constructor
     * @param modelIntrospectionSchemaAdapter the adapter to provide the model introspection schema from s3 uri
     */
    constructor(modelIntrospectionSchemaAdapter) {
        this.modelIntrospectionSchemaAdapter = modelIntrospectionSchemaAdapter;
    }
    /**
     * Given some BackendOutput, contribute the Graphql API portion of the client config
     */
    contribute = async ({ [graphqlOutputKey]: graphqlOutput, }) => {
        if (graphqlOutput === undefined) {
            return {};
        }
        const config = {};
        config.data = {
            url: graphqlOutput.payload.awsAppsyncApiEndpoint,
            aws_region: graphqlOutput.payload.awsAppsyncRegion,
            api_key: graphqlOutput.payload.awsAppsyncApiKey,
            default_authorization_type: graphqlOutput.payload.awsAppsyncAuthenticationType,
            authorization_types: graphqlOutput.payload.awsAppsyncAdditionalAuthenticationTypes?.split(','),
        };
        const modelIntrospection = await this.modelIntrospectionSchemaAdapter.getModelIntrospectionSchemaFromS3Uri(graphqlOutput.payload.amplifyApiModelSchemaS3Uri);
        if (modelIntrospection) {
            config.data.model_introspection = modelIntrospection;
        }
        return config;
    };
}
/**
 * Translator for the Storage portion of ClientConfig
 */
export class StorageClientConfigContributor {
    /**
     * Given some BackendOutput, contribute the Storage portion of the client config
     */
    contribute = ({ [storageOutputKey]: storageOutput, }) => {
        if (storageOutput === undefined) {
            return {};
        }
        const config = {};
        config.storage = {
            aws_region: storageOutput.payload.storageRegion,
            bucket_name: storageOutput.payload.bucketName,
        };
        return config;
    };
}
/**
 * Translator for the Custom portion of ClientConfig
 */
export class CustomClientConfigContributor {
    /**
     * Given some BackendOutput, contribute the Custom portion of the ClientConfig
     */
    contribute = ({ [customOutputKey]: customOutput, }) => {
        if (customOutput === undefined) {
            return {};
        }
        return JSON.parse(customOutput.payload.customOutputs);
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50X2NvbmZpZ19jb250cmlidXRvcl92MS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jbGllbnQtY29uZmlnLWNvbnRyaWJ1dG9yL2NsaWVudF9jb25maWdfY29udHJpYnV0b3JfdjEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUVMLGFBQWEsRUFDYixlQUFlLEVBQ2YsZ0JBQWdCLEVBQ2hCLGdCQUFnQixHQUNqQixNQUFNLHFDQUFxQyxDQUFDO0FBQzdDLE9BQU8sRUFFTCx5QkFBeUIsR0FFMUIsTUFBTSx5Q0FBeUMsQ0FBQztBQUlqRCwyRkFBMkY7QUFDM0YsNENBQTRDO0FBRTVDOztHQUVHO0FBQ0gsTUFBTSxPQUFPLGtCQUFrQjtJQUM3Qjs7T0FFRztJQUNILFVBQVUsR0FBRyxHQUFpQixFQUFFO1FBQzlCLE9BQU8sRUFBRSxPQUFPLEVBQUUseUJBQXlCLENBQUMsRUFBRSxFQUFFLENBQUM7SUFDbkQsQ0FBQyxDQUFDO0NBQ0g7QUFFRDs7R0FFRztBQUNILE1BQU0sT0FBTywyQkFBMkI7SUFDdEM7O09BRUc7SUFDSCxVQUFVLEdBQUcsQ0FBQyxFQUNaLENBQUMsYUFBYSxDQUFDLEVBQUUsVUFBVSxHQUNOLEVBQWlELEVBQUU7UUFDeEUsSUFBSSxVQUFVLEtBQUssU0FBUyxFQUFFO1lBQzVCLE9BQU8sRUFBRSxDQUFDO1NBQ1g7UUFFRCxNQUFNLG9CQUFvQixHQUFHLENBQzNCLEdBQU0sRUFDTixHQUFZLEVBQ1osS0FBeUIsRUFDekIsRUFBRTtZQUNGLElBQUksS0FBSyxJQUFJLElBQUksRUFBRTtnQkFDakIsT0FBTzthQUNSO1lBQ0QsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDL0IsQ0FBQyxDQUFDO1FBRUYsTUFBTSxnQkFBZ0IsR0FDcEIsRUFBRSxDQUFDO1FBRUwsZ0JBQWdCLENBQUMsSUFBSSxHQUFHO1lBQ3RCLFlBQVksRUFBRSxVQUFVLENBQUMsT0FBTyxDQUFDLFVBQVU7WUFDM0MsVUFBVSxFQUFFLFVBQVUsQ0FBQyxPQUFPLENBQUMsVUFBVTtZQUN6QyxtQkFBbUIsRUFBRSxVQUFVLENBQUMsT0FBTyxDQUFDLFdBQVc7U0FDcEQsQ0FBQztRQUVGLElBQUksVUFBVSxDQUFDLE9BQU8sQ0FBQyxjQUFjLEVBQUU7WUFDckMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLGdCQUFnQjtnQkFDcEMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUM7U0FDckM7UUFFRCxvQkFBb0IsQ0FDbEIsZ0JBQWdCLENBQUMsSUFBSSxFQUNyQixhQUFhLEVBQ2IsVUFBVSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQzVCLENBQUM7UUFFRixvQkFBb0IsQ0FDbEIsZ0JBQWdCLENBQUMsSUFBSSxFQUNyQixhQUFhLEVBQ2IsVUFBVSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQzVCLENBQUM7UUFFRixvQkFBb0IsQ0FDbEIsZ0JBQWdCLENBQUMsSUFBSSxFQUNyQiw4QkFBOEIsRUFDOUIsVUFBVSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FDcEMsQ0FBQztRQUVGLG9CQUFvQixDQUNsQixnQkFBZ0IsQ0FBQyxJQUFJLEVBQ3JCLHFCQUFxQixFQUNyQixVQUFVLENBQUMsT0FBTyxDQUFDLGtCQUFrQixDQUN0QyxDQUFDO1FBRUYsb0JBQW9CLENBQ2xCLGdCQUFnQixDQUFDLElBQUksRUFDckIseUJBQXlCLEVBQ3pCLFVBQVUsQ0FBQyxPQUFPLENBQUMsc0JBQXNCLENBQzFDLENBQUM7UUFFRixJQUFJLFVBQVUsQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLEVBQUU7WUFDdkMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLFVBQVUsQ0FBQyxPQUFPO2lCQUN6RCxnQkFBb0QsQ0FBQztTQUN6RDtRQUVELElBQ0UsVUFBVSxDQUFDLE9BQU8sQ0FBQyx1QkFBdUI7WUFDMUMsVUFBVSxDQUFDLE9BQU8sQ0FBQywwQkFBMEIsRUFDN0M7WUFDQSxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsZUFBZSxHQUFHLEVBQUUsQ0FBQztZQUMzQyxJQUFJLFVBQVUsQ0FBQyxPQUFPLENBQUMsdUJBQXVCLEVBQUU7Z0JBQzlDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsVUFBVSxHQUFHLE1BQU0sQ0FBQyxRQUFRLENBQ2hFLFVBQVUsQ0FBQyxPQUFPLENBQUMsdUJBQXVCLENBQzNDLENBQUM7YUFDSDtZQUNELElBQUksVUFBVSxDQUFDLE9BQU8sQ0FBQywwQkFBMEIsRUFBRTtnQkFDakQsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FDN0IsVUFBVSxDQUFDLE9BQU8sQ0FBQywwQkFBMEIsQ0FDbEMsQ0FBQztnQkFDZCxLQUFLLE1BQU0sV0FBVyxJQUFJLFlBQVksRUFBRTtvQkFDdEMsUUFBUSxXQUFXLEVBQUU7d0JBQ25CLEtBQUssa0JBQWtCOzRCQUNyQixnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUM7NEJBQzdELE1BQU07d0JBQ1IsS0FBSyxvQkFBb0I7NEJBQ3ZCLGdCQUFnQixDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDOzRCQUMvRCxNQUFNO3dCQUNSLEtBQUssb0JBQW9COzRCQUN2QixnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLGlCQUFpQixHQUFHLElBQUksQ0FBQzs0QkFDL0QsTUFBTTt3QkFDUixLQUFLLGtCQUFrQjs0QkFDckIsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDOzRCQUM3RCxNQUFNO3FCQUNUO2lCQUNGO2FBQ0Y7U0FDRjtRQUVELHVGQUF1RjtRQUN2RixJQUNFLFVBQVUsQ0FBQyxPQUFPLENBQUMsbUJBQW1CO1lBQ3RDLFVBQVUsQ0FBQyxPQUFPLENBQUMsb0JBQW9CLEVBQ3ZDO1lBQ0EsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRztnQkFDNUIsa0JBQWtCLEVBQUUsVUFBVSxDQUFDLE9BQU8sQ0FBQyxlQUFlO29CQUNwRCxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLGVBQWUsQ0FBQztvQkFDaEQsQ0FBQyxDQUFDLEVBQUU7Z0JBQ04sb0JBQW9CLEVBQUUsVUFBVSxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDO2dCQUN2RSxxQkFBcUIsRUFDbkIsVUFBVSxDQUFDLE9BQU8sQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDO2dCQUNwRCxhQUFhLEVBQUUsVUFBVSxDQUFDLE9BQU8sQ0FBQyxpQkFBcUM7Z0JBQ3ZFLE1BQU0sRUFBRSxVQUFVLENBQUMsT0FBTyxDQUFDLFVBQVU7b0JBQ25DLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDO29CQUMzQyxDQUFDLENBQUMsRUFBRTtnQkFDTixNQUFNLEVBQUUsVUFBVSxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsSUFBSSxFQUFFO2FBQ3BELENBQUM7U0FDSDtRQUVELElBQUksVUFBVSxDQUFDLE9BQU8sQ0FBQyw4QkFBOEIsRUFBRTtZQUNyRCxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsa0NBQWtDO2dCQUN0RCxVQUFVLENBQUMsT0FBTyxDQUFDLDhCQUE4QixLQUFLLE1BQU0sQ0FBQztTQUNoRTtRQUVELE9BQU8sZ0JBQWdCLENBQUM7SUFDMUIsQ0FBQyxDQUFDO0NBQ0g7QUFFRDs7R0FFRztBQUNILE1BQU0sT0FBTywyQkFBMkI7SUFNbkI7SUFMbkI7OztPQUdHO0lBQ0gsWUFDbUIsK0JBQWdFO1FBQWhFLG9DQUErQixHQUEvQiwrQkFBK0IsQ0FBaUM7SUFDaEYsQ0FBQztJQUVKOztPQUVHO0lBQ0gsVUFBVSxHQUFHLEtBQUssRUFBRSxFQUNsQixDQUFDLGdCQUFnQixDQUFDLEVBQUUsYUFBYSxHQUNaLEVBRXJCLEVBQUU7UUFDRixJQUFJLGFBQWEsS0FBSyxTQUFTLEVBQUU7WUFDL0IsT0FBTyxFQUFFLENBQUM7U0FDWDtRQUNELE1BQU0sTUFBTSxHQUEwRCxFQUFFLENBQUM7UUFFekUsTUFBTSxDQUFDLElBQUksR0FBRztZQUNaLEdBQUcsRUFBRSxhQUFhLENBQUMsT0FBTyxDQUFDLHFCQUFxQjtZQUNoRCxVQUFVLEVBQUUsYUFBYSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0I7WUFDbEQsT0FBTyxFQUFFLGFBQWEsQ0FBQyxPQUFPLENBQUMsZ0JBQWdCO1lBQy9DLDBCQUEwQixFQUN4QixhQUFhLENBQUMsT0FBTyxDQUFDLDRCQUE0QjtZQUNwRCxtQkFBbUIsRUFDakIsYUFBYSxDQUFDLE9BQU8sQ0FBQyx1Q0FBdUMsRUFBRSxLQUFLLENBQ2xFLEdBQUcsQ0FDNkI7U0FDckMsQ0FBQztRQUVGLE1BQU0sa0JBQWtCLEdBQ3RCLE1BQU0sSUFBSSxDQUFDLCtCQUErQixDQUFDLG9DQUFvQyxDQUM3RSxhQUFhLENBQUMsT0FBTyxDQUFDLDBCQUEwQixDQUNqRCxDQUFDO1FBRUosSUFBSSxrQkFBa0IsRUFBRTtZQUN0QixNQUFNLENBQUMsSUFBSSxDQUFDLG1CQUFtQixHQUFHLGtCQUVqQyxDQUFDO1NBQ0g7UUFFRCxPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDLENBQUM7Q0FDSDtBQUVEOztHQUVHO0FBQ0gsTUFBTSxPQUFPLDhCQUE4QjtJQUN6Qzs7T0FFRztJQUNILFVBQVUsR0FBRyxDQUFDLEVBQ1osQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLGFBQWEsR0FDWixFQUFpRCxFQUFFO1FBQ3hFLElBQUksYUFBYSxLQUFLLFNBQVMsRUFBRTtZQUMvQixPQUFPLEVBQUUsQ0FBQztTQUNYO1FBQ0QsTUFBTSxNQUFNLEdBQTBELEVBQUUsQ0FBQztRQUV6RSxNQUFNLENBQUMsT0FBTyxHQUFHO1lBQ2YsVUFBVSxFQUFFLGFBQWEsQ0FBQyxPQUFPLENBQUMsYUFBYTtZQUMvQyxXQUFXLEVBQUUsYUFBYSxDQUFDLE9BQU8sQ0FBQyxVQUFVO1NBQzlDLENBQUM7UUFFRixPQUFPLE1BQU0sQ0FBQztJQUNoQixDQUFDLENBQUM7Q0FDSDtBQUVEOztHQUVHO0FBQ0gsTUFBTSxPQUFPLDZCQUE2QjtJQUN4Qzs7T0FFRztJQUNILFVBQVUsR0FBRyxDQUFDLEVBQ1osQ0FBQyxlQUFlLENBQUMsRUFBRSxZQUFZLEdBQ1YsRUFBeUIsRUFBRTtRQUNoRCxJQUFJLFlBQVksS0FBSyxTQUFTLEVBQUU7WUFDOUIsT0FBTyxFQUFFLENBQUM7U0FDWDtRQUVELE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0lBQ3hELENBQUMsQ0FBQztDQUNIIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ2xpZW50Q29uZmlnQ29udHJpYnV0b3IgfSBmcm9tICcuLi9jbGllbnQtY29uZmlnLXR5cGVzL2NsaWVudF9jb25maWdfY29udHJpYnV0b3IuanMnO1xuaW1wb3J0IHtcbiAgVW5pZmllZEJhY2tlbmRPdXRwdXQsXG4gIGF1dGhPdXRwdXRLZXksXG4gIGN1c3RvbU91dHB1dEtleSxcbiAgZ3JhcGhxbE91dHB1dEtleSxcbiAgc3RvcmFnZU91dHB1dEtleSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXNjaGVtYXMnO1xuaW1wb3J0IHtcbiAgQ2xpZW50Q29uZmlnLFxuICBDbGllbnRDb25maWdWZXJzaW9uT3B0aW9uLFxuICBjbGllbnRDb25maWdUeXBlc1YxLFxufSBmcm9tICcuLi9jbGllbnQtY29uZmlnLXR5cGVzL2NsaWVudF9jb25maWcuanMnO1xuaW1wb3J0IHsgTW9kZWxJbnRyb3NwZWN0aW9uU2NoZW1hQWRhcHRlciB9IGZyb20gJy4uL21vZGVsX2ludHJvc3BlY3Rpb25fc2NoZW1hX2FkYXB0ZXIuanMnO1xuaW1wb3J0IHsgQXdzQXBwc3luY0F1dGhvcml6YXRpb25UeXBlIH0gZnJvbSAnLi4vY2xpZW50LWNvbmZpZy1zY2hlbWEvY2xpZW50X2NvbmZpZ192MS5qcyc7XG5cbi8vIEFsbCBjYXRlZ29yaWVzIGNsaWVudCBjb25maWcgY29udHJpYnV0b3JzIGFyZSBpbmNsdWRlZCBoZXJlIHRvIG1pbGRseSBlbmZvcmNlIHRoZW0gdXNpbmdcbi8vIHRoZSBzYW1lIHNjaGVtYSAodmVyc2lvbiBhbmQgb3RoZXIgdHlwZXMpXG5cbi8qKlxuICogVHJhbnNsYXRvciBmb3IgdGhlIHZlcnNpb24gbnVtYmVyIG9mIENsaWVudENvbmZpZ1xuICovXG5leHBvcnQgY2xhc3MgVmVyc2lvbkNvbnRyaWJ1dG9yIGltcGxlbWVudHMgQ2xpZW50Q29uZmlnQ29udHJpYnV0b3Ige1xuICAvKipcbiAgICogUmV0dXJuIHRoZSB2ZXJzaW9uIG9mIHRoZSBzY2hlbWEgdHlwZXMgdGhhdCB0aGlzIGNvbnRyaWJ1dG9yIHVzZXNcbiAgICovXG4gIGNvbnRyaWJ1dGUgPSAoKTogQ2xpZW50Q29uZmlnID0+IHtcbiAgICByZXR1cm4geyB2ZXJzaW9uOiBDbGllbnRDb25maWdWZXJzaW9uT3B0aW9uLlYxIH07XG4gIH07XG59XG5cbi8qKlxuICogVHJhbnNsYXRvciBmb3IgdGhlIEF1dGggcG9ydGlvbiBvZiBDbGllbnRDb25maWdcbiAqL1xuZXhwb3J0IGNsYXNzIEF1dGhDbGllbnRDb25maWdDb250cmlidXRvciBpbXBsZW1lbnRzIENsaWVudENvbmZpZ0NvbnRyaWJ1dG9yIHtcbiAgLyoqXG4gICAqIEdpdmVuIHNvbWUgQmFja2VuZE91dHB1dCwgY29udHJpYnV0ZSB0aGUgQXV0aCBwb3J0aW9uIG9mIHRoZSBDbGllbnRDb25maWdcbiAgICovXG4gIGNvbnRyaWJ1dGUgPSAoe1xuICAgIFthdXRoT3V0cHV0S2V5XTogYXV0aE91dHB1dCxcbiAgfTogVW5pZmllZEJhY2tlbmRPdXRwdXQpOiBQYXJ0aWFsPENsaWVudENvbmZpZz4gfCBSZWNvcmQ8c3RyaW5nLCBuZXZlcj4gPT4ge1xuICAgIGlmIChhdXRoT3V0cHV0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9XG5cbiAgICBjb25zdCBwYXJzZUFuZEFzc2lnbk9iamVjdCA9IDxUPihcbiAgICAgIG9iajogVCxcbiAgICAgIGtleToga2V5b2YgVCxcbiAgICAgIHZhbHVlOiBzdHJpbmcgfCB1bmRlZmluZWRcbiAgICApID0+IHtcbiAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIG9ialtrZXldID0gSlNPTi5wYXJzZSh2YWx1ZSk7XG4gICAgfTtcblxuICAgIGNvbnN0IGF1dGhDbGllbnRDb25maWc6IFBhcnRpYWw8Y2xpZW50Q29uZmlnVHlwZXNWMS5BV1NBbXBsaWZ5QmFja2VuZE91dHB1dHM+ID1cbiAgICAgIHt9O1xuXG4gICAgYXV0aENsaWVudENvbmZpZy5hdXRoID0ge1xuICAgICAgdXNlcl9wb29sX2lkOiBhdXRoT3V0cHV0LnBheWxvYWQudXNlclBvb2xJZCxcbiAgICAgIGF3c19yZWdpb246IGF1dGhPdXRwdXQucGF5bG9hZC5hdXRoUmVnaW9uLFxuICAgICAgdXNlcl9wb29sX2NsaWVudF9pZDogYXV0aE91dHB1dC5wYXlsb2FkLndlYkNsaWVudElkLFxuICAgIH07XG5cbiAgICBpZiAoYXV0aE91dHB1dC5wYXlsb2FkLmlkZW50aXR5UG9vbElkKSB7XG4gICAgICBhdXRoQ2xpZW50Q29uZmlnLmF1dGguaWRlbnRpdHlfcG9vbF9pZCA9XG4gICAgICAgIGF1dGhPdXRwdXQucGF5bG9hZC5pZGVudGl0eVBvb2xJZDtcbiAgICB9XG5cbiAgICBwYXJzZUFuZEFzc2lnbk9iamVjdChcbiAgICAgIGF1dGhDbGllbnRDb25maWcuYXV0aCxcbiAgICAgICdtZmFfbWV0aG9kcycsXG4gICAgICBhdXRoT3V0cHV0LnBheWxvYWQubWZhVHlwZXNcbiAgICApO1xuXG4gICAgcGFyc2VBbmRBc3NpZ25PYmplY3QoXG4gICAgICBhdXRoQ2xpZW50Q29uZmlnLmF1dGgsXG4gICAgICAnbWZhX21ldGhvZHMnLFxuICAgICAgYXV0aE91dHB1dC5wYXlsb2FkLm1mYVR5cGVzXG4gICAgKTtcblxuICAgIHBhcnNlQW5kQXNzaWduT2JqZWN0KFxuICAgICAgYXV0aENsaWVudENvbmZpZy5hdXRoLFxuICAgICAgJ3N0YW5kYXJkX3JlcXVpcmVkX2F0dHJpYnV0ZXMnLFxuICAgICAgYXV0aE91dHB1dC5wYXlsb2FkLnNpZ251cEF0dHJpYnV0ZXNcbiAgICApO1xuXG4gICAgcGFyc2VBbmRBc3NpZ25PYmplY3QoXG4gICAgICBhdXRoQ2xpZW50Q29uZmlnLmF1dGgsXG4gICAgICAndXNlcm5hbWVfYXR0cmlidXRlcycsXG4gICAgICBhdXRoT3V0cHV0LnBheWxvYWQudXNlcm5hbWVBdHRyaWJ1dGVzXG4gICAgKTtcblxuICAgIHBhcnNlQW5kQXNzaWduT2JqZWN0KFxuICAgICAgYXV0aENsaWVudENvbmZpZy5hdXRoLFxuICAgICAgJ3VzZXJfdmVyaWZpY2F0aW9uX3R5cGVzJyxcbiAgICAgIGF1dGhPdXRwdXQucGF5bG9hZC52ZXJpZmljYXRpb25NZWNoYW5pc21zXG4gICAgKTtcblxuICAgIGlmIChhdXRoT3V0cHV0LnBheWxvYWQubWZhQ29uZmlndXJhdGlvbikge1xuICAgICAgYXV0aENsaWVudENvbmZpZy5hdXRoLm1mYV9jb25maWd1cmF0aW9uID0gYXV0aE91dHB1dC5wYXlsb2FkXG4gICAgICAgIC5tZmFDb25maWd1cmF0aW9uIGFzICdOT05FJyB8ICdPUFRJT05BTCcgfCAnUkVRVUlSRUQnO1xuICAgIH1cblxuICAgIGlmIChcbiAgICAgIGF1dGhPdXRwdXQucGF5bG9hZC5wYXNzd29yZFBvbGljeU1pbkxlbmd0aCB8fFxuICAgICAgYXV0aE91dHB1dC5wYXlsb2FkLnBhc3N3b3JkUG9saWN5UmVxdWlyZW1lbnRzXG4gICAgKSB7XG4gICAgICBhdXRoQ2xpZW50Q29uZmlnLmF1dGgucGFzc3dvcmRfcG9saWN5ID0ge307XG4gICAgICBpZiAoYXV0aE91dHB1dC5wYXlsb2FkLnBhc3N3b3JkUG9saWN5TWluTGVuZ3RoKSB7XG4gICAgICAgIGF1dGhDbGllbnRDb25maWcuYXV0aC5wYXNzd29yZF9wb2xpY3kubWluX2xlbmd0aCA9IE51bWJlci5wYXJzZUludChcbiAgICAgICAgICBhdXRoT3V0cHV0LnBheWxvYWQucGFzc3dvcmRQb2xpY3lNaW5MZW5ndGhcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGlmIChhdXRoT3V0cHV0LnBheWxvYWQucGFzc3dvcmRQb2xpY3lSZXF1aXJlbWVudHMpIHtcbiAgICAgICAgY29uc3QgcmVxdWlyZW1lbnRzID0gSlNPTi5wYXJzZShcbiAgICAgICAgICBhdXRoT3V0cHV0LnBheWxvYWQucGFzc3dvcmRQb2xpY3lSZXF1aXJlbWVudHNcbiAgICAgICAgKSBhcyBzdHJpbmdbXTtcbiAgICAgICAgZm9yIChjb25zdCByZXF1aXJlbWVudCBvZiByZXF1aXJlbWVudHMpIHtcbiAgICAgICAgICBzd2l0Y2ggKHJlcXVpcmVtZW50KSB7XG4gICAgICAgICAgICBjYXNlICdSRVFVSVJFU19OVU1CRVJTJzpcbiAgICAgICAgICAgICAgYXV0aENsaWVudENvbmZpZy5hdXRoLnBhc3N3b3JkX3BvbGljeS5yZXF1aXJlX251bWJlcnMgPSB0cnVlO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ1JFUVVJUkVTX0xPV0VSQ0FTRSc6XG4gICAgICAgICAgICAgIGF1dGhDbGllbnRDb25maWcuYXV0aC5wYXNzd29yZF9wb2xpY3kucmVxdWlyZV9sb3dlcmNhc2UgPSB0cnVlO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ1JFUVVJUkVTX1VQUEVSQ0FTRSc6XG4gICAgICAgICAgICAgIGF1dGhDbGllbnRDb25maWcuYXV0aC5wYXNzd29yZF9wb2xpY3kucmVxdWlyZV91cHBlcmNhc2UgPSB0cnVlO1xuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ1JFUVVJUkVTX1NZTUJPTFMnOlxuICAgICAgICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLmF1dGgucGFzc3dvcmRfcG9saWN5LnJlcXVpcmVfc3ltYm9scyA9IHRydWU7XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIE9BdXRoIHNldHRpbmdzIGFyZSBwcmVzZW50IGlmIGJvdGggb2F1dGhSZWRpcmVjdFNpZ25JbiBhbmQgb2F1dGhSZWRpcmVjdFNpZ25PdXQgYXJlLlxuICAgIGlmIChcbiAgICAgIGF1dGhPdXRwdXQucGF5bG9hZC5vYXV0aFJlZGlyZWN0U2lnbkluICYmXG4gICAgICBhdXRoT3V0cHV0LnBheWxvYWQub2F1dGhSZWRpcmVjdFNpZ25PdXRcbiAgICApIHtcbiAgICAgIGF1dGhDbGllbnRDb25maWcuYXV0aC5vYXV0aCA9IHtcbiAgICAgICAgaWRlbnRpdHlfcHJvdmlkZXJzOiBhdXRoT3V0cHV0LnBheWxvYWQuc29jaWFsUHJvdmlkZXJzXG4gICAgICAgICAgPyBKU09OLnBhcnNlKGF1dGhPdXRwdXQucGF5bG9hZC5zb2NpYWxQcm92aWRlcnMpXG4gICAgICAgICAgOiBbXSxcbiAgICAgICAgcmVkaXJlY3Rfc2lnbl9pbl91cmk6IGF1dGhPdXRwdXQucGF5bG9hZC5vYXV0aFJlZGlyZWN0U2lnbkluLnNwbGl0KCcsJyksXG4gICAgICAgIHJlZGlyZWN0X3NpZ25fb3V0X3VyaTpcbiAgICAgICAgICBhdXRoT3V0cHV0LnBheWxvYWQub2F1dGhSZWRpcmVjdFNpZ25PdXQuc3BsaXQoJywnKSxcbiAgICAgICAgcmVzcG9uc2VfdHlwZTogYXV0aE91dHB1dC5wYXlsb2FkLm9hdXRoUmVzcG9uc2VUeXBlIGFzICdjb2RlJyB8ICd0b2tlbicsXG4gICAgICAgIHNjb3BlczogYXV0aE91dHB1dC5wYXlsb2FkLm9hdXRoU2NvcGVcbiAgICAgICAgICA/IEpTT04ucGFyc2UoYXV0aE91dHB1dC5wYXlsb2FkLm9hdXRoU2NvcGUpXG4gICAgICAgICAgOiBbXSxcbiAgICAgICAgZG9tYWluOiBhdXRoT3V0cHV0LnBheWxvYWQub2F1dGhDb2duaXRvRG9tYWluID8/ICcnLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAoYXV0aE91dHB1dC5wYXlsb2FkLmFsbG93VW5hdXRoZW50aWNhdGVkSWRlbnRpdGllcykge1xuICAgICAgYXV0aENsaWVudENvbmZpZy5hdXRoLnVuYXV0aGVudGljYXRlZF9pZGVudGl0aWVzX2VuYWJsZWQgPVxuICAgICAgICBhdXRoT3V0cHV0LnBheWxvYWQuYWxsb3dVbmF1dGhlbnRpY2F0ZWRJZGVudGl0aWVzID09PSAndHJ1ZSc7XG4gICAgfVxuXG4gICAgcmV0dXJuIGF1dGhDbGllbnRDb25maWc7XG4gIH07XG59XG5cbi8qKlxuICogVHJhbnNsYXRvciBmb3IgdGhlIERhdGEgcG9ydGlvbiBvZiBDbGllbnRDb25maWdcbiAqL1xuZXhwb3J0IGNsYXNzIERhdGFDbGllbnRDb25maWdDb250cmlidXRvciBpbXBsZW1lbnRzIENsaWVudENvbmZpZ0NvbnRyaWJ1dG9yIHtcbiAgLyoqXG4gICAqIENvbnN0cnVjdG9yXG4gICAqIEBwYXJhbSBtb2RlbEludHJvc3BlY3Rpb25TY2hlbWFBZGFwdGVyIHRoZSBhZGFwdGVyIHRvIHByb3ZpZGUgdGhlIG1vZGVsIGludHJvc3BlY3Rpb24gc2NoZW1hIGZyb20gczMgdXJpXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IG1vZGVsSW50cm9zcGVjdGlvblNjaGVtYUFkYXB0ZXI6IE1vZGVsSW50cm9zcGVjdGlvblNjaGVtYUFkYXB0ZXJcbiAgKSB7fVxuXG4gIC8qKlxuICAgKiBHaXZlbiBzb21lIEJhY2tlbmRPdXRwdXQsIGNvbnRyaWJ1dGUgdGhlIEdyYXBocWwgQVBJIHBvcnRpb24gb2YgdGhlIGNsaWVudCBjb25maWdcbiAgICovXG4gIGNvbnRyaWJ1dGUgPSBhc3luYyAoe1xuICAgIFtncmFwaHFsT3V0cHV0S2V5XTogZ3JhcGhxbE91dHB1dCxcbiAgfTogVW5pZmllZEJhY2tlbmRPdXRwdXQpOiBQcm9taXNlPFxuICAgIFBhcnRpYWw8Q2xpZW50Q29uZmlnPiB8IFJlY29yZDxzdHJpbmcsIG5ldmVyPlxuICA+ID0+IHtcbiAgICBpZiAoZ3JhcGhxbE91dHB1dCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4ge307XG4gICAgfVxuICAgIGNvbnN0IGNvbmZpZzogUGFydGlhbDxjbGllbnRDb25maWdUeXBlc1YxLkFXU0FtcGxpZnlCYWNrZW5kT3V0cHV0cz4gPSB7fTtcblxuICAgIGNvbmZpZy5kYXRhID0ge1xuICAgICAgdXJsOiBncmFwaHFsT3V0cHV0LnBheWxvYWQuYXdzQXBwc3luY0FwaUVuZHBvaW50LFxuICAgICAgYXdzX3JlZ2lvbjogZ3JhcGhxbE91dHB1dC5wYXlsb2FkLmF3c0FwcHN5bmNSZWdpb24sXG4gICAgICBhcGlfa2V5OiBncmFwaHFsT3V0cHV0LnBheWxvYWQuYXdzQXBwc3luY0FwaUtleSxcbiAgICAgIGRlZmF1bHRfYXV0aG9yaXphdGlvbl90eXBlOlxuICAgICAgICBncmFwaHFsT3V0cHV0LnBheWxvYWQuYXdzQXBwc3luY0F1dGhlbnRpY2F0aW9uVHlwZSxcbiAgICAgIGF1dGhvcml6YXRpb25fdHlwZXM6XG4gICAgICAgIGdyYXBocWxPdXRwdXQucGF5bG9hZC5hd3NBcHBzeW5jQWRkaXRpb25hbEF1dGhlbnRpY2F0aW9uVHlwZXM/LnNwbGl0KFxuICAgICAgICAgICcsJ1xuICAgICAgICApIGFzIEF3c0FwcHN5bmNBdXRob3JpemF0aW9uVHlwZVtdLFxuICAgIH07XG5cbiAgICBjb25zdCBtb2RlbEludHJvc3BlY3Rpb24gPVxuICAgICAgYXdhaXQgdGhpcy5tb2RlbEludHJvc3BlY3Rpb25TY2hlbWFBZGFwdGVyLmdldE1vZGVsSW50cm9zcGVjdGlvblNjaGVtYUZyb21TM1VyaShcbiAgICAgICAgZ3JhcGhxbE91dHB1dC5wYXlsb2FkLmFtcGxpZnlBcGlNb2RlbFNjaGVtYVMzVXJpXG4gICAgICApO1xuXG4gICAgaWYgKG1vZGVsSW50cm9zcGVjdGlvbikge1xuICAgICAgY29uZmlnLmRhdGEubW9kZWxfaW50cm9zcGVjdGlvbiA9IG1vZGVsSW50cm9zcGVjdGlvbiBhcyB7XG4gICAgICAgIFtrOiBzdHJpbmddOiB1bmtub3duO1xuICAgICAgfTtcbiAgICB9XG5cbiAgICByZXR1cm4gY29uZmlnO1xuICB9O1xufVxuXG4vKipcbiAqIFRyYW5zbGF0b3IgZm9yIHRoZSBTdG9yYWdlIHBvcnRpb24gb2YgQ2xpZW50Q29uZmlnXG4gKi9cbmV4cG9ydCBjbGFzcyBTdG9yYWdlQ2xpZW50Q29uZmlnQ29udHJpYnV0b3IgaW1wbGVtZW50cyBDbGllbnRDb25maWdDb250cmlidXRvciB7XG4gIC8qKlxuICAgKiBHaXZlbiBzb21lIEJhY2tlbmRPdXRwdXQsIGNvbnRyaWJ1dGUgdGhlIFN0b3JhZ2UgcG9ydGlvbiBvZiB0aGUgY2xpZW50IGNvbmZpZ1xuICAgKi9cbiAgY29udHJpYnV0ZSA9ICh7XG4gICAgW3N0b3JhZ2VPdXRwdXRLZXldOiBzdG9yYWdlT3V0cHV0LFxuICB9OiBVbmlmaWVkQmFja2VuZE91dHB1dCk6IFBhcnRpYWw8Q2xpZW50Q29uZmlnPiB8IFJlY29yZDxzdHJpbmcsIG5ldmVyPiA9PiB7XG4gICAgaWYgKHN0b3JhZ2VPdXRwdXQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIHt9O1xuICAgIH1cbiAgICBjb25zdCBjb25maWc6IFBhcnRpYWw8Y2xpZW50Q29uZmlnVHlwZXNWMS5BV1NBbXBsaWZ5QmFja2VuZE91dHB1dHM+ID0ge307XG5cbiAgICBjb25maWcuc3RvcmFnZSA9IHtcbiAgICAgIGF3c19yZWdpb246IHN0b3JhZ2VPdXRwdXQucGF5bG9hZC5zdG9yYWdlUmVnaW9uLFxuICAgICAgYnVja2V0X25hbWU6IHN0b3JhZ2VPdXRwdXQucGF5bG9hZC5idWNrZXROYW1lLFxuICAgIH07XG5cbiAgICByZXR1cm4gY29uZmlnO1xuICB9O1xufVxuXG4vKipcbiAqIFRyYW5zbGF0b3IgZm9yIHRoZSBDdXN0b20gcG9ydGlvbiBvZiBDbGllbnRDb25maWdcbiAqL1xuZXhwb3J0IGNsYXNzIEN1c3RvbUNsaWVudENvbmZpZ0NvbnRyaWJ1dG9yIGltcGxlbWVudHMgQ2xpZW50Q29uZmlnQ29udHJpYnV0b3Ige1xuICAvKipcbiAgICogR2l2ZW4gc29tZSBCYWNrZW5kT3V0cHV0LCBjb250cmlidXRlIHRoZSBDdXN0b20gcG9ydGlvbiBvZiB0aGUgQ2xpZW50Q29uZmlnXG4gICAqL1xuICBjb250cmlidXRlID0gKHtcbiAgICBbY3VzdG9tT3V0cHV0S2V5XTogY3VzdG9tT3V0cHV0LFxuICB9OiBVbmlmaWVkQmFja2VuZE91dHB1dCk6IFBhcnRpYWw8Q2xpZW50Q29uZmlnPiA9PiB7XG4gICAgaWYgKGN1c3RvbU91dHB1dCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4ge307XG4gICAgfVxuXG4gICAgcmV0dXJuIEpTT04ucGFyc2UoY3VzdG9tT3V0cHV0LnBheWxvYWQuY3VzdG9tT3V0cHV0cyk7XG4gIH07XG59XG4iXX0=