import { AmplifyFault } from '@aws-amplify/platform-core';
/**
 * Converts unified client config to the legacy format.
 */
export class ClientConfigLegacyConverter {
    /**
     * Converts client config to a shape consumable by legacy libraries.
     */
    convertToLegacyConfig = (clientConfig) => {
        // We can only convert from V1 of ClientConfig. For everything else, throw
        if (!this.isClientConfigV1(clientConfig)) {
            throw new AmplifyFault('UnsupportedClientConfigVersion', {
                message: 'Only version 1 of ClientConfig is supported.',
            });
        }
        let legacyConfig = {};
        // Gen2 backend constructs use the Stack's region and is identical. We use these to
        // populate the root level aws_project_region in legacy config.
        if (clientConfig.auth || clientConfig.data || clientConfig.storage) {
            legacyConfig.aws_project_region =
                clientConfig.auth?.aws_region ??
                    clientConfig.data?.aws_region ??
                    clientConfig.storage?.aws_region;
        }
        // Auth
        if (clientConfig.auth) {
            const authClientConfig = {
                aws_user_pools_id: clientConfig.auth.user_pool_id,
                aws_cognito_region: clientConfig.auth.aws_region,
                aws_user_pools_web_client_id: clientConfig.auth.user_pool_client_id,
                aws_cognito_identity_pool_id: clientConfig.auth.identity_pool_id,
            };
            if (clientConfig.auth.unauthenticated_identities_enabled) {
                authClientConfig.allowUnauthenticatedIdentities = clientConfig.auth
                    .unauthenticated_identities_enabled
                    ? 'true'
                    : 'false';
            }
            if (clientConfig.auth.mfa_methods) {
                authClientConfig.aws_cognito_mfa_types = clientConfig.auth.mfa_methods;
            }
            if (clientConfig.auth.mfa_configuration) {
                authClientConfig.aws_cognito_mfa_configuration =
                    clientConfig.auth.mfa_configuration;
            }
            if (clientConfig.auth.standard_required_attributes) {
                authClientConfig.aws_cognito_signup_attributes =
                    clientConfig.auth.standard_required_attributes?.map((attribute) => attribute.toUpperCase());
            }
            if (clientConfig.auth.username_attributes) {
                authClientConfig.aws_cognito_username_attributes =
                    clientConfig.auth.username_attributes?.map((attribute) => attribute.toUpperCase());
            }
            authClientConfig.aws_cognito_verification_mechanisms =
                clientConfig.auth.user_verification_types?.map((attribute) => attribute.toUpperCase());
            if (clientConfig.auth.password_policy) {
                authClientConfig.aws_cognito_password_protection_settings = {};
                if (clientConfig.auth.password_policy.min_length) {
                    authClientConfig.aws_cognito_password_protection_settings = {
                        passwordPolicyMinLength: clientConfig.auth.password_policy.min_length,
                    };
                }
                const requirements = [];
                if (clientConfig.auth.password_policy.require_numbers) {
                    requirements.push('REQUIRES_NUMBERS');
                }
                if (clientConfig.auth.password_policy.require_lowercase) {
                    requirements.push('REQUIRES_LOWERCASE');
                }
                if (clientConfig.auth.password_policy.require_uppercase) {
                    requirements.push('REQUIRES_UPPERCASE');
                }
                if (clientConfig.auth.password_policy.require_symbols) {
                    requirements.push('REQUIRES_SYMBOLS');
                }
                authClientConfig.aws_cognito_password_protection_settings.passwordPolicyCharacters =
                    requirements;
            }
            if (clientConfig.auth.oauth) {
                authClientConfig.oauth = {};
                authClientConfig.aws_cognito_social_providers =
                    clientConfig.auth.oauth.identity_providers;
                authClientConfig.oauth.domain = clientConfig.auth.oauth.domain;
                authClientConfig.oauth.scope = clientConfig.auth.oauth.scopes;
                authClientConfig.oauth.redirectSignIn =
                    clientConfig.auth.oauth.redirect_sign_in_uri.join(',');
                authClientConfig.oauth.redirectSignOut =
                    clientConfig.auth.oauth.redirect_sign_out_uri.join(',');
                authClientConfig.oauth.responseType =
                    clientConfig.auth.oauth.response_type;
            }
            legacyConfig = { ...legacyConfig, ...authClientConfig };
        }
        // Data category
        if (clientConfig.data) {
            const dataConfig = {
                aws_appsync_authenticationType: clientConfig.data.default_authorization_type,
                aws_appsync_region: clientConfig.data.aws_region,
                aws_appsync_graphqlEndpoint: clientConfig.data.url,
                modelIntrospection: clientConfig.data.model_introspection,
            };
            if (clientConfig.data.api_key) {
                dataConfig.aws_appsync_apiKey = clientConfig.data.api_key;
            }
            if (clientConfig.data.authorization_types) {
                dataConfig.aws_appsync_additionalAuthenticationTypes =
                    clientConfig.data.authorization_types.join(',');
            }
            legacyConfig = { ...legacyConfig, ...dataConfig };
        }
        // Storage category
        if (clientConfig.storage) {
            const storageConfig = {
                aws_user_files_s3_bucket: clientConfig.storage.bucket_name,
                aws_user_files_s3_bucket_region: clientConfig.storage.aws_region,
            };
            legacyConfig = { ...legacyConfig, ...storageConfig };
        }
        // Analytics category
        if (clientConfig.analytics && clientConfig.analytics.amazon_pinpoint) {
            const analyticsConfig = {
                Analytics: {
                    Pinpoint: {
                        appId: clientConfig.analytics.amazon_pinpoint.app_id,
                        region: clientConfig.analytics.amazon_pinpoint.aws_region,
                    },
                },
            };
            legacyConfig = { ...legacyConfig, ...analyticsConfig };
            legacyConfig.aws_mobile_analytics_app_id =
                clientConfig.analytics.amazon_pinpoint.app_id;
            legacyConfig.aws_mobile_analytics_app_region =
                clientConfig.analytics.amazon_pinpoint.aws_region;
        }
        // Geo category
        if (clientConfig.geo) {
            const geoConfig = {
                geo: {
                    amazon_location_service: {
                        region: clientConfig.geo.aws_region,
                    },
                },
            };
            if (clientConfig.geo.maps) {
                const mapsLegacyConfig = {};
                for (const mapName in clientConfig.geo.maps.items) {
                    if (clientConfig.geo.maps.items[mapName].style) {
                        mapsLegacyConfig[mapName] = {
                            style: clientConfig.geo.maps.items[mapName].style,
                        };
                    }
                }
                geoConfig.geo.amazon_location_service.maps = {
                    default: clientConfig.geo.maps.default,
                    items: mapsLegacyConfig,
                };
            }
            if (clientConfig.geo.search_indices) {
                geoConfig.geo.amazon_location_service.search_indices =
                    clientConfig.geo.search_indices;
            }
            if (clientConfig.geo.geofence_collections) {
                geoConfig.geo.amazon_location_service.geofenceCollections =
                    clientConfig.geo.geofence_collections;
            }
            legacyConfig = { ...legacyConfig, ...geoConfig };
        }
        // Notifications
        if (clientConfig.notifications) {
            const pinPointConfig = {
                AWSPinpoint: {
                    appId: clientConfig.notifications.amazon_pinpoint_app_id,
                    region: clientConfig.notifications.aws_region,
                },
            };
            const notificationConfig = {};
            notificationConfig.Notifications = {};
            for (const notificationChannel of clientConfig.notifications.channels) {
                switch (notificationChannel) {
                    case 'IN_APP_MESSAGING':
                        notificationConfig.Notifications.InAppMessaging = pinPointConfig;
                        break;
                    case 'FCM':
                        notificationConfig.Notifications.Push = pinPointConfig;
                        break;
                    case 'APNS':
                        // It's fine to overwrite APNS over FCM since they are the exact same config.
                        notificationConfig.Notifications.Push = pinPointConfig;
                        break;
                    case 'EMAIL':
                        notificationConfig.Notifications.EMAIL = pinPointConfig;
                        break;
                    case 'SMS':
                        notificationConfig.Notifications.SMS = pinPointConfig;
                        break;
                }
            }
            legacyConfig = { ...legacyConfig, ...notificationConfig };
        }
        // Custom
        if (clientConfig.custom) {
            legacyConfig.custom = clientConfig.custom;
        }
        return legacyConfig;
    };
    isClientConfigV1 = (clientConfig) => {
        return clientConfig.version === '1';
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50X2NvbmZpZ190b19sZWdhY3lfY29udmVydGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NsaWVudC1jb25maWctd3JpdGVyL2NsaWVudF9jb25maWdfdG9fbGVnYWN5X2NvbnZlcnRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFnQjFEOztHQUVHO0FBQ0gsTUFBTSxPQUFPLDJCQUEyQjtJQUN0Qzs7T0FFRztJQUNILHFCQUFxQixHQUFHLENBQUMsWUFBMEIsRUFBc0IsRUFBRTtRQUN6RSwwRUFBMEU7UUFDMUUsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsRUFBRTtZQUN4QyxNQUFNLElBQUksWUFBWSxDQUFDLGdDQUFnQyxFQUFFO2dCQUN2RCxPQUFPLEVBQUUsOENBQThDO2FBQ3hELENBQUMsQ0FBQztTQUNKO1FBRUQsSUFBSSxZQUFZLEdBQXVCLEVBQUUsQ0FBQztRQUUxQyxtRkFBbUY7UUFDbkYsK0RBQStEO1FBQy9ELElBQUksWUFBWSxDQUFDLElBQUksSUFBSSxZQUFZLENBQUMsSUFBSSxJQUFJLFlBQVksQ0FBQyxPQUFPLEVBQUU7WUFDbEUsWUFBWSxDQUFDLGtCQUFrQjtnQkFDN0IsWUFBWSxDQUFDLElBQUksRUFBRSxVQUFVO29CQUM3QixZQUFZLENBQUMsSUFBSSxFQUFFLFVBQVU7b0JBQzdCLFlBQVksQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDO1NBQ3BDO1FBRUQsT0FBTztRQUNQLElBQUksWUFBWSxDQUFDLElBQUksRUFBRTtZQUNyQixNQUFNLGdCQUFnQixHQUFxQjtnQkFDekMsaUJBQWlCLEVBQUUsWUFBWSxDQUFDLElBQUksQ0FBQyxZQUFZO2dCQUNqRCxrQkFBa0IsRUFBRSxZQUFZLENBQUMsSUFBSSxDQUFDLFVBQVU7Z0JBQ2hELDRCQUE0QixFQUFFLFlBQVksQ0FBQyxJQUFJ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WSxDQUFDLE1BQU0sRUFBRTtZQUN2QixZQUFZLENBQUMsTUFBTSxHQUFHLFlBQVksQ0FBQyxNQUFNLENBQUM7U0FDM0M7UUFFRCxPQUFPLFlBQVksQ0FBQztJQUN0QixDQUFDLENBQUM7SUFFRixnQkFBZ0IsR0FBRyxDQUNqQixZQUEwQixFQUNvQyxFQUFFO1FBQ2hFLE9BQU8sWUFBWSxDQUFDLE9BQU8sS0FBSyxHQUFHLENBQUM7SUFDdEMsQ0FBQyxDQUFDO0NBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBbXBsaWZ5RmF1bHQgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5pbXBvcnQge1xuICBDbGllbnRDb25maWcsXG4gIENsaWVudENvbmZpZ0xlZ2FjeSxcbiAgY2xpZW50Q29uZmlnVHlwZXNWMSxcbn0gZnJvbSAnLi4vY2xpZW50LWNvbmZpZy10eXBlcy9jbGllbnRfY29uZmlnLmpzJztcblxuaW1wb3J0IHtcbiAgQW5hbHl0aWNzQ2xpZW50Q29uZmlnLFxuICBBdXRoQ2xpZW50Q29uZmlnLFxuICBHZW9DbGllbnRDb25maWcsXG4gIEdyYXBocWxDbGllbnRDb25maWcsXG4gIE5vdGlmaWNhdGlvbnNDbGllbnRDb25maWcsXG4gIFN0b3JhZ2VDbGllbnRDb25maWcsXG59IGZyb20gJy4uL2luZGV4LmpzJztcblxuLyoqXG4gKiBDb252ZXJ0cyB1bmlmaWVkIGNsaWVudCBjb25maWcgdG8gdGhlIGxlZ2FjeSBmb3JtYXQuXG4gKi9cbmV4cG9ydCBjbGFzcyBDbGllbnRDb25maWdMZWdhY3lDb252ZXJ0ZXIge1xuICAvKipcbiAgICogQ29udmVydHMgY2xpZW50IGNvbmZpZyB0byBhIHNoYXBlIGNvbnN1bWFibGUgYnkgbGVnYWN5IGxpYnJhcmllcy5cbiAgICovXG4gIGNvbnZlcnRUb0xlZ2FjeUNvbmZpZyA9IChjbGllbnRDb25maWc6IENsaWVudENvbmZpZyk6IENsaWVudENvbmZpZ0xlZ2FjeSA9PiB7XG4gICAgLy8gV2UgY2FuIG9ubHkgY29udmVydCBmcm9tIFYxIG9mIENsaWVudENvbmZpZy4gRm9yIGV2ZXJ5dGhpbmcgZWxzZSwgdGhyb3dcbiAgICBpZiAoIXRoaXMuaXNDbGllbnRDb25maWdWMShjbGllbnRDb25maWcpKSB7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeUZhdWx0KCdVbnN1cHBvcnRlZENsaWVudENvbmZpZ1ZlcnNpb24nLCB7XG4gICAgICAgIG1lc3NhZ2U6ICdPbmx5IHZlcnNpb24gMSBvZiBDbGllbnRDb25maWcgaXMgc3VwcG9ydGVkLicsXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBsZXQgbGVnYWN5Q29uZmlnOiBDbGllbnRDb25maWdMZWdhY3kgPSB7fTtcblxuICAgIC8vIEdlbjIgYmFja2VuZCBjb25zdHJ1Y3RzIHVzZSB0aGUgU3RhY2sncyByZWdpb24gYW5kIGlzIGlkZW50aWNhbC4gV2UgdXNlIHRoZXNlIHRvXG4gICAgLy8gcG9wdWxhdGUgdGhlIHJvb3QgbGV2ZWwgYXdzX3Byb2plY3RfcmVnaW9uIGluIGxlZ2FjeSBjb25maWcuXG4gICAgaWYgKGNsaWVudENvbmZpZy5hdXRoIHx8IGNsaWVudENvbmZpZy5kYXRhIHx8IGNsaWVudENvbmZpZy5zdG9yYWdlKSB7XG4gICAgICBsZWdhY3lDb25maWcuYXdzX3Byb2plY3RfcmVnaW9uID1cbiAgICAgICAgY2xpZW50Q29uZmlnLmF1dGg/LmF3c19yZWdpb24gPz9cbiAgICAgICAgY2xpZW50Q29uZmlnLmRhdGE/LmF3c19yZWdpb24gPz9cbiAgICAgICAgY2xpZW50Q29uZmlnLnN0b3JhZ2U/LmF3c19yZWdpb247XG4gICAgfVxuXG4gICAgLy8gQXV0aFxuICAgIGlmIChjbGllbnRDb25maWcuYXV0aCkge1xuICAgICAgY29uc3QgYXV0aENsaWVudENvbmZpZzogQXV0aENsaWVudENvbmZpZyA9IHtcbiAgICAgICAgYXdzX3VzZXJfcG9vbHNfaWQ6IGNsaWVudENvbmZpZy5hdXRoLnVzZXJfcG9vbF9pZCxcbiAgICAgICAgYXdzX2NvZ25pdG9fcmVnaW9uOiBjbGllbnRDb25maWcuYXV0aC5hd3NfcmVnaW9uLFxuICAgICAgICBhd3NfdXNlcl9wb29sc193ZWJfY2xpZW50X2lkOiBjbGllbnRDb25maWcuYXV0aC51c2VyX3Bvb2xfY2xpZW50X2lkLFxuICAgICAgICBhd3NfY29nbml0b19pZGVudGl0eV9wb29sX2lkOiBjbGllbnRDb25maWcuYXV0aC5pZGVudGl0eV9wb29sX2lkLFxuICAgICAgfTtcblxuICAgICAgaWYgKGNsaWVudENvbmZpZy5hdXRoLnVuYXV0aGVudGljYXRlZF9pZGVudGl0aWVzX2VuYWJsZWQpIHtcbiAgICAgICAgYXV0aENsaWVudENvbmZpZy5hbGxvd1VuYXV0aGVudGljYXRlZElkZW50aXRpZXMgPSBjbGllbnRDb25maWcuYXV0aFxuICAgICAgICAgIC51bmF1dGhlbnRpY2F0ZWRfaWRlbnRpdGllc19lbmFibGVkXG4gICAgICAgICAgPyAndHJ1ZSdcbiAgICAgICAgICA6ICdmYWxzZSc7XG4gICAgICB9XG5cbiAgICAgIGlmIChjbGllbnRDb25maWcuYXV0aC5tZmFfbWV0aG9kcykge1xuICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLmF3c19jb2duaXRvX21mYV90eXBlcyA9IGNsaWVudENvbmZpZy5hdXRoLm1mYV9tZXRob2RzO1xuICAgICAgfVxuXG4gICAgICBpZiAoY2xpZW50Q29uZmlnLmF1dGgubWZhX2NvbmZpZ3VyYXRpb24pIHtcbiAgICAgICAgYXV0aENsaWVudENvbmZpZy5hd3NfY29nbml0b19tZmFfY29uZmlndXJhdGlvbiA9XG4gICAgICAgICAgY2xpZW50Q29uZmlnLmF1dGgubWZhX2NvbmZpZ3VyYXRpb247XG4gICAgICB9XG5cbiAgICAgIGlmIChjbGllbnRDb25maWcuYXV0aC5zdGFuZGFyZF9yZXF1aXJlZF9hdHRyaWJ1dGVzKSB7XG4gICAgICAgIGF1dGhDbGllbnRDb25maWcuYXdzX2NvZ25pdG9fc2lnbnVwX2F0dHJpYnV0ZXMgPVxuICAgICAgICAgIGNsaWVudENvbmZpZy5hdXRoLnN0YW5kYXJkX3JlcXVpcmVkX2F0dHJpYnV0ZXM/Lm1hcCgoYXR0cmlidXRlKSA9PlxuICAgICAgICAgICAgYXR0cmlidXRlLnRvVXBwZXJDYXNlKClcbiAgICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBpZiAoY2xpZW50Q29uZmlnLmF1dGgudXNlcm5hbWVfYXR0cmlidXRlcykge1xuICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLmF3c19jb2duaXRvX3VzZXJuYW1lX2F0dHJpYnV0ZXMgPVxuICAgICAgICAgIGNsaWVudENvbmZpZy5hdXRoLnVzZXJuYW1lX2F0dHJpYnV0ZXM/Lm1hcCgoYXR0cmlidXRlKSA9PlxuICAgICAgICAgICAgYXR0cmlidXRlLnRvVXBwZXJDYXNlKClcbiAgICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBhdXRoQ2xpZW50Q29uZmlnLmF3c19jb2duaXRvX3ZlcmlmaWNhdGlvbl9tZWNoYW5pc21zID1cbiAgICAgICAgY2xpZW50Q29uZmlnLmF1dGgudXNlcl92ZXJpZmljYXRpb25fdHlwZXM/Lm1hcCgoYXR0cmlidXRlKSA9PlxuICAgICAgICAgIGF0dHJpYnV0ZS50b1VwcGVyQ2FzZSgpXG4gICAgICAgICk7XG5cbiAgICAgIGlmIChjbGllbnRDb25maWcuYXV0aC5wYXNzd29yZF9wb2xpY3kpIHtcbiAgICAgICAgYXV0aENsaWVudENvbmZpZy5hd3NfY29nbml0b19wYXNzd29yZF9wcm90ZWN0aW9uX3NldHRpbmdzID0ge307XG4gICAgICAgIGlmIChjbGllbnRDb25maWcuYXV0aC5wYXNzd29yZF9wb2xpY3kubWluX2xlbmd0aCkge1xuICAgICAgICAgIGF1dGhDbGllbnRDb25maWcuYXdzX2NvZ25pdG9fcGFzc3dvcmRfcHJvdGVjdGlvbl9zZXR0aW5ncyA9IHtcbiAgICAgICAgICAgIHBhc3N3b3JkUG9saWN5TWluTGVuZ3RoOlxuICAgICAgICAgICAgICBjbGllbnRDb25maWcuYXV0aC5wYXNzd29yZF9wb2xpY3kubWluX2xlbmd0aCxcbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHJlcXVpcmVtZW50cyA9IFtdO1xuICAgICAgICBpZiAoY2xpZW50Q29uZmlnLmF1dGgucGFzc3dvcmRfcG9saWN5LnJlcXVpcmVfbnVtYmVycykge1xuICAgICAgICAgIHJlcXVpcmVtZW50cy5wdXNoKCdSRVFVSVJFU19OVU1CRVJTJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGNsaWVudENvbmZpZy5hdXRoLnBhc3N3b3JkX3BvbGljeS5yZXF1aXJlX2xvd2VyY2FzZSkge1xuICAgICAgICAgIHJlcXVpcmVtZW50cy5wdXNoKCdSRVFVSVJFU19MT1dFUkNBU0UnKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoY2xpZW50Q29uZmlnLmF1dGgucGFzc3dvcmRfcG9saWN5LnJlcXVpcmVfdXBwZXJjYXNlKSB7XG4gICAgICAgICAgcmVxdWlyZW1lbnRzLnB1c2goJ1JFUVVJUkVTX1VQUEVSQ0FTRScpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjbGllbnRDb25maWcuYXV0aC5wYXNzd29yZF9wb2xpY3kucmVxdWlyZV9zeW1ib2xzKSB7XG4gICAgICAgICAgcmVxdWlyZW1lbnRzLnB1c2goJ1JFUVVJUkVTX1NZTUJPTFMnKTtcbiAgICAgICAgfVxuICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLmF3c19jb2duaXRvX3Bhc3N3b3JkX3Byb3RlY3Rpb25fc2V0dGluZ3MucGFzc3dvcmRQb2xpY3lDaGFyYWN0ZXJzID1cbiAgICAgICAgICByZXF1aXJlbWVudHM7XG4gICAgICB9XG5cbiAgICAgIGlmIChjbGllbnRDb25maWcuYXV0aC5vYXV0aCkge1xuICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLm9hdXRoID0ge307XG4gICAgICAgIGF1dGhDbGllbnRDb25maWcuYXdzX2NvZ25pdG9fc29jaWFsX3Byb3ZpZGVycyA9XG4gICAgICAgICAgY2xpZW50Q29uZmlnLmF1dGgub2F1dGguaWRlbnRpdHlfcHJvdmlkZXJzO1xuICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLm9hdXRoLmRvbWFpbiA9IGNsaWVudENvbmZpZy5hdXRoLm9hdXRoLmRvbWFpbjtcbiAgICAgICAgYXV0aENsaWVudENvbmZpZy5vYXV0aC5zY29wZSA9IGNsaWVudENvbmZpZy5hdXRoLm9hdXRoLnNjb3BlcztcbiAgICAgICAgYXV0aENsaWVudENvbmZpZy5vYXV0aC5yZWRpcmVjdFNpZ25JbiA9XG4gICAgICAgICAgY2xpZW50Q29uZmlnLmF1dGgub2F1dGgucmVkaXJlY3Rfc2lnbl9pbl91cmkuam9pbignLCcpO1xuICAgICAgICBhdXRoQ2xpZW50Q29uZmlnLm9hdXRoLnJlZGlyZWN0U2lnbk91dCA9XG4gICAgICAgICAgY2xpZW50Q29uZmlnLmF1dGgub2F1dGgucmVkaXJlY3Rfc2lnbl9vdXRfdXJpLmpvaW4oJywnKTtcbiAgICAgICAgYXV0aENsaWVudENvbmZpZy5vYXV0aC5yZXNwb25zZVR5cGUgPVxuICAgICAgICAgIGNsaWVudENvbmZpZy5hdXRoLm9hdXRoLnJlc3BvbnNlX3R5cGU7XG4gICAgICB9XG5cbiAgICAgIGxlZ2FjeUNvbmZpZyA9IHsgLi4ubGVnYWN5Q29uZmlnLCAuLi5hdXRoQ2xpZW50Q29uZmlnIH07XG4gICAgfVxuXG4gICAgLy8gRGF0YSBjYXRlZ29yeVxuICAgIGlmIChjbGllbnRDb25maWcuZGF0YSkge1xuICAgICAgY29uc3QgZGF0YUNvbmZpZzogR3JhcGhxbENsaWVudENvbmZpZyA9IHtcbiAgICAgICAgYXdzX2FwcHN5bmNfYXV0aGVudGljYXRpb25UeXBlOlxuICAgICAgICAgIGNsaWVudENvbmZpZy5kYXRhLmRlZmF1bHRfYXV0aG9yaXphdGlvbl90eXBlLFxuICAgICAgICBhd3NfYXBwc3luY19yZWdpb246IGNsaWVudENvbmZpZy5kYXRhLmF3c19yZWdpb24sXG4gICAgICAgIGF3c19hcHBzeW5jX2dyYXBocWxFbmRwb2ludDogY2xpZW50Q29uZmlnLmRhdGEudXJsLFxuICAgICAgICBtb2RlbEludHJvc3BlY3Rpb246IGNsaWVudENvbmZpZy5kYXRhLm1vZGVsX2ludHJvc3BlY3Rpb24sXG4gICAgICB9O1xuXG4gICAgICBpZiAoY2xpZW50Q29uZmlnLmRhdGEuYXBpX2tleSkge1xuICAgICAgICBkYXRhQ29uZmlnLmF3c19hcHBzeW5jX2FwaUtleSA9IGNsaWVudENvbmZpZy5kYXRhLmFwaV9rZXk7XG4gICAgICB9XG5cbiAgICAgIGlmIChjbGllbnRDb25maWcuZGF0YS5hdXRob3JpemF0aW9uX3R5cGVzKSB7XG4gICAgICAgIGRhdGFDb25maWcuYXdzX2FwcHN5bmNfYWRkaXRpb25hbEF1dGhlbnRpY2F0aW9uVHlwZXMgPVxuICAgICAgICAgIGNsaWVudENvbmZpZy5kYXRhLmF1dGhvcml6YXRpb25fdHlwZXMuam9pbignLCcpO1xuICAgICAgfVxuXG4gICAgICBsZWdhY3lDb25maWcgPSB7IC4uLmxlZ2FjeUNvbmZpZywgLi4uZGF0YUNvbmZpZyB9O1xuICAgIH1cblxuICAgIC8vIFN0b3JhZ2UgY2F0ZWdvcnlcbiAgICBpZiAoY2xpZW50Q29uZmlnLnN0b3JhZ2UpIHtcbiAgICAgIGNvbnN0IHN0b3JhZ2VDb25maWc6IFN0b3JhZ2VDbGllbnRDb25maWcgPSB7XG4gICAgICAgIGF3c191c2VyX2ZpbGVzX3MzX2J1Y2tldDogY2xpZW50Q29uZmlnLnN0b3JhZ2UuYnVja2V0X25hbWUsXG4gICAgICAgIGF3c191c2VyX2ZpbGVzX3MzX2J1Y2tldF9yZWdpb246IGNsaWVudENvbmZpZy5zdG9yYWdlLmF3c19yZWdpb24sXG4gICAgICB9O1xuICAgICAgbGVnYWN5Q29uZmlnID0geyAuLi5sZWdhY3lDb25maWcsIC4uLnN0b3JhZ2VDb25maWcgfTtcbiAgICB9XG5cbiAgICAvLyBBbmFseXRpY3MgY2F0ZWdvcnlcbiAgICBpZiAoY2xpZW50Q29uZmlnLmFuYWx5dGljcyAmJiBjbGllbnRDb25maWcuYW5hbHl0aWNzLmFtYXpvbl9waW5wb2ludCkge1xuICAgICAgY29uc3QgYW5hbHl0aWNzQ29uZmlnOiBBbmFseXRpY3NDbGllbnRDb25maWcgPSB7XG4gICAgICAgIEFuYWx5dGljczoge1xuICAgICAgICAgIFBpbnBvaW50OiB7XG4gICAgICAgICAgICBhcHBJZDogY2xpZW50Q29uZmlnLmFuYWx5dGljcy5hbWF6b25fcGlucG9pbnQuYXBwX2lkLFxuICAgICAgICAgICAgcmVnaW9uOiBjbGllbnRDb25maWcuYW5hbHl0aWNzLmFtYXpvbl9waW5wb2ludC5hd3NfcmVnaW9uLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICB9O1xuICAgICAgbGVnYWN5Q29uZmlnID0geyAuLi5sZWdhY3lDb25maWcsIC4uLmFuYWx5dGljc0NvbmZpZyB9O1xuICAgICAgbGVnYWN5Q29uZmlnLmF3c19tb2JpbGVfYW5hbHl0aWNzX2FwcF9pZCA9XG4gICAgICAgIGNsaWVudENvbmZpZy5hbmFseXRpY3MuYW1hem9uX3BpbnBvaW50LmFwcF9pZDtcbiAgICAgIGxlZ2FjeUNvbmZpZy5hd3NfbW9iaWxlX2FuYWx5dGljc19hcHBfcmVnaW9uID1cbiAgICAgICAgY2xpZW50Q29uZmlnLmFuYWx5dGljcy5hbWF6b25fcGlucG9pbnQuYXdzX3JlZ2lvbjtcbiAgICB9XG5cbiAgICAvLyBHZW8gY2F0ZWdvcnlcbiAgICBpZiAoY2xpZW50Q29uZmlnLmdlbykge1xuICAgICAgY29uc3QgZ2VvQ29uZmlnOiBHZW9DbGllbnRDb25maWcgPSB7XG4gICAgICAgIGdlbzoge1xuICAgICAgICAgIGFtYXpvbl9sb2NhdGlvbl9zZXJ2aWNlOiB7XG4gICAgICAgICAgICByZWdpb246IGNsaWVudENvbmZpZy5nZW8uYXdzX3JlZ2lvbixcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfTtcblxuICAgICAgaWYgKGNsaWVudENvbmZpZy5nZW8ubWFwcykge1xuICAgICAgICBjb25zdCBtYXBzTGVnYWN5Q29uZmlnOiBSZWNvcmQ8c3RyaW5nLCB7IHN0eWxlOiBzdHJpbmcgfT4gPSB7fTtcbiAgICAgICAgZm9yIChjb25zdCBtYXBOYW1lIGluIGNsaWVudENvbmZpZy5nZW8ubWFwcy5pdGVtcykge1xuICAgICAgICAgIGlmIChjbGllbnRDb25maWcuZ2VvLm1hcHMuaXRlbXNbbWFwTmFtZV0uc3R5bGUpIHtcbiAgICAgICAgICAgIG1hcHNMZWdhY3lDb25maWdbbWFwTmFtZV0gPSB7XG4gICAgICAgICAgICAgIHN0eWxlOiBjbGllbnRDb25maWcuZ2VvLm1hcHMuaXRlbXNbbWFwTmFtZV0uc3R5bGUhLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZ2VvQ29uZmlnLmdlbyEuYW1hem9uX2xvY2F0aW9uX3NlcnZpY2UubWFwcyA9IHtcbiAgICAgICAgICBkZWZhdWx0OiBjbGllbnRDb25maWcuZ2VvLm1hcHMuZGVmYXVsdCxcbiAgICAgICAgICBpdGVtczogbWFwc0xlZ2FjeUNvbmZpZyxcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgaWYgKGNsaWVudENvbmZpZy5nZW8uc2VhcmNoX2luZGljZXMpIHtcbiAgICAgICAgZ2VvQ29uZmlnLmdlbyEuYW1hem9uX2xvY2F0aW9uX3NlcnZpY2Uuc2VhcmNoX2luZGljZXMgPVxuICAgICAgICAgIGNsaWVudENvbmZpZy5nZW8uc2VhcmNoX2luZGljZXM7XG4gICAgICB9XG5cbiAgICAgIGlmIChjbGllbnRDb25maWcuZ2VvLmdlb2ZlbmNlX2NvbGxlY3Rpb25zKSB7XG4gICAgICAgIGdlb0NvbmZpZy5nZW8hLmFtYXpvbl9sb2NhdGlvbl9zZXJ2aWNlLmdlb2ZlbmNlQ29sbGVjdGlvbnMgPVxuICAgICAgICAgIGNsaWVudENvbmZpZy5nZW8uZ2VvZmVuY2VfY29sbGVjdGlvbnM7XG4gICAgICB9XG5cbiAgICAgIGxlZ2FjeUNvbmZpZyA9IHsgLi4ubGVnYWN5Q29uZmlnLCAuLi5nZW9Db25maWcgfTtcbiAgICB9XG5cbiAgICAvLyBOb3RpZmljYXRpb25zXG4gICAgaWYgKGNsaWVudENvbmZpZy5ub3RpZmljYXRpb25zKSB7XG4gICAgICBjb25zdCBwaW5Qb2ludENvbmZpZyA9IHtcbiAgICAgICAgQVdTUGlucG9pbnQ6IHtcbiAgICAgICAgICBhcHBJZDogY2xpZW50Q29uZmlnLm5vdGlmaWNhdGlvbnMuYW1hem9uX3BpbnBvaW50X2FwcF9pZCxcbiAgICAgICAgICByZWdpb246IGNsaWVudENvbmZpZy5ub3RpZmljYXRpb25zLmF3c19yZWdpb24sXG4gICAgICAgIH0sXG4gICAgICB9O1xuICAgICAgY29uc3Qgbm90aWZpY2F0aW9uQ29uZmlnOiBOb3RpZmljYXRpb25zQ2xpZW50Q29uZmlnID0ge307XG4gICAgICBub3RpZmljYXRpb25Db25maWcuTm90aWZpY2F0aW9ucyA9IHt9O1xuICAgICAgZm9yIChjb25zdCBub3RpZmljYXRpb25DaGFubmVsIG9mIGNsaWVudENvbmZpZy5ub3RpZmljYXRpb25zLmNoYW5uZWxzKSB7XG4gICAgICAgIHN3aXRjaCAobm90aWZpY2F0aW9uQ2hhbm5lbCkge1xuICAgICAgICAgIGNhc2UgJ0lOX0FQUF9NRVNTQUdJTkcnOlxuICAgICAgICAgICAgbm90aWZpY2F0aW9uQ29uZmlnLk5vdGlmaWNhdGlvbnMuSW5BcHBNZXNzYWdpbmcgPSBwaW5Qb2ludENvbmZpZztcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIGNhc2UgJ0ZDTSc6XG4gICAgICAgICAgICBub3RpZmljYXRpb25Db25maWcuTm90aWZpY2F0aW9ucy5QdXNoID0gcGluUG9pbnRDb25maWc7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlICdBUE5TJzpcbiAgICAgICAgICAgIC8vIEl0J3MgZmluZSB0byBvdmVyd3JpdGUgQVBOUyBvdmVyIEZDTSBzaW5jZSB0aGV5IGFyZSB0aGUgZXhhY3Qgc2FtZSBjb25maWcuXG4gICAgICAgICAgICBub3RpZmljYXRpb25Db25maWcuTm90aWZpY2F0aW9ucy5QdXNoID0gcGluUG9pbnRDb25maWc7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICBjYXNlICdFTUFJTCc6XG4gICAgICAgICAgICBub3RpZmljYXRpb25Db25maWcuTm90aWZpY2F0aW9ucy5FTUFJTCA9IHBpblBvaW50Q29uZmlnO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgY2FzZSAnU01TJzpcbiAgICAgICAgICAgIG5vdGlmaWNhdGlvbkNvbmZpZy5Ob3RpZmljYXRpb25zLlNNUyA9IHBpblBvaW50Q29uZmlnO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgbGVnYWN5Q29uZmlnID0geyAuLi5sZWdhY3lDb25maWcsIC4uLm5vdGlmaWNhdGlvbkNvbmZpZyB9O1xuICAgIH1cblxuICAgIC8vIEN1c3RvbVxuICAgIGlmIChjbGllbnRDb25maWcuY3VzdG9tKSB7XG4gICAgICBsZWdhY3lDb25maWcuY3VzdG9tID0gY2xpZW50Q29uZmlnLmN1c3RvbTtcbiAgICB9XG5cbiAgICByZXR1cm4gbGVnYWN5Q29uZmlnO1xuICB9O1xuXG4gIGlzQ2xpZW50Q29uZmlnVjEgPSAoXG4gICAgY2xpZW50Q29uZmlnOiBDbGllbnRDb25maWdcbiAgKTogY2xpZW50Q29uZmlnIGlzIGNsaWVudENvbmZpZ1R5cGVzVjEuQVdTQW1wbGlmeUJhY2tlbmRPdXRwdXRzID0+IHtcbiAgICByZXR1cm4gY2xpZW50Q29uZmlnLnZlcnNpb24gPT09ICcxJztcbiAgfTtcbn1cbiJdfQ==