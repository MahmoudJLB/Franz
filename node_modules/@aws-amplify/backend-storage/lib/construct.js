import { Construct } from 'constructs';
import { Bucket, HttpMethods, } from 'aws-cdk-lib/aws-s3';
import { storageOutputKey, } from '@aws-amplify/backend-output-schemas';
import { RemovalPolicy, Stack } from 'aws-cdk-lib';
import { AttributionMetadataStorage, StackMetadataBackendOutputStorageStrategy, } from '@aws-amplify/backend-output-storage';
import { fileURLToPath } from 'url';
import { S3EventSourceV2 } from 'aws-cdk-lib/aws-lambda-event-sources';
// Be very careful editing this value. It is the string that is used to attribute stacks to Amplify Storage in BI metrics
const storageStackType = 'storage-S3';
/**
 * Amplify Storage CDK Construct
 *
 * Currently just a thin wrapper around an S3 bucket
 */
export class AmplifyStorage extends Construct {
    resources;
    /**
     * Create a new AmplifyStorage instance
     */
    constructor(scope, id, props) {
        super(scope, id);
        const bucketProps = {
            versioned: props.versioned || false,
            cors: [
                {
                    maxAge: 3000,
                    exposedHeaders: [
                        'x-amz-server-side-encryption',
                        'x-amz-request-id',
                        'x-amz-id-2',
                        'ETag',
                    ],
                    allowedHeaders: ['*'],
                    allowedOrigins: ['*'],
                    allowedMethods: [
                        HttpMethods.GET,
                        HttpMethods.HEAD,
                        HttpMethods.PUT,
                        HttpMethods.POST,
                        HttpMethods.DELETE,
                    ],
                },
            ],
            autoDeleteObjects: true,
            removalPolicy: RemovalPolicy.DESTROY,
        };
        const bucket = new Bucket(this, 'Bucket', bucketProps);
        this.resources = {
            bucket,
            cfnResources: {
                cfnBucket: bucket.node.findChild('Resource'),
            },
        };
        this.storeOutput(props.outputStorageStrategy);
        new AttributionMetadataStorage().storeAttributionMetadata(Stack.of(this), storageStackType, fileURLToPath(new URL('../package.json', import.meta.url)));
    }
    /**
     * Attach a Lambda function trigger handler to the S3 events
     * @param events - list of S3 events that will trigger the handler
     * @param handler - The function that will handle the event
     */
    addTrigger = (events, handler) => {
        handler.addEventSource(new S3EventSourceV2(this.resources.bucket, { events }));
    };
    /**
     * Store storage outputs using provided strategy
     */
    storeOutput = (outputStorageStrategy = new StackMetadataBackendOutputStorageStrategy(Stack.of(this))) => {
        outputStorageStrategy.addBackendOutputEntry(storageOutputKey, {
            version: '1',
            payload: {
                storageRegion: Stack.of(this).region,
                bucketName: this.resources.bucket.bucketName,
            },
        });
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uc3RydWN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NvbnN0cnVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQ3ZDLE9BQU8sRUFDTCxNQUFNLEVBSU4sV0FBVyxHQUVaLE1BQU0sb0JBQW9CLENBQUM7QUFPNUIsT0FBTyxFQUVMLGdCQUFnQixHQUNqQixNQUFNLHFDQUFxQyxDQUFDO0FBQzdDLE9BQU8sRUFBRSxhQUFhLEVBQUUsS0FBSyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ25ELE9BQU8sRUFDTCwwQkFBMEIsRUFDMUIseUNBQXlDLEdBQzFDLE1BQU0scUNBQXFDLENBQUM7QUFDN0MsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLEtBQUssQ0FBQztBQUVwQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sc0NBQXNDLENBQUM7QUFFdkUseUhBQXlIO0FBQ3pILE1BQU0sZ0JBQWdCLEdBQUcsWUFBWSxDQUFDO0FBMkN0Qzs7OztHQUlHO0FBQ0gsTUFBTSxPQUFPLGNBQ1gsU0FBUSxTQUFTO0lBR1IsU0FBUyxDQUFtQjtJQUNyQzs7T0FFRztJQUNILFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBMEI7UUFDbEUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztRQUVqQixNQUFNLFdBQVcsR0FBZ0I7WUFDL0IsU0FBUyxFQUFFLEtBQUssQ0FBQyxTQUFTLElBQUksS0FBSztZQUNuQyxJQUFJLEVBQUU7Z0JBQ0o7b0JBQ0UsTUFBTSxFQUFFLElBQUk7b0JBQ1osY0FBYyxFQUFFO3dCQUNkLDhCQUE4Qjt3QkFDOUIsa0JBQWtCO3dCQUNsQixZQUFZO3dCQUNaLE1BQU07cUJBQ1A7b0JBQ0QsY0FBYyxFQUFFLENBQUMsR0FBRyxDQUFDO29CQUNyQixjQUFjLEVBQUUsQ0FBQyxHQUFHLENBQUM7b0JBQ3JCLGNBQWMsRUFBRTt3QkFDZCxXQUFXLENBQUMsR0FBRzt3QkFDZixXQUFXLENBQUMsSUFBSTt3QkFDaEIsV0FBVyxDQUFDLEdBQUc7d0JBQ2YsV0FBVyxDQUFDLElBQUk7d0JBQ2hCLFdBQVcsQ0FBQyxNQUFNO3FCQUNuQjtpQkFDRjthQUNGO1lBQ0QsaUJBQWlCLEVBQUUsSUFBSTtZQUN2QixhQUFhLEVBQUUsYUFBYSxDQUFDLE9BQU87U0FDckMsQ0FBQztRQUVGLE1BQU0sTUFBTSxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFFdkQsSUFBSSxDQUFDLFNBQVMsR0FBRztZQUNmLE1BQU07WUFDTixZQUFZLEVBQUU7Z0JBQ1osU0FBUyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBYzthQUMxRDtTQUNGLENBQUM7UUFFRixJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBRTlDLElBQUksMEJBQTBCLEVBQUUsQ0FBQyx3QkFBd0IsQ0FDdkQsS0FBSyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFDZCxnQkFBZ0IsRUFDaEIsYUFBYSxDQUFDLElBQUksR0FBRyxDQUFDLGlCQUFpQixFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FDM0QsQ0FBQztJQUNKLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsVUFBVSxHQUFHLENBQUMsTUFBbUIsRUFBRSxPQUFrQixFQUFRLEVBQUU7UUFDN0QsT0FBTyxDQUFDLGNBQWMsQ0FDcEIsSUFBSSxlQUFlLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUN2RCxDQUFDO0lBQ0osQ0FBQyxDQUFDO0lBRUY7O09BRUc7SUFDSyxXQUFXLEdBQUcsQ0FDcEIsd0JBQXFFLElBQUkseUNBQXlDLENBQ2hILEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQ2YsRUFDSyxFQUFFO1FBQ1IscUJBQXFCLENBQUMscUJBQXFCLENBQUMsZ0JBQWdCLEVBQUU7WUFDNUQsT0FBTyxFQUFFLEdBQUc7WUFDWixPQUFPLEVBQUU7Z0JBQ1AsYUFBYSxFQUFFLEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTTtnQkFDcEMsVUFBVSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFVBQVU7YUFDN0M7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0IHtcbiAgQnVja2V0LFxuICBCdWNrZXRQcm9wcyxcbiAgQ2ZuQnVja2V0LFxuICBFdmVudFR5cGUsXG4gIEh0dHBNZXRob2RzLFxuICBJQnVja2V0LFxufSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtczMnO1xuaW1wb3J0IHtcbiAgQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneSxcbiAgQ29uc3RydWN0RmFjdG9yeSxcbiAgRnVuY3Rpb25SZXNvdXJjZXMsXG4gIFJlc291cmNlUHJvdmlkZXIsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbHVnaW4tdHlwZXMnO1xuaW1wb3J0IHtcbiAgU3RvcmFnZU91dHB1dCxcbiAgc3RvcmFnZU91dHB1dEtleSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L2JhY2tlbmQtb3V0cHV0LXNjaGVtYXMnO1xuaW1wb3J0IHsgUmVtb3ZhbFBvbGljeSwgU3RhY2sgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQge1xuICBBdHRyaWJ1dGlvbk1ldGFkYXRhU3RvcmFnZSxcbiAgU3RhY2tNZXRhZGF0YUJhY2tlbmRPdXRwdXRTdG9yYWdlU3RyYXRlZ3ksXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLW91dHB1dC1zdG9yYWdlJztcbmltcG9ydCB7IGZpbGVVUkxUb1BhdGggfSBmcm9tICd1cmwnO1xuaW1wb3J0IHsgSUZ1bmN0aW9uIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBTM0V2ZW50U291cmNlVjIgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhLWV2ZW50LXNvdXJjZXMnO1xuXG4vLyBCZSB2ZXJ5IGNhcmVmdWwgZWRpdGluZyB0aGlzIHZhbHVlLiBJdCBpcyB0aGUgc3RyaW5nIHRoYXQgaXMgdXNlZCB0byBhdHRyaWJ1dGUgc3RhY2tzIHRvIEFtcGxpZnkgU3RvcmFnZSBpbiBCSSBtZXRyaWNzXG5jb25zdCBzdG9yYWdlU3RhY2tUeXBlID0gJ3N0b3JhZ2UtUzMnO1xuXG5leHBvcnQgdHlwZSBBbXBsaWZ5U3RvcmFnZVRyaWdnZXJFdmVudCA9ICdvbkRlbGV0ZScgfCAnb25VcGxvYWQnO1xuXG5leHBvcnQgdHlwZSBBbXBsaWZ5U3RvcmFnZVByb3BzID0ge1xuICAvKipcbiAgICogRnJpZW5kbHkgbmFtZSB0aGF0IHdpbGwgYmUgdXNlZCB0byBkZXJpdmUgdGhlIFMzIEJ1Y2tldCBuYW1lXG4gICAqL1xuICBuYW1lOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBXaGV0aGVyIHRvIGVuYWJsZSBTMyBvYmplY3QgdmVyc2lvbmluZyBvbiB0aGUgYnVja2V0LlxuICAgKiBAc2VlIGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9BbWF6b25TMy9sYXRlc3QvdXNlcmd1aWRlL1ZlcnNpb25pbmcuaHRtbFxuICAgKiBAZGVmYXVsdCBmYWxzZVxuICAgKi9cbiAgdmVyc2lvbmVkPzogYm9vbGVhbjtcbiAgb3V0cHV0U3RvcmFnZVN0cmF0ZWd5PzogQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneTxTdG9yYWdlT3V0cHV0PjtcbiAgLyoqXG4gICAqIFMzIGV2ZW50IHRyaWdnZXIgY29uZmlndXJhdGlvblxuICAgKiBAc2VlIGh0dHBzOi8vZG9jcy5hbXBsaWZ5LmF3cy9nZW4yL2J1aWxkLWEtYmFja2VuZC9zdG9yYWdlLyNjb25maWd1cmUtc3RvcmFnZS10cmlnZ2Vyc1xuICAgKiBAZXhhbXBsZVxuICAgKiBpbXBvcnQgeyB0cmlnZ2VySGFuZGxlciB9IGZyb20gJy4uL2Z1bmN0aW9ucy90cmlnZ2VyLWhhbmRsZXIvcmVzb3VyY2UudHMnXG4gICAqXG4gICAqIGV4cG9ydCBjb25zdCBzdG9yYWdlID0gZGVmaW5lU3RvcmFnZSh7XG4gICAqICAgdHJpZ2dlcnM6IHtcbiAgICogICAgIG9uVXBsb2FkOiB0cmlnZ2VySGFuZGxlclxuICAgKiAgIH1cbiAgICogfSlcbiAgICovXG4gIHRyaWdnZXJzPzogUGFydGlhbDxcbiAgICBSZWNvcmQ8XG4gICAgICBBbXBsaWZ5U3RvcmFnZVRyaWdnZXJFdmVudCxcbiAgICAgIENvbnN0cnVjdEZhY3Rvcnk8UmVzb3VyY2VQcm92aWRlcjxGdW5jdGlvblJlc291cmNlcz4+XG4gICAgPlxuICA+O1xufTtcblxuZXhwb3J0IHR5cGUgU3RvcmFnZVJlc291cmNlcyA9IHtcbiAgYnVja2V0OiBJQnVja2V0O1xuICBjZm5SZXNvdXJjZXM6IHtcbiAgICBjZm5CdWNrZXQ6IENmbkJ1Y2tldDtcbiAgfTtcbn07XG5cbi8qKlxuICogQW1wbGlmeSBTdG9yYWdlIENESyBDb25zdHJ1Y3RcbiAqXG4gKiBDdXJyZW50bHkganVzdCBhIHRoaW4gd3JhcHBlciBhcm91bmQgYW4gUzMgYnVja2V0XG4gKi9cbmV4cG9ydCBjbGFzcyBBbXBsaWZ5U3RvcmFnZVxuICBleHRlbmRzIENvbnN0cnVjdFxuICBpbXBsZW1lbnRzIFJlc291cmNlUHJvdmlkZXI8U3RvcmFnZVJlc291cmNlcz5cbntcbiAgcmVhZG9ubHkgcmVzb3VyY2VzOiBTdG9yYWdlUmVzb3VyY2VzO1xuICAvKipcbiAgICogQ3JlYXRlIGEgbmV3IEFtcGxpZnlTdG9yYWdlIGluc3RhbmNlXG4gICAqL1xuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogQW1wbGlmeVN0b3JhZ2VQcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG5cbiAgICBjb25zdCBidWNrZXRQcm9wczogQnVja2V0UHJvcHMgPSB7XG4gICAgICB2ZXJzaW9uZWQ6IHByb3BzLnZlcnNpb25lZCB8fCBmYWxzZSxcbiAgICAgIGNvcnM6IFtcbiAgICAgICAge1xuICAgICAgICAgIG1heEFnZTogMzAwMCxcbiAgICAgICAgICBleHBvc2VkSGVhZGVyczogW1xuICAgICAgICAgICAgJ3gtYW16LXNlcnZlci1zaWRlLWVuY3J5cHRpb24nLFxuICAgICAgICAgICAgJ3gtYW16LXJlcXVlc3QtaWQnLFxuICAgICAgICAgICAgJ3gtYW16LWlkLTInLFxuICAgICAgICAgICAgJ0VUYWcnLFxuICAgICAgICAgIF0sXG4gICAgICAgICAgYWxsb3dlZEhlYWRlcnM6IFsnKiddLFxuICAgICAgICAgIGFsbG93ZWRPcmlnaW5zOiBbJyonXSxcbiAgICAgICAgICBhbGxvd2VkTWV0aG9kczogW1xuICAgICAgICAgICAgSHR0cE1ldGhvZHMuR0VULFxuICAgICAgICAgICAgSHR0cE1ldGhvZHMuSEVBRCxcbiAgICAgICAgICAgIEh0dHBNZXRob2RzLlBVVCxcbiAgICAgICAgICAgIEh0dHBNZXRob2RzLlBPU1QsXG4gICAgICAgICAgICBIdHRwTWV0aG9kcy5ERUxFVEUsXG4gICAgICAgICAgXSxcbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICBhdXRvRGVsZXRlT2JqZWN0czogdHJ1ZSxcbiAgICAgIHJlbW92YWxQb2xpY3k6IFJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICB9O1xuXG4gICAgY29uc3QgYnVja2V0ID0gbmV3IEJ1Y2tldCh0aGlzLCAnQnVja2V0JywgYnVja2V0UHJvcHMpO1xuXG4gICAgdGhpcy5yZXNvdXJjZXMgPSB7XG4gICAgICBidWNrZXQsXG4gICAgICBjZm5SZXNvdXJjZXM6IHtcbiAgICAgICAgY2ZuQnVja2V0OiBidWNrZXQubm9kZS5maW5kQ2hpbGQoJ1Jlc291cmNlJykgYXMgQ2ZuQnVja2V0LFxuICAgICAgfSxcbiAgICB9O1xuXG4gICAgdGhpcy5zdG9yZU91dHB1dChwcm9wcy5vdXRwdXRTdG9yYWdlU3RyYXRlZ3kpO1xuXG4gICAgbmV3IEF0dHJpYnV0aW9uTWV0YWRhdGFTdG9yYWdlKCkuc3RvcmVBdHRyaWJ1dGlvbk1ldGFkYXRhKFxuICAgICAgU3RhY2sub2YodGhpcyksXG4gICAgICBzdG9yYWdlU3RhY2tUeXBlLFxuICAgICAgZmlsZVVSTFRvUGF0aChuZXcgVVJMKCcuLi9wYWNrYWdlLmpzb24nLCBpbXBvcnQubWV0YS51cmwpKVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogQXR0YWNoIGEgTGFtYmRhIGZ1bmN0aW9uIHRyaWdnZXIgaGFuZGxlciB0byB0aGUgUzMgZXZlbnRzXG4gICAqIEBwYXJhbSBldmVudHMgLSBsaXN0IG9mIFMzIGV2ZW50cyB0aGF0IHdpbGwgdHJpZ2dlciB0aGUgaGFuZGxlclxuICAgKiBAcGFyYW0gaGFuZGxlciAtIFRoZSBmdW5jdGlvbiB0aGF0IHdpbGwgaGFuZGxlIHRoZSBldmVudFxuICAgKi9cbiAgYWRkVHJpZ2dlciA9IChldmVudHM6IEV2ZW50VHlwZVtdLCBoYW5kbGVyOiBJRnVuY3Rpb24pOiB2b2lkID0+IHtcbiAgICBoYW5kbGVyLmFkZEV2ZW50U291cmNlKFxuICAgICAgbmV3IFMzRXZlbnRTb3VyY2VWMih0aGlzLnJlc291cmNlcy5idWNrZXQsIHsgZXZlbnRzIH0pXG4gICAgKTtcbiAgfTtcblxuICAvKipcbiAgICogU3RvcmUgc3RvcmFnZSBvdXRwdXRzIHVzaW5nIHByb3ZpZGVkIHN0cmF0ZWd5XG4gICAqL1xuICBwcml2YXRlIHN0b3JlT3V0cHV0ID0gKFxuICAgIG91dHB1dFN0b3JhZ2VTdHJhdGVneTogQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneTxTdG9yYWdlT3V0cHV0PiA9IG5ldyBTdGFja01ldGFkYXRhQmFja2VuZE91dHB1dFN0b3JhZ2VTdHJhdGVneShcbiAgICAgIFN0YWNrLm9mKHRoaXMpXG4gICAgKVxuICApOiB2b2lkID0+IHtcbiAgICBvdXRwdXRTdG9yYWdlU3RyYXRlZ3kuYWRkQmFja2VuZE91dHB1dEVudHJ5KHN0b3JhZ2VPdXRwdXRLZXksIHtcbiAgICAgIHZlcnNpb246ICcxJyxcbiAgICAgIHBheWxvYWQ6IHtcbiAgICAgICAgc3RvcmFnZVJlZ2lvbjogU3RhY2sub2YodGhpcykucmVnaW9uLFxuICAgICAgICBidWNrZXROYW1lOiB0aGlzLnJlc291cmNlcy5idWNrZXQuYnVja2V0TmFtZSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH07XG59XG4iXX0=